name: Daily Upstream Dev Branch Check

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨4ç‚¹ (UTC 20:00 å‰ä¸€å¤©)
    - cron: '0 20 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master

      - name: Add upstream remote & fetch
        run: |
          git remote add upstream https://github.com/anomalyco/opencode.git || true
          git fetch upstream dev
          git fetch origin master

      - name: Generate diff report
        id: diff
        run: |
          TOTAL=$(git rev-list master..upstream/dev --count)
          RECENT=$(git rev-list master..upstream/dev --since='1 day ago' --count)

          # ===== åŸºç¡€ç»Ÿè®¡ =====
          cat > report.md << 'HEADER'
          ## ðŸ” OpenCode Upstream Dev vs Master æ—¥æŠ¥

          HEADER

          echo "| æŒ‡æ ‡ | æ•°å€¼ |" >> report.md
          echo "|------|------|" >> report.md
          echo "| ç´¯è®¡è½åŽ commits | ${TOTAL} |" >> report.md
          echo "| æœ€è¿‘ 24h æ–°å¢ž | ${RECENT} |" >> report.md
          echo "" >> report.md

          # ===== æœ€è¿‘æäº¤åˆ—è¡¨ =====
          if [ "$RECENT" -gt 0 ]; then
            echo "### ðŸ“‹ æœ€è¿‘ 24h æäº¤" >> report.md
            echo '```' >> report.md
            git log master..upstream/dev --oneline --since='1 day ago' >> report.md
            echo '```' >> report.md
            echo "" >> report.md
          fi

          # ===== æ¨¡å—å½±å“åˆ†æž =====
          echo "### ðŸ“¦ æ¨¡å—å½±å“åˆ†æž" >> report.md
          echo "" >> report.md
          echo "| æ¨¡å— | å˜æ›´æ–‡ä»¶æ•° | å…³é”®å˜æ›´ |" >> report.md
          echo "|------|-----------|---------|" >> report.md

          for module in agent provider skill tool server cli/cmd cli/cmd/tui packages/app packages/desktop packages/sdk packages/plugin; do
            COUNT=$(git diff master..upstream/dev --name-only | grep "${module}/" | wc -l)
            if [ "$COUNT" -gt 0 ]; then
              # æå–è¯¥æ¨¡å—ç›¸å…³çš„ commit message ä½œä¸ºå…³é”®å˜æ›´æ‘˜è¦
              CHANGES=$(git log master..upstream/dev --oneline --since='7 days ago' -- "*${module}/*" 2>/dev/null | head -3 | sed 's/^[a-f0-9]* //' | tr '\n' '; ' | sed 's/; $//')
              if [ -z "$CHANGES" ]; then
                CHANGES="(older changes)"
              fi
              echo "| \`${module}\` | ${COUNT} | ${CHANGES} |" >> report.md
            fi
          done
          echo "" >> report.md

          # ===== åŠŸèƒ½å˜æ›´åˆ†æž =====
          echo "### ðŸ”¬ åŠŸèƒ½å˜æ›´åˆ†æž" >> report.md
          echo "" >> report.md

          # æ–°å¢žåŠŸèƒ½
          FEATS=$(git log master..upstream/dev --oneline --since='7 days ago' | grep -iE '^[a-f0-9]+ feat' || true)
          if [ -n "$FEATS" ]; then
            echo "**âœ¨ æ–°å¢žåŠŸèƒ½:**" >> report.md
            echo "$FEATS" | while read -r line; do echo "- \`${line}\`" >> report.md; done
            echo "" >> report.md
          fi

          # Bug ä¿®å¤
          FIXES=$(git log master..upstream/dev --oneline --since='7 days ago' | grep -iE '^[a-f0-9]+ fix' || true)
          if [ -n "$FIXES" ]; then
            echo "**ðŸ› Bug ä¿®å¤:**" >> report.md
            echo "$FIXES" | while read -r line; do echo "- \`${line}\`" >> report.md; done
            echo "" >> report.md
          fi

          # Breaking Changes
          BREAKING=$(git log master..upstream/dev --oneline --since='7 days ago' | grep -iE 'BREAKING|breaking.change' || true)
          if [ -n "$BREAKING" ]; then
            echo "**âš ï¸ Breaking Changes:**" >> report.md
            echo "$BREAKING" | while read -r line; do echo "- \`${line}\`" >> report.md; done
            echo "" >> report.md
          fi

          # é‡æž„ / chore
          REFACTORS=$(git log master..upstream/dev --oneline --since='7 days ago' | grep -iE '^[a-f0-9]+ (refactor|chore)' || true)
          if [ -n "$REFACTORS" ]; then
            echo "**ðŸ”§ é‡æž„/ç»´æŠ¤:**" >> report.md
            echo "$REFACTORS" | while read -r line; do echo "- \`${line}\`" >> report.md; done
            echo "" >> report.md
          fi

          # ===== API / Schema å˜æ›´æ£€æµ‹ =====
          echo "### ðŸ”Œ API & Schema å˜æ›´" >> report.md
          API_CHANGES=$(git diff master..upstream/dev --name-only | grep -iE '(route|api|schema|openapi|migrate)' || true)
          if [ -n "$API_CHANGES" ]; then
            echo '```' >> report.md
            echo "$API_CHANGES" >> report.md
            echo '```' >> report.md
          else
            echo "æ—  API/Schema æ–‡ä»¶å˜æ›´" >> report.md
          fi
          echo "" >> report.md

          # ===== ä¾èµ–å˜æ›´æ£€æµ‹ =====
          echo "### ðŸ“Ž ä¾èµ–å˜æ›´" >> report.md
          PKG_CHANGED=$(git diff master..upstream/dev --name-only | grep -E 'package\.json|bun\.lock' || true)
          if [ -n "$PKG_CHANGED" ]; then
            echo "ä»¥ä¸‹åŒ…ç®¡ç†æ–‡ä»¶æœ‰å˜æ›´ï¼š" >> report.md
            echo '```' >> report.md
            echo "$PKG_CHANGED" >> report.md
            echo '```' >> report.md
          else
            echo "æ— ä¾èµ–å˜æ›´" >> report.md
          fi
          echo "" >> report.md

          # ===== åˆå¹¶å»ºè®® =====
          echo "### ðŸ’¡ åˆå¹¶å»ºè®®" >> report.md
          echo "" >> report.md

          HAS_BREAKING="false"
          if [ -n "$BREAKING" ]; then HAS_BREAKING="true"; fi

          HAS_API="false"
          if [ -n "$API_CHANGES" ]; then HAS_API="true"; fi

          if [ "$TOTAL" -eq 0 ]; then
            echo "âœ… **å·²æ˜¯æœ€æ–°**ï¼Œæ— éœ€æ“ä½œã€‚" >> report.md
          elif [ "$HAS_BREAKING" = "true" ]; then
            echo "âš ï¸ **å­˜åœ¨ Breaking Changes**ï¼Œå»ºè®®ä»”ç»† review åŽå†åˆå¹¶ã€‚éœ€å…³æ³¨å…¼å®¹æ€§å½±å“ã€‚" >> report.md
          elif [ "$HAS_API" = "true" ]; then
            echo "âš¡ **å­˜åœ¨ API/Schema å˜æ›´**ï¼Œå»ºè®®å°½å¿«åˆå¹¶ä»¥é¿å…å†²çªç§¯ç´¯ï¼Œåˆå¹¶åŽéœ€è¿è¡Œ \`./script/generate.ts\` é‡æ–°ç”Ÿæˆ SDKã€‚" >> report.md
          elif [ "$TOTAL" -gt 100 ]; then
            echo "ðŸ”´ **è½åŽè¾ƒå¤š (${TOTAL} commits)**ï¼Œå¼ºçƒˆå»ºè®®å°½å¿«åˆå¹¶ï¼Œå·®è·è¶Šå¤§å†²çªé£Žé™©è¶Šé«˜ã€‚" >> report.md
          elif [ "$TOTAL" -gt 30 ]; then
            echo "ðŸŸ¡ **è½åŽ ${TOTAL} commits**ï¼Œå»ºè®®æœ¬å‘¨å†…å®‰æŽ’åˆå¹¶ã€‚" >> report.md
          elif [ -n "$FIXES" ]; then
            echo "ðŸŸ¢ **åŒ…å« bug fix**ï¼Œå»ºè®®åˆå¹¶ä»¥èŽ·å–ä¿®å¤ã€‚è½åŽ ${TOTAL} commitsã€‚" >> report.md
          else
            echo "ðŸŸ¢ **å˜æ›´è¾ƒå° (${TOTAL} commits)**ï¼Œå¯æ‹©æœºåˆå¹¶ã€‚" >> report.md
          fi

          echo "total=${TOTAL}" >> $GITHUB_OUTPUT
          echo "recent=${RECENT}" >> $GITHUB_OUTPUT

      - name: Build and send Feishu message
        if: ${{ secrets.FEISHU_WEBHOOK_URL != '' }}
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TOTAL: ${{ steps.diff.outputs.total }}
          RECENT: ${{ steps.diff.outputs.recent }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # æœ€è¿‘æäº¤æ‘˜è¦ï¼ˆæœ€å¤š5æ¡ï¼‰
          RECENT_COMMITS=$(git log master..upstream/dev --format='â€¢ %s' --since='1 day ago' | head -5)
          if [ -z "$RECENT_COMMITS" ]; then
            RECENT_COMMITS="æœ€è¿‘ 24h æ— æ–°æäº¤"
          fi

          # åˆå¹¶å»ºè®®ï¼ˆreport.md æœ€åŽä¸€ä¸ªéžç©ºè¡Œï¼‰
          ADVICE=$(grep -v '^$' report.md | tail -1 | sed 's/\*\*//g')

          # ç”¨ jq å®‰å…¨æž„å»º JSONï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦ç ´åç»“æž„
          # å¦‚æžœæ²¡æœ‰ jq åˆ™ç”¨ python
          if command -v jq &>/dev/null; then
            JSON_TOOL="jq"
          elif command -v python3 &>/dev/null; then
            JSON_TOOL="python3"
          else
            JSON_TOOL="none"
          fi

          if [ "$JSON_TOOL" = "python3" ] || [ "$JSON_TOOL" = "none" ]; then
            python3 -c "
          import json, sys, os

          total = os.environ.get('TOTAL', '?')
          recent = os.environ.get('RECENT', '?')
          run_url = os.environ.get('RUN_URL', '')
          commits = '''${RECENT_COMMITS}'''
          advice = '''${ADVICE}'''

          payload = {
              'msg_type': 'interactive',
              'card': {
                  'header': {
                      'title': {'tag': 'plain_text', 'content': 'ðŸ“Š OpenCode Upstream æ—¥æŠ¥'},
                      'template': 'blue'
                  },
                  'elements': [
                      {
                          'tag': 'div',
                          'fields': [
                              {'is_short': True, 'text': {'tag': 'lark_md', 'content': f'**ç´¯è®¡è½åŽ**\n{total} commits'}},
                              {'is_short': True, 'text': {'tag': 'lark_md', 'content': f'**24h æ–°å¢ž**\n{recent} commits'}}
                          ]
                      },
                      {'tag': 'hr'},
                      {'tag': 'div', 'text': {'tag': 'lark_md', 'content': f'**æœ€è¿‘æäº¤ï¼š**\n{commits}'}},
                      {'tag': 'hr'},
                      {'tag': 'div', 'text': {'tag': 'lark_md', 'content': f'**åˆå¹¶å»ºè®®ï¼š** {advice}'}},
                      {
                          'tag': 'action',
                          'actions': [{
                              'tag': 'button',
                              'text': {'tag': 'plain_text', 'content': 'æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š'},
                              'type': 'primary',
                              'url': run_url
                          }]
                      }
                  ]
              }
          }
          with open('feishu_payload.json', 'w') as f:
              json.dump(payload, f, ensure_ascii=False)
          "
          else
            jq -n \
              --arg total "$TOTAL" \
              --arg recent "$RECENT" \
              --arg commits "$RECENT_COMMITS" \
              --arg advice "$ADVICE" \
              --arg run_url "$RUN_URL" \
              '{
                msg_type: "interactive",
                card: {
                  header: {
                    title: {tag: "plain_text", content: "ðŸ“Š OpenCode Upstream æ—¥æŠ¥"},
                    template: "blue"
                  },
                  elements: [
                    {tag: "div", fields: [
                      {is_short: true, text: {tag: "lark_md", content: ("**ç´¯è®¡è½åŽ**\n" + $total + " commits")}},
                      {is_short: true, text: {tag: "lark_md", content: ("**24h æ–°å¢ž**\n" + $recent + " commits")}}
                    ]},
                    {tag: "hr"},
                    {tag: "div", text: {tag: "lark_md", content: ("**æœ€è¿‘æäº¤ï¼š**\n" + $commits)}},
                    {tag: "hr"},
                    {tag: "div", text: {tag: "lark_md", content: ("**åˆå¹¶å»ºè®®ï¼š** " + $advice)}},
                    {tag: "action", actions: [{
                      tag: "button",
                      text: {tag: "plain_text", content: "æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š"},
                      type: "primary",
                      url: $run_url
                    }]}
                  ]
                }
              }' > feishu_payload.json
          fi

          echo "=== Feishu Payload ==="
          cat feishu_payload.json
          echo ""
          echo "=== Sending to Feishu ==="
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "$FEISHU_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @feishu_payload.json)
          echo "$RESPONSE"
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::warning::Feishu notification failed with HTTP $HTTP_CODE"
          fi

      - name: Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: upstream-diff-report-${{ github.run_number }}
          path: report.md
          retention-days: 30

      - name: Print report
        run: cat report.md
