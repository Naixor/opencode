{
  "project": "OpenCode",
  "branchName": "ralph/omo-internalize",
  "description": "Internalize Oh-My-OpenCode (OMO) into OpenCode core - hooks, agents, tools, background system, MCP, config, and upstream tracking",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create hook middleware infrastructure",
      "description": "As a developer, I want a typed middleware chain system for hooks so that all subsequent hook implementations have a consistent, performant, and security-ordered execution framework. Create packages/opencode/src/session/hooks/ directory. Reference OMO source: src/plugin/hooks/, src/create-hooks.ts",
      "acceptanceCriteria": [
        "Create packages/opencode/src/session/hooks/ with middleware chain infrastructure",
        "Define 4 chain types: PreLLMChain, PreToolChain, PostToolChain, SessionLifecycleChain",
        "Each chain enforces execution order: security hooks first, then transform hooks, then output hooks",
        "Each hook has an 'enabled' property read from config; disabled hooks cost one boolean check",
        "Chain is compiled once at session start (no per-call re-evaluation)",
        "Hook registration API: HookChain.register(name, priority, handler) with numeric priority for ordering",
        "Plugin.trigger() compatibility: existing calls preserved, execution order: external plugins first -> internal middleware chain second",
        "Config schema: 'hooks': { 'hook-name': { 'enabled': boolean } } in opencode.jsonc",
        "Unit test: chain execution order respects priority (lower number = earlier)",
        "Unit test: disabled hook is skipped with zero overhead",
        "Unit test: chain compilation caches correctly",
        "Unit test: error in one hook does not crash chain (error isolation with logging)",
        "Unit test: PreLLMChain receives correct system prompt context",
        "Unit test: PreToolChain receives tool name + args",
        "Unit test: PostToolChain receives tool result + can modify it",
        "Unit test: SessionLifecycleChain receives session events",
        "Unit test: config-driven enable/disable toggles hook at runtime reload",
        "Unit test: Plugin.trigger() executes BEFORE internal middleware chain at same hook point",
        "Unit test: plugin can modify data that internal middleware chain then receives",
        "Unit test: internal middleware chain still runs when no plugins registered",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "This is the foundation for all Phase 1 hooks. Insertion points: Pre-LLM at llm.ts:71-101 and llm.ts:122-153, Pre-tool at prompt.ts:716/774, Post-tool at prompt.ts:728/851 -> 862-895, Error recovery at processor.ts:339-364, Session lifecycle via Bus.subscribe"
    },
    {
      "id": "US-002",
      "title": "Internalize error recovery hooks",
      "description": "As a developer, I want automatic error recovery for edit failures, context window overflow, delegate-task retries, and repeated error detection. Reference OMO source: src/hooks/edit-error-recovery/, src/hooks/anthropic-context-window-limit-recovery/, src/hooks/delegate-task-retry/, src/hooks/ralph-loop/",
      "acceptanceCriteria": [
        "edit-error-recovery (PostToolChain, priority 100): on edit 'oldString not found'/'found multiple times'/'oldString and newString must be different', inject recovery reminder",
        "anthropic-context-window-limit-recovery (SessionLifecycleChain, priority 10): on 'context_window_exceeded' error at processor.ts:339, trigger compaction before retry",
        "delegate-task-retry (PostToolChain, priority 200): on delegate_task failure, retry once with exponential backoff (1s, 2s)",
        "iterative-error-recovery (PostToolChain, priority 300): detect repeated identical error patterns (3+ occurrences), inject corrective guidance",
        "Insert new hook point at processor.ts:345 (after SessionRetry.retryable()) for error recovery chain",
        "Each hook individually toggleable via config",
        "Unit test: edit-error-recovery with 'oldString not found' -> recovery message injected",
        "Unit test: edit-error-recovery with 'found multiple times' -> recovery message injected",
        "Unit test: edit-error-recovery with success -> no injection",
        "Unit test: context-window-limit-recovery with 'context_window_exceeded' -> compaction triggered",
        "Unit test: context-window-limit-recovery with non-context error -> no compaction",
        "Unit test: delegate-task-retry with failure -> retry with backoff",
        "Unit test: delegate-task-retry with success -> no retry",
        "Unit test: iterative-error-recovery same error 3 times -> guidance injected",
        "Unit test: iterative-error-recovery same error 2 times -> no guidance",
        "Unit test: disabled hook -> no injection on edit failure",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Depends on US-001 hook infrastructure"
    },
    {
      "id": "US-003",
      "title": "Internalize output management hooks",
      "description": "As a developer, I want automatic tool output truncation, grep result limiting, and context window monitoring built into the core. Reference OMO source: src/hooks/tool-output-truncator/, src/hooks/grep-output-truncator/, src/hooks/context-window-monitor/, src/hooks/preemptive-compaction/",
      "acceptanceCriteria": [
        "tool-output-truncator (PostToolChain, priority 50): truncate ALL tool outputs based on remaining context budget with configurable max size per tool. Integrates at prompt.ts:895. Must preserve [REDACTED: Security Protected] markers",
        "grep-output-truncator (PostToolChain, priority 60): grep-specific truncation with match count reporting ('showing 50 of 342 matches')",
        "question-label-truncator (PostToolChain, priority 70): truncate UI question labels to 200 chars max",
        "context-window-monitor (PreLLMChain, priority 900): calculate current token usage, warn when >80% context consumed, inject warning. Configurable threshold",
        "preemptive-compaction (PreLLMChain, priority 910): when context >90%, trigger compaction BEFORE sending to LLM",
        "Streaming truncation for 10MB+ outputs (read first N bytes + tail message)",
        "Each individually toggleable via config",
        "Unit test: 1MB output -> truncated to budget with '[truncated]' suffix",
        "Unit test: 100 byte output -> no truncation",
        "Unit test: output with [REDACTED: Security Protected] -> markers preserved after truncation",
        "Unit test: grep 500 matches -> truncated with count message",
        "Unit test: grep 10 matches -> no truncation",
        "Unit test: 300 char question label -> truncated to 200 with '...'",
        "Unit test: 85% context usage -> warning injected",
        "Unit test: 50% context usage -> no warning",
        "Unit test: 92% context usage -> compaction triggered",
        "Unit test: 85% context usage -> no compaction",
        "Unit test: 15MB stream -> only first N bytes read + tail message",
        "Unit test: custom threshold 70% -> warning triggers at 70%",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Depends on US-001 hook infrastructure"
    },
    {
      "id": "US-004",
      "title": "Internalize context injection hooks",
      "description": "As a developer, I want automatic injection of AGENTS.md, README.md, custom rules, and compaction context preservation. Reference OMO source: src/hooks/directory-agents-injector/, src/hooks/directory-readme-injector/, src/hooks/rules-injector/, src/hooks/compaction-context-injector/, src/hooks/compaction-todo-preserver/",
      "acceptanceCriteria": [
        "directory-agents-injector (PreLLMChain, priority 100): scan for AGENTS.md in project root and .opencode/, inject into system prompt at llm.ts:71-84",
        "directory-readme-injector (PreLLMChain, priority 110): inject README.md only for first message or when working directory changes",
        "rules-injector (PreLLMChain, priority 120): inject custom rules from .opencode/rules/*.md and .claude/rules/*.md",
        "compaction-context-injector (SessionLifecycleChain, priority 100): at compaction.ts:136, preserve and re-inject critical context during compaction",
        "compaction-todo-preserver (SessionLifecycleChain, priority 110): extract incomplete todos from pre-compaction messages, re-inject post-compaction",
        "All injections: SecurityAccess.checkAccess(filePath, 'read') before reading, checkAccess(filePath, 'llm') before injecting",
        "LLM scanner applied to injected content - redact protected segments",
        "Cache injected content per session (AGENTS.md/README.md don't change mid-session)",
        "Unit test: mock AGENTS.md -> content appears in system prompt",
        "Unit test: no AGENTS.md -> no injection, no error",
        "Unit test: AGENTS.md is security-protected -> access denied, no injection",
        "Unit test: AGENTS.md with protected segment -> segment redacted before injection",
        "Unit test: first message -> README.md injected",
        "Unit test: second message same dir -> no duplicate injection",
        "Unit test: directory change -> new README.md injected",
        "Unit test: rules in .opencode/rules/ -> all rules injected",
        "Unit test: protected rule file -> skipped with security log",
        "Unit test: mock compaction event -> context preserved",
        "Unit test: messages with incomplete todos -> todos extracted and re-injected",
        "Unit test: inject AGENTS.md twice -> file read only once (cache)",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Depends on US-001 hook infrastructure"
    },
    {
      "id": "US-005",
      "title": "Internalize agent detection and checking hooks",
      "description": "As a developer, I want keyword detection, comment checking, empty task response detection, and write-existing-file guard hooks. Reference OMO source: src/hooks/keyword-detector/, src/hooks/comment-checker/, src/hooks/write-existing-file-guard/",
      "acceptanceCriteria": [
        "keyword-detector (PreLLMChain, priority 200): detect mode keywords ([analyze-mode], [review-mode], [ultrawork]/ulw) and set message variant accordingly",
        "comment-checker (PostToolChain, priority 400): after edit/write tool, validate generated code doesn't have >40% comment lines. Configurable threshold",
        "empty-task-response-detector (PostToolChain, priority 350): detect empty/minimal responses from delegate_task, inject 'Task returned empty result, investigate or retry'",
        "write-existing-file-guard (PreToolChain, priority 200): when write tool targets existing file, inject warning 'File exists, prefer edit tool'",
        "Each individually toggleable via config",
        "Unit test: message with '[ultrawork]' -> variant set to 'max'",
        "Unit test: message with '[analyze-mode]' -> mode set",
        "Unit test: normal message -> no variant change",
        "Unit test: edit result with 50% comments -> warning injected",
        "Unit test: edit result with 10% comments -> no warning",
        "Unit test: configurable threshold at 30% -> triggers at 30%",
        "Unit test: delegate_task returns '' -> warning injected",
        "Unit test: delegate_task returns content -> no warning",
        "Unit test: write to existing file -> warning injected",
        "Unit test: write to new file -> no warning",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Depends on US-001. Split from original US-005 (detection/checking hooks)"
    },
    {
      "id": "US-006",
      "title": "Internalize agent enforcement hooks",
      "description": "As a developer, I want todo continuation enforcement, stop continuation guard, and subagent question blocking hooks. Reference OMO source: src/hooks/todo-continuation-enforcer/, src/hooks/subagent-question-blocker/",
      "acceptanceCriteria": [
        "todo-continuation-enforcer (SessionLifecycleChain, priority 200): when agent stops with incomplete todos, inject continuation prompt 'You have N incomplete tasks remaining'",
        "stop-continuation-guard (SessionLifecycleChain, priority 190): detect explicit stop signal from user, prevent todo-continuation-enforcer from triggering",
        "subagent-question-blocker (PreToolChain, priority 100): when agent is subagent, block question tool calls, return 'Proceed autonomously without asking questions'",
        "Each individually toggleable via config",
        "Unit test: agent stops with 3 incomplete todos -> continuation prompt",
        "Unit test: agent stops with all todos complete -> no prompt",
        "Unit test: user sends stop -> continuation blocked",
        "Unit test: subagent calls question tool -> blocked with message",
        "Unit test: primary agent calls question tool -> allowed",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Depends on US-001. Split from original US-005 (enforcement hooks)"
    },
    {
      "id": "US-007",
      "title": "Internalize session lifecycle hooks",
      "description": "As a developer, I want session recovery, notifications, and unstable agent detection. Reference OMO source: src/hooks/session-recovery/, src/hooks/session-notification/, src/hooks/unstable-agent-babysitter/",
      "acceptanceCriteria": [
        "session-recovery (SessionLifecycleChain, priority 10): on session start, check for crashed previous session (status stuck 'busy'), offer to resume with todo continuation",
        "session-notification (SessionLifecycleChain, priority 300): platform-native notifications on task completion: macOS osascript, Linux notify-send. Config: 'notification': { 'enabled': true, 'sound': true }",
        "unstable-agent-babysitter (SessionLifecycleChain, priority 250): count consecutive failures per agent. After 3, inject diagnostic guidance",
        "All hooks via Bus.subscribe for session events",
        "Unit test: mock crashed session (status 'busy') -> resume offered",
        "Unit test: mock clean session -> no recovery prompt",
        "Unit test: macOS -> osascript called",
        "Unit test: Linux -> notify-send called",
        "Unit test: notification disabled -> no notification",
        "Unit test: 3 consecutive failures -> diagnostic guidance injected",
        "Unit test: 2 failures then success -> counter reset, no guidance",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Depends on US-001. Split from original US-006 (session lifecycle hooks)"
    },
    {
      "id": "US-008",
      "title": "Internalize LLM parameter hooks",
      "description": "As a developer, I want think-mode and anthropic-effort hooks that control LLM parameters based on message variant. Reference OMO source: src/hooks/think-mode/, src/hooks/anthropic-effort/",
      "acceptanceCriteria": [
        "think-mode (PreLLMChain, priority 50): set Claude thinking parameter based on task complexity. Variant 'max' -> thinkingBudget: 32000. Variant 'quick' -> disable thinking",
        "anthropic-effort (PreLLMChain, priority 60): set Anthropic effort level. Map: 'max' -> 'high', 'quick' -> 'low', default -> 'medium'",
        "Unit test: variant 'max' -> thinkingBudget=32000",
        "Unit test: variant 'quick' -> thinking disabled",
        "Unit test: no variant -> default behavior unchanged",
        "Unit test: variant 'max' -> effort='high'",
        "Unit test: variant 'quick' -> effort='low'",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Depends on US-001. Split from original US-006 (LLM parameter hooks)"
    },
    {
      "id": "US-009",
      "title": "Internalize Sisyphus agent as default primary agent",
      "description": "As a developer, I want Sisyphus as the default agent that orchestrates task delegation, category-based routing, and multi-step work coordination. Reference OMO source: src/agents/sisyphus.ts, src/agents/dynamic-agent-prompt-builder.ts",
      "acceptanceCriteria": [
        "Create Sisyphus agent in packages/opencode/src/agent/sisyphus.ts following existing Agent.define() pattern",
        "Replace 'build' as default agent. 'build' remains available but Sisyphus selected by default",
        "Agent mode: 'primary' (respects UI-selected model, default claude-opus-4-6)",
        "Dynamic prompt builder: inject available agents table, skills list, categories, delegation guide",
        "Task management discipline in prompt: enforce TaskCreate/TaskUpdate pattern",
        "Full tool access (unrestricted), Temperature: 0.1",
        "Register in agent registry; update default agent resolution logic",
        "Respect existing PermissionNext permission system",
        "Unit test: Sisyphus returned as default agent when none specified",
        "Unit test: 'build' agent still accessible by explicit name",
        "Unit test: dynamic prompt contains agents table when agents exist",
        "Unit test: dynamic prompt contains categories when configured",
        "Unit test: dynamic prompt contains skills when available",
        "Unit test: Sisyphus has unrestricted tool access",
        "Unit test: Sisyphus temperature is 0.1",
        "Unit test: Sisyphus respects PermissionNext rules",
        "Unit test: Sisyphus agent definition validates against Agent schema",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "AD-1: Sisyphus replaces build as default agent"
    },
    {
      "id": "US-010",
      "title": "Create omo-explore agent as Sisyphus sub-agent",
      "description": "As a developer, I want a new omo-explore agent with LSP, AST-grep, and parallel tool execution strategy, separate from the original explore agent. Reference OMO source: src/agents/explore.ts",
      "acceptanceCriteria": [
        "Create new omo-explore agent in packages/opencode/src/agent/omo-explore.ts (original explore unchanged)",
        "Tool restrictions: DENIED write, edit, task, delegate_task (search-only)",
        "Model preference: fast/cheap models (haiku, gpt-mini)",
        "System prompt emphasizes parallel tool execution (3+ tools simultaneously)",
        "Tool strategy priority in prompt: LSP > ast_grep > grep > glob > git",
        "Structured results with absolute paths",
        "Register as subagent mode; Sisyphus delegation table references omo-explore",
        "Respect SecurityAccess for all file operations",
        "Unit test: omo-explore denies write, edit, task, delegate_task tools",
        "Unit test: omo-explore allows grep, glob, read, lsp, ast_grep_search tools",
        "Unit test: system prompt contains parallel execution guidance",
        "Unit test: system prompt contains tool strategy priority",
        "Unit test: omo-explore respects SecurityAccess (protected file denied)",
        "Unit test: original explore agent unchanged (same prompt, same tools)",
        "Unit test: Sisyphus delegation table lists omo-explore",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "AD-7: Separate omo-explore agent, original explore untouched"
    },
    {
      "id": "US-011",
      "title": "Internalize Oracle agent as strategic advisor",
      "description": "As a developer, I want a built-in strategic advisor agent for hard debugging and architecture decisions. Reference OMO source: src/agents/oracle.ts",
      "acceptanceCriteria": [
        "Create Oracle agent in packages/opencode/src/agent/oracle.ts",
        "Read-only access: DENIED write, edit, task, delegate_task",
        "Model preference: high-reasoning models (claude-opus, gpt-5.x)",
        "System prompt: pragmatic minimalism, 2-3 sentence bottom line, effort estimation (Quick/Short/Medium/Large)",
        "Temperature: 0.1, 32k thinking budget for Claude / 'medium' reasoning for GPT",
        "Register as subagent mode in agent registry",
        "Unit test: Oracle denies write, edit, task, delegate_task",
        "Unit test: Oracle allows read, grep, glob, lsp",
        "Unit test: Oracle temperature is 0.1",
        "Unit test: Oracle prompt contains effort estimation guidance",
        "Unit test: Oracle registered as subagent mode",
        "Unit test: Oracle thinking budget is 32000 for Claude models",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Add opt-in agents: Hephaestus and Prometheus",
      "description": "As a developer, I want Hephaestus (full-access builder) and Prometheus (plan mode replacement) as opt-in agents via config. When Prometheus is enabled, it replaces the plan agent. Reference OMO source: src/agents/hephaestus.ts, src/agents/prometheus/",
      "acceptanceCriteria": [
        "Create packages/opencode/src/agent/optional/ directory",
        "Implement config loading: 'agents': { 'name': { 'enabled': true } } in opencode.jsonc",
        "Agents disabled by default (not loaded unless explicitly enabled)",
        "Hephaestus: full tool access, follows existing Agent.define() pattern",
        "Prometheus: read-only (no write/edit). When enabled, replaces existing plan agent for plan mode. When disabled, original plan agent continues",
        "Per-agent config: model, temperature, thinking, prompt_append",
        "Both agents respect SecurityAccess and PermissionNext",
        "Unit test: agent not in config -> not loaded in registry",
        "Unit test: agent enabled -> loaded and accessible",
        "Unit test: Hephaestus has full tool access",
        "Unit test: Prometheus denies write/edit",
        "Unit test: Prometheus disabled -> original plan agent used for plan mode",
        "Unit test: Prometheus enabled -> Prometheus used for plan mode",
        "Unit test: per-agent model override works",
        "Unit test: per-agent temperature override works",
        "Unit test: per-agent prompt_append appended to system prompt",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "AD-6: Prometheus replaces plan agent when enabled. This story creates the optional agent infrastructure used by subsequent opt-in agent stories."
    },
    {
      "id": "US-013",
      "title": "Add opt-in agents: Atlas, Librarian, Metis",
      "description": "As a developer, I want read-focused analysis agents available through config. Reference OMO source: src/agents/atlas/, src/agents/librarian.ts, src/agents/metis.ts",
      "acceptanceCriteria": [
        "Atlas agent: no task/delegate_task tools, analysis-focused",
        "Librarian agent: read-only (no write/edit/task/delegate_task)",
        "Metis agent: read-only (no write/edit/task/delegate_task)",
        "Each loadable via opencode.jsonc: 'agents': { 'atlas': { 'enabled': true } }",
        "Default disabled, agent-specific model preferences from OMO preserved",
        "All respect SecurityAccess and PermissionNext",
        "Unit test: Atlas denies task and delegate_task",
        "Unit test: Librarian denies write, edit, task, delegate_task",
        "Unit test: Metis denies write, edit, task, delegate_task",
        "Unit test: disabled agent not listed in Sisyphus delegation table",
        "Unit test: enabled agent appears in Sisyphus delegation table",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Depends on US-012 optional agent infrastructure"
    },
    {
      "id": "US-014",
      "title": "Add opt-in agents: Momus, Multimodal-Looker, Sisyphus-Junior",
      "description": "As a developer, I want specialized agents for code review, visual analysis, and lightweight task delegation. Reference OMO source: src/agents/momus.ts, src/agents/multimodal-looker.ts, src/agents/sisyphus-junior/",
      "acceptanceCriteria": [
        "Momus agent: read-only (no write/edit/task/delegate_task), code review focus",
        "Multimodal-Looker agent: only read tool allowed, vision model preference",
        "Sisyphus-Junior agent: no task tool (prevent recursion), lightweight delegation",
        "Each loadable via opencode.jsonc config",
        "Default disabled, agent-specific model preferences from OMO preserved",
        "All respect SecurityAccess and PermissionNext",
        "Unit test: Momus denies write, edit, task, delegate_task",
        "Unit test: Multimodal-Looker only allows read tool",
        "Unit test: Sisyphus-Junior denies task tool (recursion prevention)",
        "Unit test: disabled agents not listed in delegation table",
        "Unit test: enabled agents appear in delegation table",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Depends on US-012 optional agent infrastructure"
    },
    {
      "id": "US-015",
      "title": "Implement background agent manager",
      "description": "As a developer, I want a background agent manager for async task queuing, concurrency control, and configurable lifecycle. Reference OMO source: src/features/background-agent/",
      "acceptanceCriteria": [
        "Create BackgroundManager in packages/opencode/src/agent/background/manager.ts",
        "Task lifecycle: Create -> Queue -> Concurrency Check -> Execute -> Monitor -> Notify -> Cleanup",
        "Concurrency config: defaultConcurrency (default 3), providerConcurrency, modelConcurrency",
        "Stale timeout detection (default 180000ms / 3 min) with auto cleanup",
        "Event callbacks: onSubagentSessionCreated(sessionID), onShutdown()",
        "Default: cancel all background tasks on session exit. Config persist_on_exit=true allows tasks to continue to .opencode/tasks/",
        "Background tasks share parent SecurityConfig by reference (frozen, immutable)",
        "Unit test: task creation returns unique ID",
        "Unit test: 4th task queued when limit=3",
        "Unit test: task dequeued when running task completes",
        "Unit test: providerConcurrency limits enforced",
        "Unit test: modelConcurrency limits enforced",
        "Unit test: stale task >3min cleaned up",
        "Unit test: persist_on_exit=false -> onShutdown cancels all",
        "Unit test: persist_on_exit=true -> tasks continue running",
        "Unit test: SecurityConfig shared by reference (Object.is check)",
        "Unit test: SecurityConfig is frozen (Object.isFrozen check)",
        "Unit test: task status transitions (pending -> running -> completed/failed/cancelled)",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": "AD-9: Background task lifecycle configurable"
    },
    {
      "id": "US-016",
      "title": "Implement task category system",
      "description": "As a developer, I want task categories that map to models and configurations for delegated work. Reference OMO source: src/config/schema/categories.ts, src/tools/delegate-task/constants.ts",
      "acceptanceCriteria": [
        "Define default categories in packages/opencode/src/agent/background/categories.ts: visual-engineering, ultrabrain, deep, artistry, quick, writing, unspecified-low, unspecified-high",
        "Each category: { description, model?, prompt_append? }",
        "Categories configurable via opencode.jsonc, user categories merge with/override defaults",
        "All agents see category list (context awareness). Only agents with delegate_task permission can route via categories",
        "Sisyphus dynamic prompt builder generates delegation table from categories",
        "Categories integrate with delegate_task tool's category parameter",
        "Unit test: all 8 default categories exist with descriptions",
        "Unit test: user category overrides default",
        "Unit test: user adds custom category",
        "Unit test: category lookup by name returns correct config",
        "Unit test: unknown category returns error",
        "Unit test: Sisyphus prompt contains category delegation table",
        "Unit test: delegate_task resolves category to model",
        "Unit test: read-only agent sees categories but cannot invoke delegate_task",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": "AD-10: Category system visible to all agents, usable only with delegate_task permission"
    },
    {
      "id": "US-017",
      "title": "Enhance Glob tool with OMO parameters",
      "description": "As a developer, I want the glob tool to support maxDepth, hidden, follow, and noIgnore parameters. Reference OMO source: src/tools/glob/",
      "acceptanceCriteria": [
        "Add optional parameters: maxDepth (default 20), hidden (default false), follow (default false), noIgnore (default false)",
        "Pass parameters to underlying Ripgrep.files() invocation",
        "Existing SecurityAccess filtering continues to work on all results",
        "Add explicit 60s timeout with process kill",
        "Backward compatible (existing parameter schema still valid)",
        "Unit test: default parameters match current behavior",
        "Unit test: maxDepth=2 limits depth",
        "Unit test: hidden=true includes dotfiles",
        "Unit test: hidden=false excludes dotfiles",
        "Unit test: follow=true follows symlinks",
        "Unit test: noIgnore=true includes .gitignore'd files",
        "Unit test: SecurityAccess still filters with new params",
        "Unit test: 60s timeout kills process",
        "Unit test: backward compat with only pattern+path",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Enhance Grep tool with OMO parameters",
      "description": "As a developer, I want advanced ripgrep options for more precise searches. Reference OMO source: src/tools/grep/",
      "acceptanceCriteria": [
        "Add optional parameters: context (number), caseSensitive (boolean), wholeWord (boolean), fixedStrings (boolean), multiline (boolean), maxCount (default 500), maxColumns (number), exclude (glob), fileType (string)",
        "Map parameters to ripgrep flags in Ripgrep abstraction layer",
        "SecurityAccess file filtering and segment redaction continue to work",
        "Handle ripgrep exit code 2 (partial results) gracefully with warning",
        "Backward compatible",
        "Unit test: default parameters match current behavior",
        "Unit test: context=3 includes 3 lines before/after match",
        "Unit test: caseSensitive=false finds case-insensitive matches",
        "Unit test: wholeWord=true matches whole words only",
        "Unit test: fixedStrings=true treats pattern as literal",
        "Unit test: multiline=true matches across lines",
        "Unit test: maxCount=10 limits results",
        "Unit test: exclude='*.test.ts' excludes test files",
        "Unit test: fileType='ts' only searches TypeScript",
        "Unit test: SecurityAccess still redacts with new params",
        "Unit test: exit code 2 returns partial results with warning",
        "Unit test: backward compat with only pattern",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Split LSP tool into focused navigation tools",
      "description": "As a developer, I want separate LSP tools for goto-definition, find-references, and symbols. Reference OMO source: src/tools/lsp/",
      "acceptanceCriteria": [
        "Create lsp_goto_definition tool with file, line, column params",
        "Create lsp_find_references tool with includeDeclaration (boolean) and limit (default 100)",
        "Create lsp_symbols tool with scope ('document'|'workspace'), query (string), limit (default 50)",
        "Preserve existing lsp_hover and lsp_implementation as separate tools",
        "Register all tools in ToolRegistry with experimental flag",
        "SecurityAccess.checkAccess(filePath, 'read') on file paths in LSP results",
        "Unit test: lsp_goto_definition -> formatted output with file:line:col",
        "Unit test: lsp_find_references with limit=100 truncates 150 results",
        "Unit test: lsp_find_references includeDeclaration=false excludes declaration",
        "Unit test: lsp_symbols scope='document' returns only document symbols",
        "Unit test: lsp_symbols scope='workspace' with query='Foo' returns filtered results",
        "Unit test: SecurityAccess with protected file -> filtered out",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": false,
      "notes": "Part 1 of LSP split. Part 2 (US-020) adds diagnostic/rename tools."
    },
    {
      "id": "US-020",
      "title": "Split LSP tool: diagnostics, rename, and deprecation",
      "description": "As a developer, I want separate LSP tools for diagnostics, prepare-rename, rename, and call-hierarchy. Deprecate old unified lsp tool. Reference OMO source: src/tools/lsp/",
      "acceptanceCriteria": [
        "Create lsp_diagnostics tool with severity filter ('error'|'warning'|'information'|'hint'|'all')",
        "Create lsp_prepare_rename tool",
        "Create lsp_rename tool",
        "Create lsp_call_hierarchy tool",
        "Deprecate old unified lsp tool (log deprecation warning, forward to new tools)",
        "SecurityAccess.checkAccess on file paths",
        "Unit test: lsp_diagnostics severity='error' returns only errors",
        "Unit test: lsp_diagnostics severity='all' returns all severities",
        "Unit test: lsp_prepare_rename with renameable symbol -> success",
        "Unit test: lsp_rename -> all affected files listed",
        "Unit test: deprecated lsp tool -> deprecation warning + forwarded",
        "Unit test: SecurityAccess on protected file -> filtered out",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": false,
      "notes": "Depends on US-019 for shared LSP infrastructure"
    },
    {
      "id": "US-021",
      "title": "Add AST-Grep search and replace tools",
      "description": "As a developer, I want AST-aware code search and refactoring tools. Reference OMO source: src/tools/ast-grep/",
      "acceptanceCriteria": [
        "Create ast_grep_search tool: pattern, lang (25 languages), paths (default ['.']), globs, context",
        "Create ast_grep_replace tool: same + rewrite, dryRun (default true)",
        "@ast-grep/napi is peer dep. If not installed, return: 'ast-grep not available. Install with: bun add @ast-grep/napi'",
        "SecurityAccess.checkAccess(path, 'read') for search, checkAccess(path, 'write') for replace",
        "SecuritySegments: do not replace within protected code segments",
        "SecurityAudit.log() for denied operations",
        "Gate behind experimental flag",
        "Unit test: pattern 'console.log($MSG)' in JS -> matches found",
        "Unit test: no matches -> 'No matches found'",
        "Unit test: dryRun=true -> changes shown but NOT applied",
        "Unit test: dryRun=false -> file modified on disk",
        "Unit test: replace on protected file -> SecurityAccess blocks",
        "Unit test: replace on file with protected segment -> only non-protected modified",
        "Unit test: denied replacement -> audit event logged",
        "Unit test: @ast-grep/napi not installed -> clear error message",
        "Unit test: experimental flag disabled -> tool not registered",
        "Unit test: 25 language enum values accepted",
        "Unit test: globs ['!*.test.ts'] excludes test files",
        "Typecheck passes"
      ],
      "priority": 21,
      "passes": false,
      "notes": "AD-2: @ast-grep/napi as peer dependency"
    },
    {
      "id": "US-022",
      "title": "Add delegate-task tool with background execution",
      "description": "As a developer, I want to delegate tasks to agents with category routing and background execution. Reference OMO source: src/tools/delegate-task/, src/tools/background-task/",
      "acceptanceCriteria": [
        "Create delegate_task tool: description, prompt, run_in_background, category (optional), subagent_type (optional), session_id (optional), load_skills (optional)",
        "Create background_output tool: task_id -> returns status + output",
        "Create background_cancel tool: task_id -> cancels running task",
        "run_in_background=true returns task_id immediately; =false waits for completion",
        "Category resolution from category system (US-016)",
        "Skill injection: load skills by name into sub-agent context",
        "Session continuation: session_id continues existing sub-session",
        "Deny delegate_task for sub-agents (prevent recursion)",
        "Integrate with BackgroundManager (US-015) for concurrency",
        "Sub-agents share parent SecurityConfig by reference",
        "Unit test: sync execution waits and returns result",
        "Unit test: async execution returns task_id immediately",
        "Unit test: background_output returns status + partial output",
        "Unit test: background_cancel terminates task",
        "Unit test: category='quick' selects cheap model",
        "Unit test: subagent_type='oracle' uses Oracle agent",
        "Unit test: both category and subagent_type -> error",
        "Unit test: load_skills injects skill content",
        "Unit test: session continuation with session_id",
        "Unit test: sub-agent calls delegate_task -> denied",
        "Unit test: SecurityConfig shared (frozen reference)",
        "Unit test: exceeding concurrency limit queues task",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": false,
      "notes": "Depends on US-015 (BackgroundManager) and US-016 (categories)"
    },
    {
      "id": "US-023",
      "title": "Add look-at multimodal analyzer tool",
      "description": "As a developer, I want a tool to analyze images, PDFs, and diagrams using vision models. Reference OMO source: src/tools/look-at/",
      "acceptanceCriteria": [
        "Create look_at tool: file_path (optional), image_data (base64, optional), goal (required)",
        "At least one of file_path or image_data must be provided",
        "Route to vision-capable model (configurable, default gemini-flash)",
        "SecurityAccess.checkAccess(filePath, 'read') before reading, checkAccess(filePath, 'llm') before vision model",
        "Return extracted text information",
        "Unit test: file_path to image -> read + analyzed",
        "Unit test: base64 image_data -> analyzed without file read",
        "Unit test: neither provided -> error",
        "Unit test: protected file -> SecurityAccess denies read",
        "Unit test: read allowed but llm denied -> blocked before vision model",
        "Unit test: goal parameter affects extraction",
        "Unit test: unsupported file type -> clear error",
        "Typecheck passes"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Add skill-mcp tool for MCP operations within skills",
      "description": "As a developer, I want to invoke MCP tools, resources, and prompts from within skill context. Reference OMO source: src/tools/skill-mcp/",
      "acceptanceCriteria": [
        "Create skill_mcp tool: mcp_name, tool_name (optional), resource_name (optional), prompt_name (optional), arguments (optional)",
        "Validate exactly ONE of tool_name/resource_name/prompt_name provided",
        "Reuse existing MCP client management (MCP.tools() infrastructure)",
        "Apply MCP security policy from .opencode-security.json",
        "Unit test: tool invocation with tool_name='search' -> MCP tool called",
        "Unit test: resource access with resource_name='docs' -> resource fetched",
        "Unit test: prompt execution with prompt_name='summarize' -> prompt run",
        "Unit test: multiple operations specified -> validation error",
        "Unit test: no operation specified -> validation error",
        "Unit test: blocked MCP server -> access denied",
        "Unit test: unknown MCP server -> clear error",
        "Unit test: arguments as JSON string -> parsed correctly",
        "Unit test: arguments as object -> passed through",
        "Typecheck passes"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-025",
      "title": "Add interactive-bash tool for tmux management",
      "description": "As a developer, I want tmux session management for parallel agent terminal panes. Reference OMO source: src/tools/interactive-bash/",
      "acceptanceCriteria": [
        "Create interactive_bash tool: tmux_command (string)",
        "Block dangerous subcommands: send-keys, send, type, paste (prevent shell injection bypass)",
        "BashScanner applied to file paths in tmux commands",
        "Gate behind experimental flag + tmux availability check",
        "Unit test: allowed command 'list-sessions' -> executed",
        "Unit test: blocked 'send-keys' -> denied with message",
        "Unit test: blocked 'send' -> denied",
        "Unit test: tmux command with protected file path -> BashScanner blocks",
        "Unit test: tmux not installed -> clear error",
        "Unit test: experimental flag disabled -> tool not registered",
        "Typecheck passes"
      ],
      "priority": 25,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-026",
      "title": "Enhance Task tool with persistent storage and dependencies",
      "description": "As a developer, I want tasks to persist across sessions with dependency tracking. Reference OMO source: src/features/claude-tasks/, src/tools/task/",
      "acceptanceCriteria": [
        "File-based storage in .opencode/tasks/ (one JSON per task)",
        "Fields: id (T-{uuid}), subject, description, status, blockedBy, blocks, owner, metadata, activeForm, createdAt, updatedAt",
        "Atomic writes with file-level locking",
        "'ready' filter: list tasks where all blockedBy dependencies completed",
        "Backward compatible with existing TaskTool (agent spawning)",
        "Unit test: create -> JSON file in .opencode/tasks/ with T-{uuid} format",
        "Unit test: all fields populated with defaults",
        "Unit test: list returns all tasks",
        "Unit test: ready filter excludes tasks with incomplete blockedBy",
        "Unit test: ready filter includes tasks with completed blockedBy",
        "Unit test: get returns full details",
        "Unit test: nonexistent ID -> clear error",
        "Unit test: status transitions pending -> in_progress -> completed",
        "Unit test: invalid transition -> error",
        "Unit test: delete removes file",
        "Unit test: blockedBy stored and enforced",
        "Unit test: concurrent writes -> no corruption (file lock)",
        "Unit test: existing task tool (agent spawning) still works",
        "Typecheck passes"
      ],
      "priority": 26,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-027",
      "title": "Enhance Skill tool with MCP listing",
      "description": "As a developer, I want the skill tool to show MCP capabilities and support lazy loading. Reference OMO source: src/tools/skill/, src/features/opencode-skill-loader/",
      "acceptanceCriteria": [
        "When skill defines mcp metadata, list available tools/resources/prompts per MCP server",
        "Lazy content loading for large skill templates (defer read until invoked)",
        "Skill-to-agent restriction: skill.agent field limits which agents can use the skill",
        "Support <skill-instruction> XML block extraction",
        "Preserve existing skill permission filtering via PermissionNext",
        "Unit test: skill with MCP config -> tools/resources/prompts listed",
        "Unit test: skill without MCP -> no MCP section",
        "Unit test: large skill -> content not read until invoked",
        "Unit test: skill.agent='sisyphus', current='explore' -> denied",
        "Unit test: skill.agent='sisyphus', current='sisyphus' -> allowed",
        "Unit test: skill with <skill-instruction> -> only that block returned",
        "Unit test: skill denied by PermissionNext -> not listed",
        "Typecheck passes"
      ],
      "priority": 27,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-028",
      "title": "Integrate OMO built-in MCP servers",
      "description": "As a developer, I want built-in MCP configs for web search, docs, and code search. Default disabled, auto-enable on API key. Reference OMO source: src/mcp/",
      "acceptanceCriteria": [
        "Add built-in MCP configs: websearch (Exa), context7 (documentation), grep_app (GitHub code search)",
        "Default disabled until user provides API key",
        "Auto-enable when env var set (EXA_API_KEY, CONTEXT7_API_KEY, GREP_APP_API_KEY) or key in opencode.jsonc",
        "Remote MCP server type with URL, headers, OAuth support",
        "Apply MCP security policy from .opencode-security.json",
        "Individually disableable via disabled_mcps config",
        "When agent tries disabled MCP, return clear message with required env var name",
        "Unit test: all 3 servers have valid configs",
        "Unit test: default state all disabled",
        "Unit test: set EXA_API_KEY -> websearch enabled",
        "Unit test: key in opencode.jsonc -> server enabled",
        "Unit test: no key + agent tries MCP -> clear error with env var name",
        "Unit test: API key set but disabled_mcps=['websearch'] -> not loaded",
        "Unit test: blocked server -> tools not exposed",
        "Unit test: enforced server -> input scanning applied",
        "Unit test: OAuth params passed to MCP client",
        "Typecheck passes"
      ],
      "priority": 28,
      "passes": false,
      "notes": "AD-11: Built-in MCP servers default disabled, auto-enable on API key"
    },
    {
      "id": "US-029",
      "title": "Internalize OMO built-in skills and commands",
      "description": "As a developer, I want built-in skills (git-master, playwright) and commands available by default. Reference OMO source: src/features/builtin-skills/, src/features/builtin-commands/",
      "acceptanceCriteria": [
        "Port git-master skill: atomic commit generation, conventional commit enforcement",
        "Port playwright skill: browser automation for testing",
        "Port built-in commands (up to 6 from OMO)",
        "Skills/commands discoverable via existing APIs (Skill.all(), command discovery)",
        "User-defined skills/commands take priority over built-in",
        "Skills respect PermissionNext, commands respect SecurityAccess",
        "Unit test: git-master skill loaded and discoverable",
        "Unit test: playwright skill loaded and discoverable",
        "Unit test: user skill with same name overrides built-in",
        "Unit test: built-in commands loaded",
        "Unit test: user command overrides built-in",
        "Unit test: skill permission filtering applies to built-in",
        "Unit test: command file operation respects SecurityAccess",
        "Typecheck passes"
      ],
      "priority": 29,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-030",
      "title": "Extend opencode.jsonc schema for OMO features",
      "description": "As a developer, I want all OMO features configurable through opencode.jsonc with Zod schemas. Reference OMO source: src/config/schema/",
      "acceptanceCriteria": [
        "Add Zod config sections: agents (Record<string, { enabled?, model?, temperature?, thinking?, prompt_append? }>)",
        "Add categories (Record<string, { description, model?, prompt_append? }>)",
        "Add hooks (Record<string, { enabled: boolean }>) - all hooks default enabled",
        "Add background_task ({ defaultConcurrency?, providerConcurrency?, modelConcurrency?, staleTimeoutMs?, persist_on_exit? })",
        "Add notification ({ enabled?, sound? })",
        "Add disabled_mcps (string[])",
        "Merge with existing config loading precedence",
        "Backward compatible: no existing config breaks",
        "Unit test: empty config -> all defaults applied",
        "Unit test: agents section enable agent -> loaded",
        "Unit test: categories section add custom -> available",
        "Unit test: hooks section disable -> hook skipped",
        "Unit test: background_task concurrency -> enforced",
        "Unit test: notification disable -> no notifications",
        "Unit test: disabled_mcps -> server not loaded",
        "Unit test: invalid value -> Zod error with helpful message",
        "Unit test: existing valid config -> no errors",
        "Typecheck passes"
      ],
      "priority": 30,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-031",
      "title": "Security integration for all new tools and agents",
      "description": "As a developer, I want all new components fully integrated with security access control, with SecurityAudit logging for all denied operations.",
      "acceptanceCriteria": [
        "ast_grep_search: SecurityAccess.checkAccess(path, 'read') for matched files",
        "ast_grep_replace: SecurityAccess.checkAccess(path, 'write') + SecuritySegments for protected code",
        "delegate_task: sub-agents share parent SecurityConfig (frozen reference, Object.freeze at bootstrap)",
        "look_at: checkAccess(path, 'read') + checkAccess(path, 'llm')",
        "skill_mcp: MCP security policy from .opencode-security.json",
        "interactive_bash: BashScanner on tmux command arguments",
        "Context injection hooks: SecurityAccess + LLM scanner before injecting",
        "Background agents: frozen SecurityConfig propagated by reference",
        "SecurityAudit.log() for all new security-relevant operations",
        "Unit test: ast_grep_search protected file -> denied + audit logged",
        "Unit test: ast_grep_replace protected segment -> blocked + audit logged",
        "Unit test: ast_grep_replace non-protected region of file with protected segment -> only non-protected replaced",
        "Unit test: delegate_task Object.is(parent.config, child.config) === true",
        "Unit test: delegate_task Object.isFrozen(config) === true",
        "Unit test: delegate_task mutation throws TypeError",
        "Unit test: look_at read-denied -> blocked",
        "Unit test: look_at llm-denied (read allowed) -> blocked before vision model",
        "Unit test: skill_mcp blocked server -> denied",
        "Unit test: interactive_bash protected file -> BashScanner blocks",
        "Unit test: context injection AGENTS.md protected segment -> redacted",
        "Unit test: SecurityAudit.log called for each denied operation",
        "Typecheck passes"
      ],
      "priority": 31,
      "passes": false,
      "notes": "Cross-cutting security verification for all new components"
    },
    {
      "id": "US-032",
      "title": "Build OMO upstream diff reporting tool",
      "description": "As a maintainer, I want automated diff reports when OMO releases new versions, as both manual script and CI workflow.",
      "acceptanceCriteria": [
        "Create script/omo-diff.ts: fetch latest OMO from npm, compare against baseline, generate structured diff report",
        "Diff report sections: new/modified tools, hooks, agents, config schema, dependencies",
        "Each change categorized: 'backport recommended' / 'review needed' / 'skip (diverged)'",
        "Impact analysis: affected opencode files per change",
        "Runnable via bun run script/omo-diff.ts",
        "Create .github/workflows/omo-diff.yml: weekly schedule + manual dispatch, checkout -> run -> commit report -> open PR",
        "Does NOT run on bun install",
        "Unit test: mock npm view -> version extracted",
        "Unit test: mock tarball -> files extracted",
        "Unit test: mock baseline + new version -> diff generated",
        "Unit test: report has all sections",
        "Unit test: new tool -> 'backport recommended'",
        "Unit test: modified tool with security divergence -> 'skip (diverged)'",
        "Unit test: impact analysis lists affected files",
        "Unit test: same version -> 'no changes' report",
        "Unit test: CI workflow YAML is valid",
        "Unit test: exit codes correct (0 for success, 1 for error)",
        "Typecheck passes"
      ],
      "priority": 32,
      "passes": false,
      "notes": "AD-12: manual script + CI template, no postinstall hook"
    },
    {
      "id": "US-033",
      "title": "Create OMO baseline tracking file",
      "description": "As a maintainer, I want a baseline file recording which OMO version was internalized for diff tracking.",
      "acceptanceCriteria": [
        "Create packages/opencode/.omo-baseline.json with version, date, tools map, hooks map, agents map, notes",
        "Diff tool (US-032) reads and optionally updates this file",
        "Unit test: baseline file schema validates with Zod",
        "Unit test: diff tool reads baseline correctly",
        "Unit test: diff tool updates baseline version after comparison",
        "Unit test: baseline with missing fields -> defaults applied",
        "Typecheck passes"
      ],
      "priority": 33,
      "passes": false,
      "notes": "Depends on US-032 diff tool"
    },
    {
      "id": "US-034",
      "title": "Integration tests for security across all new components",
      "description": "As a developer, I want end-to-end integration tests verifying security access control works with all new tools and agents.",
      "acceptanceCriteria": [
        "Test: ast_grep_search on protected file -> access denied",
        "Test: ast_grep_replace on protected segment -> blocked, non-protected regions modifiable",
        "Test: delegate_task sub-agent inherits frozen SecurityConfig, cannot modify it",
        "Test: look_at on read-protected file -> access denied",
        "Test: look_at on llm-protected file -> denied before vision model",
        "Test: context injection (AGENTS.md) with protected segments -> segments redacted",
        "Test: context injection (rules) with protected rule file -> file skipped",
        "Test: background agent respects same security rules as parent",
        "Test: tool-output-truncator preserves [REDACTED: Security Protected] markers",
        "Test: interactive_bash protected file in tmux command -> BashScanner blocks",
        "Test: skill_mcp with blocked MCP server -> denied",
        "Test: SecurityAudit receives events for all above denials",
        "Tests run via bun test --cwd packages/opencode",
        "Typecheck passes"
      ],
      "priority": 34,
      "passes": false,
      "notes": "End-to-end security integration tests. Run after all tools/agents implemented."
    },
    {
      "id": "US-035",
      "title": "Performance benchmarks for hook pipeline",
      "description": "As a developer, I want benchmarks ensuring hooks don't degrade performance, with documented results.",
      "acceptanceCriteria": [
        "Benchmark: full hook pipeline overhead per tool execution",
        "Target: PreLLMChain < 5ms, PreToolChain < 2ms, PostToolChain < 10ms (excluding I/O)",
        "Target: tool-output-truncator < 50ms for 10MB output",
        "Target: context-window-monitor < 1ms (token counting cached)",
        "Target: disabled hook < 0.01ms (boolean check only)",
        "Benchmark context injection caching: second call < 0.1ms",
        "Results documented in tasks/omo-perf-report.md",
        "All benchmarks run with --bench flag",
        "Bench: PreLLMChain 5 hooks p50/p99 latency",
        "Bench: PreToolChain 3 hooks p50/p99 latency",
        "Bench: PostToolChain 5 hooks p50/p99 latency",
        "Bench: tool-output-truncator on 1KB/100KB/1MB/10MB inputs",
        "Bench: context-window-monitor token counting",
        "Bench: disabled hook overhead 1000 iterations",
        "Bench: AGENTS.md injection cache hit vs miss",
        "Bench: full pipeline with all hooks",
        "Typecheck passes"
      ],
      "priority": 35,
      "passes": false,
      "notes": "Final story. Run after all hooks implemented to measure real overhead."
    }
  ]
}
