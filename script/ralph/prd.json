{
  "project": "OpenCode",
  "branchName": "ralph/core-features-plugin-security",
  "description": "Core Feature Integration & Plugin Security Enforcement - Move 7 high-value capabilities to built-in and enforce security on plugin tools/hooks",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create shared security utilities (scanAndRedact, getDefault role)",
      "description": "As a developer, I need shared security utility functions so that duplicated logic across 6 tool files and prompt code is consolidated into a single module.",
      "acceptanceCriteria": [
        "Create packages/opencode/src/security/util.ts",
        "Export SecurityRole.getDefault(config) that returns the lowest role from config.roles (same logic currently duplicated in read.ts, write.ts, edit.ts, grep.ts, glob.ts, bash.ts)",
        "Export scanAndRedact(content, config) that chains LLMScanner.scanForProtectedContent() to extract {start, end} byte offsets, then SecurityRedact.redactContent() to replace protected ranges",
        "Both functions handle the case where security config has no rules (return content unchanged / return lowest role or 'viewer')",
        "Export isRoleAllowed(roleName, allowedRoles, config) and getRoleLevel(roleName, config) shared helpers",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Consolidated duplicated getRoleLevel, isRoleAllowed, findProtectedSegments from read.ts and grep.ts into SecurityUtil namespace"
    },
    {
      "id": "US-002",
      "title": "Protect config files and change MCP default policy",
      "description": "As a security-conscious user, I want .opencode-security.json and audit log self-protected, and unknown MCP servers scanned by default when security config exists.",
      "acceptanceCriteria": [
        "In packages/opencode/src/security/config.ts loadSecurityConfig(): after loading config, append implicit rule { pattern: '.opencode-security.json', type: 'file', deniedOperations: ['write'], allowedRoles: [] } if no explicit user-defined rule for that pattern exists",
        "Same implicit rule for '.opencode-security-audit.log' with deniedOperations: ['write'], allowedRoles: []",
        "In mergeSecurityConfigs(): also append the same implicit rules to the merged result if not already present",
        "In getMcpPolicy(): when no mcp block exists but config.rules is non-empty or config.segments is defined, return 'enforced' (not 'trusted') for unknown servers",
        "When no .opencode-security.json exists at all, getMcpPolicy() continues returning 'trusted' for unknown servers (backward compatible)",
        "Explicitly configured 'trusted' servers remain trusted regardless of rules/segments",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Already implemented in commit 5f4dca313 — appendImplicitRules() protects .opencode-security.json and .opencode-security-audit.log, getMcpPolicy() returns 'enforced' when rules/segments exist but no mcp block"
    },
    {
      "id": "US-003",
      "title": "Create built-in feature registry and plugin query API",
      "description": "As a plugin developer, I want to query whether a feature has been internalized into OpenCode core so my plugin can skip redundant tool/hook registration.",
      "acceptanceCriteria": [
        "Create packages/opencode/src/plugin/builtin.ts with namespace BuiltIn containing a static Set<string> of feature IDs and has(feature: string): boolean function",
        "Feature IDs are kebab-case strings. Initially the Set is empty (features uncommented as they ship)",
        "Add hasBuiltIn: (feature: string) => boolean to PluginInput in packages/opencode/src/plugin/index.ts, wired to BuiltIn.has",
        "Add hasBuiltIn: (feature: string) => boolean to PluginInput type in packages/plugin/src/index.ts",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Already implemented in commit 5f4dca313 — builtin.ts has BuiltIn namespace with Set and has(), plugin/index.ts wires hasBuiltIn: BuiltIn.has, plugin SDK has hasBuiltIn in PluginInput type"
    },
    {
      "id": "US-004",
      "title": "Create ast_grep_search tool",
      "description": "As a developer, I want an AST-aware code search tool so that I can find code patterns structurally, not just by text matching.",
      "acceptanceCriteria": [
        "Run bun add @ast-grep/napi in packages/opencode/ to install the native binding",
        "Create packages/opencode/src/tool/ast_grep.ts with ast_grep_search tool using Tool.define() pattern with Zod parameter schemas",
        "Parameters: pattern (string, required), lang (enum of supported languages, required), paths (string[], optional), globs (string[], optional), context (number, optional — lines of surrounding context)",
        "Implementation uses findInFiles() from @ast-grep/napi for multi-file async parallel search",
        "Callback extracts: node.text(), node.range() (0-based {start: {line, column}, end: {line, column}}), node.getRoot().filename()",
        "For context lines: read file, extract lines around match range",
        "Safety limits: 60s timeout, 100 file max for search results",
        "Call SecurityAccess.checkAccess() on target paths before scanning, consistent with GrepTool and GlobTool",
        "Results pass through Truncate.output() for large result handling",
        "Register ast_grep_search in ToolRegistry.all() alongside existing built-in tools",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Add ast_grep_replace tool",
      "description": "As a developer, I want AST-aware code replacement so that I can refactor code patterns with structural substitution.",
      "acceptanceCriteria": [
        "Add ast_grep_replace tool to packages/opencode/src/tool/ast_grep.ts using Tool.define() pattern",
        "Parameters: pattern (string, required), rewrite (string, required), lang (enum, required), paths (string[], optional), globs (string[], optional), dryRun (boolean, default true)",
        "Implementation uses parse(lang, source).root().findAll(pattern) from @ast-grep/napi for per-file matching",
        "For each match: resolve meta-variables via node.getMatch('VAR')?.text(), apply to rewrite template",
        "Apply edits sorted by position (end-to-start) via root.commitEdits(edits) to produce new source",
        "Dry-run (default): return list of edits without writing files. Live mode (dryRun=false): write new source via Bun.write()",
        "Call SecurityAccess.checkAccess() on target paths with 'write' operation for live mode",
        "Register ast_grep_replace in ToolRegistry.all()",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Remove LSP experimental flags and add diagnostics operation",
      "description": "As a developer, I want LSP tools available by default (not behind experimental flags) and a diagnostics operation for getting errors/warnings from language servers.",
      "acceptanceCriteria": [
        "Remove OPENCODE_EXPERIMENTAL_LSP_TOOL flag gate in packages/opencode/src/tool/registry.ts — LspTool always available",
        "Remove OPENCODE_EXPERIMENTAL_LSP_TY flag in packages/opencode/src/lsp/index.ts and packages/opencode/src/lsp/server.ts — LSP server type selection fully available",
        "Remove the flag definitions from packages/opencode/src/flag/flag.ts",
        "Add diagnostics operation to LspTool discriminated union in packages/opencode/src/tool/lsp.ts",
        "Refactor existing LSP.diagnostics() in lsp/index.ts: add optional filePath parameter to filter to a single file, add optional severity filter (error, warning, information, hint, all)",
        "Calling diagnostics without parameters still returns all diagnostics (backward compatible)",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Add LSP prepareRename and rename operations",
      "description": "As a developer, I want language-aware rename operations so that I can refactor symbols across the workspace with precision.",
      "acceptanceCriteria": [
        "Add prepareRename operation to LspTool discriminated union in packages/opencode/src/tool/lsp.ts",
        "Add LSP.prepareRename(position) method in lsp/index.ts using connection.sendRequest('textDocument/prepareRename', ...)",
        "prepareRename returns rename range or error if rename is not valid at that position",
        "Add rename operation to LspTool discriminated union",
        "Add LSP.rename(position, newName) method in lsp/index.ts using connection.sendRequest('textDocument/rename', ...)",
        "rename returns workspace edit (list of file changes). The LspTool applies the workspace edit (writes changed files) and returns a summary of changes",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Create multimodal analysis tool (look_at)",
      "description": "As a developer, I want a tool that can analyze images, PDFs, and diagrams so the AI can understand visual content.",
      "acceptanceCriteria": [
        "Create packages/opencode/src/tool/look_at.ts with look_at tool using Tool.define() pattern",
        "Parameters: file_path (string, required), goal (string describing what to analyze, required), image_data (base64 string, optional)",
        "Supports image formats: PNG, JPG, GIF, WebP, SVG and PDF files",
        "Reads file via Bun.file() and constructs multimodal prompt with binary content and goal description",
        "Check model capabilities: verify 'image' in modalities.input or capabilities.input.image before attempting multimodal input",
        "If model lacks multimodal support, return clear error: 'Current model ({modelID}) does not support image input. Switch to a multimodal model.'",
        "Call SecurityAccess.checkAccess() on file_path before reading",
        "Register look_at in ToolRegistry.all()",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Enhance context injection with README discovery",
      "description": "As a developer, I want README.md content automatically injected alongside AGENTS.md so the AI understands my project conventions.",
      "acceptanceCriteria": [
        "In packages/opencode/src/session/instruction.ts InstructionPrompt.resolve(): add README.md to discovery alongside existing AGENTS.md/CLAUDE.md",
        "When the agent reads a file in a subdirectory, inject that directory's README.md if it exists and hasn't been already injected",
        "Injected content includes source attribution header (e.g., '[Instructions from: path/to/README.md]')",
        "No duplication of content already injected by existing instruction system",
        "Add configuration option in .opencode.json: experimental.readme_injection (boolean, default true)",
        "When readme_injection is false, skip README.md discovery",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Add todo continuation enforcer",
      "description": "As a developer, I want the agent to automatically resume incomplete TODOs instead of stopping mid-task.",
      "acceptanceCriteria": [
        "Add post-turn check in session processing (session/llm.ts or session/processor.ts)",
        "After each agent turn: read session TODO list via Todo.get(). If any items have status pending or in_progress and agent response has no pending tool calls, increment continuation counter",
        "If counter <= max (configurable, default 3), inject continuation system message prompting agent to continue working on incomplete items",
        "If counter > max, stop and let session end normally",
        "Skip when current agent is plan-mode (read-only agent)",
        "Store continuation count in session metadata",
        "Add configuration option: experimental.todo_continuation (boolean or number for max retries, default 3)",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Add comment checker for AI-generated code",
      "description": "As a developer, I want AI-generated code to be free of excessive comments so the codebase stays clean.",
      "acceptanceCriteria": [
        "Add post-processing step to write-producing tools (edit.ts, write.ts, apply_patch.ts)",
        "Heuristic 1 — Comment density ratio: count comment lines vs code lines. Thresholds by sensitivity: strict > 0.15, normal > 0.3, relaxed > 0.5",
        "Heuristic 2 — Obvious comment patterns: regex match against AI-slop patterns after stripping comment prefix by file extension (// for JS/TS/Go/Java/C/Rust, # for Python/Ruby/Shell, <!-- for HTML, /* for CSS, -- for SQL/Lua)",
        "Heuristic 3 — Comment-to-code duplication: detect comments near-identical to next line of code (Levenshtein distance < 30% of comment length after normalizing)",
        "When any heuristic triggers, append advisory to tool output: 'Note: The generated code contains excessive comments. Consider removing obvious comments.'",
        "Configuration in .opencode.json: experimental.comment_checker ('strict' | 'normal' | 'relaxed' | false, default 'normal')",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Create session crash recovery system",
      "description": "As a developer, I want the system to detect interrupted sessions and offer to resume from where I left off.",
      "acceptanceCriteria": [
        "Create packages/opencode/src/session/recovery.ts",
        "Dual-layer heartbeat storage: project-local {project}/.opencode/recovery/{sessionID}.json (priority) and global ~/.opencode/recovery/{sessionID}.json (fallback)",
        "Heartbeat format: { sessionID, projectDir, todoState, timestamp, pid }",
        "Write heartbeat to both locations on session creation and each message save (non-blocking via Bun.write())",
        "Delete heartbeat from both locations on graceful session end (process.on('exit') handler)",
        "On startup: scan for stale heartbeats (project-local first, then global). Stale = pid no longer running (process.kill(pid, 0) in try/catch). Deduplicate by sessionID (project-local wins)",
        "If stale heartbeat found, prompt user to resume or dismiss",
        "Resume restores: TODO list state, session context, last working directory",
        "If user declines, archive the interrupted session normally",
        "Auto-add .opencode/recovery/ to project .gitignore if not already present",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Enforce security on plugin-defined tools",
      "description": "As a security-conscious user, I want plugin-defined tools to go through the same security checks as built-in tools.",
      "acceptanceCriteria": [
        "In packages/opencode/src/tool/registry.ts ToolRegistry.fromPlugin(): wrap plugin tool execute() with two-layer security",
        "Pre-execution: extract all string values recursively from tool arguments object. For each string, call path.resolve(directory, str), check fs.existsSync(resolvedPath), if exists run SecurityAccess.checkAccess(resolvedPath, 'read', currentRole). Block execution if any path denied",
        "Use SecurityRole.getDefault(config) from security/util.ts (US-001) for currentRole",
        "Post-execution: scan returned string (or JSON-serialized result for objects/arrays) via LLMScanner.scanForProtectedContent() then SecurityRedact.redactContent()",
        "Log blocked/redacted events via SecurityAudit.logSecurityEvent() with source: 'plugin-tool' and pluginName/toolName fields",
        "Plugin tools that don't return file content continue to work unchanged",
        "Short-circuit: skip all security work when config.rules is empty and config.segments is undefined",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Redact protected content in plugin hooks (system, text, task)",
      "description": "As a security-conscious user, I want plugin hooks that receive content to have protected content redacted.",
      "acceptanceCriteria": [
        "In packages/opencode/src/plugin/index.ts: Plugin.trigger('experimental.chat.system.transform') applies scanAndRedact() from security/util.ts to system prompt strings before passing to plugin hooks",
        "Plugin.trigger('experimental.text.complete') hook output is scanned via scanAndRedact() before being sent to the LLM",
        "In packages/opencode/src/session/prompt.ts: fix task tool gap at lines 422-430 where result is passed directly to tool.execute.after hook — add scanAndRedact() before the hook fires",
        "In packages/opencode/src/agent/agent.ts: apply scanAndRedact() to system.transform hook (second call site)",
        "Skip scanning when security config has no rules and no segments (short-circuit)",
        "Non-protected content passes through unchanged",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Implement structural diff for messages.transform hook",
      "description": "As a security-conscious user, I want only structural changes (add/remove messages) from plugin hooks synced back, not content modifications that could pollute data with redacted values.",
      "acceptanceCriteria": [
        "In packages/opencode/src/plugin/index.ts: Plugin.trigger('experimental.chat.messages.transform') implements clone + structural diff",
        "Step 1: Deep-clone output.messages array via structuredClone()",
        "Step 2: Apply scanAndRedact() to all text content in the cloned messages",
        "Step 3: Replace output.messages with redacted clone before passing to trigger() — all plugin hooks mutate clone sequentially",
        "Step 4: After all hooks return, compute structural diff: message identity by message.info.id",
        "Added messages (IDs not in original or messages without info.id): apply to original array",
        "Removed messages (IDs in original but not in clone): remove from original array",
        "Modified content on existing messages (same ID, different content): DISCARD",
        "Reordered messages: ignored — original order preserved. Duplicate IDs: original takes precedence",
        "Skip entirely when security config has no rules and no segments",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Create plugin security audit command",
      "description": "As a security-conscious user, I want a command that scans installed plugins for dangerous API usage patterns.",
      "acceptanceCriteria": [
        "Create packages/opencode/src/plugin/audit.ts with static analysis logic",
        "Add 'opencode plugin audit <plugin-name>' CLI command in packages/opencode/src/cli/cmd/",
        "Detect dangerous APIs: fs.readFileSync, fs.readFile, Bun.file(), Bun.write(), Bun.serve(), Bun.spawn(), child_process, net, http, https",
        "Detect code injection patterns: globalThis.constructor.constructor, Function('return this'), eval(), new Function()",
        "Detect dynamic imports: import() with variable arguments, require() with variable arguments",
        "Detect hardcoded sensitive file paths: string literals containing /etc/, ~/.ssh/, .env",
        "Output risk summary with severity: critical = code injection, high = sensitive paths + dynamic imports, medium = direct API usage, low = informational",
        "Exit code 0 if no critical findings, non-zero otherwise",
        "Can run on a package name (pre-install) or installed plugin directory (post-install)",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Tests for core feature integration (Track A)",
      "description": "As a developer, I want test coverage for all core feature integrations to ensure they work correctly.",
      "acceptanceCriteria": [
        "Test: AST-grep search finds patterns correctly across multiple languages (at minimum JS and TS)",
        "Test: AST-grep replace applies transformations in dry-run mode (shows changes) and live mode (writes files)",
        "Test: LSP diagnostics returns errors/warnings for a file, respects severity filter",
        "Test: LSP prepareRename and rename operations work correctly",
        "Test: look_at tool handles image files and returns analysis, returns error for non-multimodal models",
        "Test: Context injection discovers and injects README.md from subdirectories, respects config toggle",
        "Test: Todo continuation enforcer triggers when incomplete TODOs exist after agent turn",
        "Test: Todo continuation enforcer respects max retry limit and does not trigger in plan mode",
        "Test: Comment checker detects excessive comments in generated code at each sensitivity level",
        "Test: Session recovery detects stale heartbeats and resumes interrupted sessions",
        "All tests pass with bun test",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Tests for plugin security enforcement (Track B)",
      "description": "As a developer, I want test coverage for all plugin security enforcement to ensure no regressions.",
      "acceptanceCriteria": [
        "Test: Plugin tool that reads a protected file gets output redacted",
        "Test: Plugin tool with blocked file path in args gets access denied",
        "Test: experimental.chat.messages.transform hook receives redacted messages",
        "Test: Structural diff syncs added/removed messages, discards content modifications on existing messages",
        "Test: MCP default policy is 'enforced' when security config has rules, 'trusted' when no config exists",
        "Test: Write to .opencode-security.json is blocked by implicit protection rule",
        "Test: Write to .opencode-security-audit.log is blocked by implicit protection rule",
        "Test: Plugin audit command detects dangerous API patterns and classifies severity correctly",
        "Test: hasBuiltIn() returns true for registered features and false for unknown feature IDs",
        "Test: Plugin that checks hasBuiltIn() skips tool registration when feature is built-in",
        "All tests pass with bun test",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    }
  ]
}
