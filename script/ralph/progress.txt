# Ralph Progress Log
Started: Fri 13 Feb 2026 15:15:57 CST

## Codebase Patterns
- SecurityUtil namespace in packages/opencode/src/security/util.ts is the shared module for role/redaction logic
- Tool files (read.ts, grep.ts, etc.) should import from SecurityUtil rather than defining local helpers
- Pre-existing typecheck errors in ast_grep.ts due to missing @ast-grep/napi — not related to security work
- findProtectedSegments is now in SecurityUtil — use it instead of duplicating segment-finding logic in tools
- appendImplicitRules() in config.ts auto-protects .opencode-security.json and .opencode-security-audit.log
- getMcpPolicy() falls back to 'enforced' when rules/segments exist but no mcp block — only returns 'trusted' when no security config at all
---

## 2026-02-13 - US-003
- What was implemented: Verified all acceptance criteria already met by existing implementation (commit 5f4dca313)
- Files changed: None (already committed)
  - packages/opencode/src/plugin/builtin.ts — BuiltIn namespace with Set<string> and has() function
  - packages/opencode/src/plugin/index.ts — imports BuiltIn, wires hasBuiltIn: BuiltIn.has to PluginInput
  - packages/plugin/src/index.ts — PluginInput type includes hasBuiltIn: (feature: string) => boolean
- **Learnings for future iterations:**
  - BuiltIn.has is wired directly as a function reference, not wrapped — clean pattern for namespace exports
  - Feature IDs use kebab-case (e.g., "ast-grep", "lsp-rename")
---

## 2026-02-13 - US-002
- What was implemented: Verified all acceptance criteria already met by existing implementation (commit 5f4dca313)
- Files changed: None (already committed)
  - packages/opencode/src/security/config.ts — appendImplicitRules() adds write-deny rules for .opencode-security.json and .opencode-security-audit.log
  - packages/opencode/src/security/config.ts — getMcpPolicy() returns 'enforced' when no mcp block but rules/segments exist
  - packages/opencode/src/security/config.ts — mergeSecurityConfigs() calls appendImplicitRules() on merged result
- **Learnings for future iterations:**
  - Some user stories may already be implemented in prior commits — check git log before writing new code
  - emptyConfig is shared and never mutated by appendImplicitRules (which is only called on validated.data)
  - The implicit rules mean any loaded config will always have at least 2 rules, so getMcpPolicy correctly returns 'enforced' for any config file
---

## 2026-02-13 - US-001
- What was implemented: Consolidated duplicated security utility functions into SecurityUtil namespace
- Files changed:
  - packages/opencode/src/security/util.ts — added findProtectedSegments(), import for SecuritySegments
  - packages/opencode/src/tool/read.ts — removed duplicated getRoleLevel, isRoleAllowed, findProtectedSegments; use SecurityUtil.findProtectedSegments
  - packages/opencode/src/tool/grep.ts — removed duplicated getRoleLevel, isRoleAllowed, findProtectedSegments; use SecurityUtil.findProtectedSegments
- **Learnings for future iterations:**
  - read.ts and grep.ts had identical findProtectedSegments + helper functions — always check for duplication before adding security logic to tool files
  - The local isRoleAllowed had a different signature (pre-computed roleLevel) vs SecurityUtil.isRoleAllowed (computes internally) — both functionally equivalent
  - SecurityRedact import is still needed in tool files for SecurityRedact.REDACTED_PLACEHOLDER and SecurityRedact.redactContent
---
