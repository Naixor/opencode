# Ralph Progress Log
Started: Thu  5 Feb 2026 17:57:58 CST

## Codebase Patterns
- Security modules are in `packages/opencode/src/security/` — config.ts, access.ts, role.ts, token.ts, segments.ts, redact.ts, audit.ts, bash-scanner.ts, llm-scanner.ts
- Security config schema in `schema.ts` uses Zod with namespace `SecuritySchema`
- Tool implementations with security checks: `packages/opencode/src/tool/{read,write,edit,grep,glob,bash}.ts`
- Root `.gitignore` includes `.env` — test fixture `.env` files must be `git add -f` to track
- All tools use `getDefaultRole(config)` which returns the lowest role — `SecurityRole.getCurrentRole()` exists but is not integrated into tools
- Typecheck: `bun turbo typecheck`; Tests: `bun test --cwd packages/opencode`
- Test files go in `packages/opencode/test/security/access_control_cases/`
- Config validation: `SecuritySchema.securityConfigSchema.parse()`
- Path matching uses `minimatch` library; symlinks resolved via `fs.realpathSync()`
- `loadSecurityConfig()` fail-open: invalid JSON/truncated/malformed schema → returns `emptyConfig` (no rules = all access allowed)
- `getSecurityConfig()` uses in-memory cache (`currentConfig`); deleting config file after load does NOT remove protection
- `mergeSecurityConfigs()` unions rules (additive), throws on conflicting role levels, deduplicates roles by name
- `setupSecurityConfig()` helper creates `.git` dir for `findGitRoot()` to work — required for all test setups
- `SecurityToken.verifyRoleToken()`: checks algo=RS256, signature, expiration, revocation (jti), and role claim presence
- Token without `exp` claim is accepted (non-expiring) — [KNOWN_LIMITATION] MEDIUM
- Empty string role (`""`) is falsy in JS → `!parsed.payload.role` returns true → token invalid
- Role matching is case-sensitive: `"Admin" !== "admin"` — `isKnownRole()` uses exact string match
- `SecurityRole.resetCache()` must be called in afterEach when testing getCurrentRole
- `isRoleAllowed()` uses `roleLevel > allowedRoleLevel` (strict greater-than) for hierarchy — so a role at the same level as an allowed role is NOT permitted via hierarchy, only via direct name match
- **Path checking**: `checkAccess()` does NOT normalize `../` in paths — minimatch treats them literally. Tools must call `path.normalize()` before `checkAccess()`.
- **Symlinks**: `resolveSymlink()` uses `fs.realpathSync()` which returns absolute canonical paths (e.g., `/private/var/...` on macOS). Relative glob patterns like `secrets/**` won't match absolute resolved paths — use absolute patterns for symlink protection.
- **macOS temp dirs**: `os.tmpdir()` returns `/var/folders/...` but `fs.realpathSync()` returns `/private/var/folders/...`. When creating absolute rule patterns for temp dirs, always use `fs.realpathSync()` on the dir first.
- **Null bytes**: Paths with `\x00` cause `TypeError` from `fs.lstatSync` — not caught by `resolveSymlink()`. The error prevents bypass but is not a clean security denial.
- **Circular symlinks**: `resolveSymlink()` throws `ELOOP` error — not caught. Does not hang (OS kernel limit prevents infinite loop).
- **Case sensitivity**: `minimatch` is case-sensitive by default. On macOS case-insensitive FS, `SECRETS/key.pem` bypasses `secrets/**` rule.
---

## 2026-02-05 - US-001
- Created directory structure: access_control_cases/{fixtures,unit,integration,report}
- Created base-security-config.json with roles, rules, segments, logging, auth, MCP policies
- Created protected-files fixtures: secrets/key.pem, .env, .env.production, marked-code.ts, ast-code.ts, mixed-code.ts
- Added report/ to .gitignore
- Typecheck passes
- Files changed:
  - .gitignore (added report/ ignore)
  - packages/opencode/test/security/access_control_cases/fixtures/base-security-config.json (new)
  - packages/opencode/test/security/access_control_cases/fixtures/protected-files/secrets/key.pem (new)
  - packages/opencode/test/security/access_control_cases/fixtures/protected-files/.env (new)
  - packages/opencode/test/security/access_control_cases/fixtures/protected-files/.env.production (new)
  - packages/opencode/test/security/access_control_cases/fixtures/protected-files/marked-code.ts (new)
  - packages/opencode/test/security/access_control_cases/fixtures/protected-files/ast-code.ts (new)
  - packages/opencode/test/security/access_control_cases/fixtures/protected-files/mixed-code.ts (new)
- **Learnings for future iterations:**
  - Root .gitignore has `.env` which catches ALL .env files — must `git add -f` for test fixture .env files
  - SecuritySchema.Authentication requires `revokedTokens` as required array (not optional) — include `[]` in fixtures
  - ast-code.ts functions: encryptData, decryptPayload, signToken, verifySignature (matching pattern `encrypt|decrypt|sign|verify`)
  - mixed-code.ts has both marker regions and AST-matching functions for overlapping protection tests
---

## 2026-02-05 - US-004
- Implemented CASE-CFG-001 through CASE-CFG-007 config manipulation attack test cases
- 11 tests total, all passing
- Files changed:
  - packages/opencode/test/security/access_control_cases/unit/config-manipulation.test.ts (new)
- **Learnings for future iterations:**
  - `loadSecurityConfig` returns empty config for ALL error cases (invalid JSON, truncated, malformed schema) — fail-open by design
  - In-memory config cache means file deletion after load doesn't break protection (TOCTOU is partial: load-time only)
  - `mergeSecurityConfigs` unions rules but throws on role conflicts — important for inheritance tests
  - Need `.git` directory in temp dirs for `setupSecurityConfig()` to work (findGitRoot dependency)
  - `checkAccess` returns `{ allowed: true }` when rules array is empty or undefined — consistent fail-open
  - Performance: 1000 rules with minimatch pattern checking completes well under 5s threshold
---

## 2026-02-05 - US-005
- Implemented CASE-AUTH-001 through CASE-AUTH-009 role authentication bypass test cases
- 21 tests total, all passing
- Files changed:
  - packages/opencode/test/security/access_control_cases/unit/role-authentication.test.ts (new)
- **Learnings for future iterations:**
  - [CRITICAL] All 6 tool files (read, write, edit, grep, glob, bash) use local `getDefaultRole()` which always returns the lowest role — `SecurityRole.getCurrentRole()` which checks JWT tokens is never called by tools. This means role escalation via tokens has NO effect on tool-level checks.
  - `verifyRoleToken()` does NOT reject tokens without `exp` claim — they're treated as non-expiring. [KNOWN_LIMITATION] MEDIUM severity.
  - Empty string role `""` in JWT is treated as falsy by `!parsed.payload.role` check → token rejected as missing role claim.
  - Role name matching is strictly case-sensitive in both `isKnownRole()` and `isRoleAllowed()`.
  - `isRoleAllowed()` uses strict greater-than (`roleLevel > allowedRoleLevel`) — role at same level as allowed role only gets in via direct name match, not hierarchy.
  - `Number.MAX_SAFE_INTEGER` works correctly with JS comparison operators — no overflow issues.
  - Need `SecurityRole.resetCache()` in `afterEach` when testing `getCurrentRole` — cache persists across tests otherwise.
  - Local `signJWT` helper needed in test file since helpers.ts doesn't export it — needed for custom payloads (no exp, custom jti, etc.).
---

## 2026-02-05 - US-006
- Implemented CASE-PATH-001 through CASE-PATH-010 path traversal and symlink attack test cases
- 19 tests total, all passing
- Files changed:
  - packages/opencode/test/security/access_control_cases/unit/path-traversal.test.ts (new)
- **Learnings for future iterations:**
  - [HIGH] `checkAccess()` does NOT normalize `../` segments — `public/../secrets/key.pem` bypasses `secrets/**` rule because minimatch treats `..` literally. Tools must normalize paths before calling checkAccess.
  - [HIGH] Symlink resolution via `realpathSync` returns absolute paths (e.g., `/private/var/.../secrets/key.pem`) which won't match relative rules like `secrets/**`. Symlink attacks bypass relative pattern rules.
  - [MEDIUM] Null bytes in paths cause unhandled `TypeError` from `fs.lstatSync` — prevents bypass but crashes instead of clean denial.
  - [MEDIUM] Directory symlinks: accessing `symlink-to-secrets/data.txt` may not be caught if `realpathSync` result doesn't match the protection pattern.
  - [INFO] Case sensitivity: `minimatch` is case-sensitive. `SECRETS/key.pem` is NOT matched by `secrets/**`. On macOS case-insensitive FS, this is a bypass vector.
  - [LOW] Unicode NFC vs NFD: NFC pattern does not match NFD path (macOS uses NFD for filesystem). Minor bypass vector for non-ASCII rule patterns.
  - [INFO] Absolute paths like `/project/secrets/key.pem` don't match relative rules like `secrets/**`. Tools should always pass relative paths.
  - macOS `os.tmpdir()` returns `/var/...` but `realpathSync` returns `/private/var/...` — always canonicalize temp dir paths with `fs.realpathSync()` when using them in absolute rule patterns.
  - URL-encoded paths (`%2F`, `%2e%2e`) are treated as literal strings — correct behavior since filesystem doesn't decode URLs. The risk is if tools decode URLs before calling checkAccess.
  - Circular symlinks throw `ELOOP` from `realpathSync` — error is not caught by `resolveSymlink()` but prevents hanging (OS kernel imposes limit).
---
