# Ralph Progress Log
Started: Sat 14 Feb 2026 02:05:22 CST

## Codebase Patterns
- Use `Instance.state()` with synchronous initializer for per-instance state that needs synchronous access (like Bus does); use async initializer only when lazy async loading is needed
- Hook chain uses priority-based ordering: lower priority number = runs earlier (security hooks ~10-50, transform ~100-200, output ~300-500)
- Config schema extends `Config.Info` in `packages/opencode/src/config/config.ts` with Zod validators
- Plugin.trigger() pattern: `Plugin.trigger(hookName, input, output)` where output is mutated in-place
- Test pattern: `await using tmp = await tmpdir({ git: true, config: {} })` + `Instance.provide({ directory: tmp.path, fn: async () => { ... } })`
- All tests run per-package: `bun test --cwd packages/opencode -- test/path/to/test.ts`

---

## 2026-02-14 - US-001
- Implemented hook middleware chain infrastructure in `packages/opencode/src/session/hooks/index.ts`
- Defined 4 chain types: `pre-llm`, `pre-tool`, `post-tool`, `session-lifecycle` with typed contexts
- Priority-based execution order with compile-once caching
- Error isolation: errors in one hook don't crash the chain
- Config-driven enable/disable via `hooks` section in opencode.jsonc
- Combined execution methods (`executePreLLM`, `executePreTool`, `executePostTool`) that run external plugins first, then internal middleware chain
- Added `hooks` config schema to `Config.Info` in `packages/opencode/src/config/config.ts`
- 17 unit tests all passing, 1334 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/index.ts` (new)
  - `packages/opencode/src/config/config.ts` (modified - added hooks schema)
  - `packages/opencode/test/session/hooks/hook-chain.test.ts` (new)
- **Learnings for future iterations:**
  - `Instance.state()` with async initializer returns a Promise from `state()` â€” use sync initializer for state that needs synchronous access patterns (register, compile, execute)
  - Config can be loaded asynchronously via `init()` method and applied to already-registered hooks via `reloadConfig()`
  - The `CompiledChain` generic type requires `as unknown as CompiledChain<T>` cast due to TypeScript's strict narrowing of discriminated union types in Map lookups
  - Test fixture `tmpdir({ git: true })` initializes a git repo which is required for Instance.provide to work
---
