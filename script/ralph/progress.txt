# Ralph Progress Log
Started: Thu 13 Feb 2026

## Codebase Patterns
- **Runtime:** Bun (not Node.js). Use Bun APIs like Bun.file(), Bun.write(), Bun.spawn() where applicable.
- **Code style:** No try/catch (use .catch()), no any types, no else (early returns), prefer const, single-word names, functional array methods (flatMap/filter/map over for loops), snake_case for DB schemas.
- **Tool pattern:** Tools use Tool.define() with Zod parameter schemas. See existing tools in packages/opencode/src/tool/ for the pattern.
- **Security modules:** packages/opencode/src/security/ — config.ts, access.ts, role.ts, token.ts, segments.ts, redact.ts, audit.ts, bash-scanner.ts, llm-scanner.ts
- **Plugin system:** packages/opencode/src/plugin/index.ts — Plugin.trigger() for hooks, ToolRegistry.fromPlugin() for plugin tools
- **LSP:** packages/opencode/src/lsp/ — index.ts (client), server.ts (server type selection), tool defined in packages/opencode/src/tool/lsp.ts
- **Session:** packages/opencode/src/session/ — llm.ts (LLM interaction), processor.ts (turn processing), instruction.ts (prompt construction), prompt.ts (tool resolution)
- **Typecheck:** bun turbo typecheck
- **Tests:** bun test --cwd packages/opencode
- **Install deps:** bun add <pkg> in packages/opencode/ directory
- All tools use local getDefaultRole() which returns the lowest role — SecurityRole.getCurrentRole() exists but is not integrated into tools
- SecurityAccess.checkAccess(path, operation, role) returns { allowed, reason? }
- LLMScanner.scanForProtectedContent(content, config) returns { violations: [{start, end, type}] }
- SecurityRedact.redactContent(content, segments) replaces ranges with [REDACTED: Security Protected]
- SecurityAudit.logSecurityEvent(event) logs to NDJSON audit log
- getMcpPolicy(serverName) checks config.mcp.servers[name] → defaultPolicy → "trusted"
- ToolRegistry.all() returns array of all built-in + plugin + custom tools
- ToolRegistry.fromPlugin() wraps plugin tools for registration
- Plugin.trigger(hookName, payload) fires all registered plugin hooks sequentially
- InstructionPrompt.resolve() walks UP from target file to Instance.directory
- Filesystem.findUp()/globUp() used for instruction file discovery
---
