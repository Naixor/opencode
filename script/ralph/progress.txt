# Ralph Progress Log
Started: Fri 13 Feb 2026 15:15:57 CST

## Codebase Patterns
- SecurityUtil namespace in packages/opencode/src/security/util.ts is the shared module for role/redaction logic
- Tool files (read.ts, grep.ts, etc.) should import from SecurityUtil rather than defining local helpers
- Pre-existing typecheck errors in ast_grep.ts due to missing @ast-grep/napi — not related to security work
- findProtectedSegments is now in SecurityUtil — use it instead of duplicating segment-finding logic in tools
- appendImplicitRules() in config.ts auto-protects .opencode-security.json and .opencode-security-audit.log
- getMcpPolicy() falls back to 'enforced' when rules/segments exist but no mcp block — only returns 'trusted' when no security config at all
- @ast-grep/napi must be installed (bun install) for ast_grep.ts to typecheck — it's in package.json but node_modules may be stale
- LSP.diagnostics() accepts optional { filePath, severity } — backward compatible (no params = all diagnostics)
- Both ty and pyright LSP servers now coexist — user config's `lsp` section can disable either
---

## 2026-02-13 - US-016
- What was implemented: Created CLI command for plugin audit
- Files changed:
  - packages/opencode/src/cli/cmd/plugin/audit.ts — new PluginAuditCommand using cmd() pattern
  - packages/opencode/src/cli/cmd/plugin/index.ts — PluginCommand group with audit subcommand
  - packages/opencode/src/index.ts — imported and registered PluginCommand
- **Learnings for future iterations:**
  - CLI commands use cmd() helper from cmd.ts for type-safe yargs modules
  - Subcommand groups use .demandCommand() in builder to require a subcommand
  - process.exit(1) on critical findings, 0 otherwise
---

## 2026-02-13 - US-015
- What was implemented: Switched messages.transform clone from remeda clone() to structuredClone()
- Files changed:
  - packages/opencode/src/session/prompt.ts — use structuredClone() instead of clone() for messages.transform
- **Learnings for future iterations:**
  - Structural diff was already correct: only removals and additions are synced, content mods discarded
  - structuredClone creates a truly independent deep copy (no shared references)
  - remeda clone() still used elsewhere in prompt.ts (line 636 for sessionMessages)
---

## 2026-02-13 - US-014
- What was implemented: Added scanAndRedact to text.complete and task tool.execute.after plugin hooks
- Files changed:
  - packages/opencode/src/session/processor.ts — import SecurityConfig/SecurityUtil, redact text before passing to experimental.text.complete hook
  - packages/opencode/src/session/prompt.ts — import SecurityUtil, redact task result title/output before tool.execute.after hook
- **Learnings for future iterations:**
  - SecurityUtil.scanAndRedact is the simplest way to redact — single function call, handles no-rules short-circuit
  - For object results (task tool), need to spread and redact individual string fields
  - system.transform was already handled in llm.ts and agent.ts
---

## 2026-02-13 - US-011
- What was implemented: Integrated CommentChecker.check() into edit.ts, write.ts, and apply_patch.ts
- Files changed:
  - packages/opencode/src/tool/edit.ts — import CommentChecker, call check() on contentNew before return
  - packages/opencode/src/tool/write.ts — import CommentChecker, call check() on params.content before return
  - packages/opencode/src/tool/apply_patch.ts — import CommentChecker, call check() on newContent for first non-delete change
- **Learnings for future iterations:**
  - CommentChecker.check() is async (reads Config) — use .catch(() => undefined) to prevent tool failure
  - For apply_patch, break after first advisory to avoid redundant messages
  - The advisory is appended to output string, not metadata
---

## 2026-02-13 - US-008, US-009, US-010, US-012, US-013
- What was implemented: Verified all five stories already implemented in commit 5f4dca313
- Files already in place:
  - US-008: packages/opencode/src/tool/look_at.ts — LookAtTool with security, image+PDF support
  - US-009: packages/opencode/src/session/instruction.ts — README.md discovery with experimental.readme_injection
  - US-010: packages/opencode/src/session/prompt.ts — Todo continuation enforcer with max retries, plan-mode skip
  - US-012: packages/opencode/src/session/recovery.ts — Heartbeat storage, stale detection
  - US-013: packages/opencode/src/tool/registry.ts — ToolRegistry.fromPlugin() with pre/post security wrapping
- **Learnings for future iterations:**
  - look_at returns attachments array for multimodal — framework handles model capability checks
  - Todo continuation uses a Map (continuationCounts) keyed by sessionID — not persisted across process restarts
  - PluginAudit is in plugin/audit.ts but no CLI command yet (US-016)
  - Comment checker exists in tool/comment_checker.ts but not integrated into write tools (US-011)
---

## 2026-02-13 - US-007
- What was implemented: Verified prepareRename and rename already implemented (commit 5f4dca313)
- Files changed: None
  - packages/opencode/src/tool/lsp.ts — operations union includes prepareRename, rename; newName param
  - packages/opencode/src/lsp/index.ts — LSP.prepareRename() and LSP.rename() methods
- **Learnings for future iterations:**
  - LSP rename returns WorkspaceEdit (JSON) — currently tool returns it raw, doesn't write files
  - All LSP position-based operations use 0-based indexing (tool converts from 1-based user input)
---

## 2026-02-13 - US-006
- What was implemented: Removed OPENCODE_EXPERIMENTAL_LSP_TY flag; added filePath/severity params to LSP.diagnostics()
- Files changed:
  - packages/opencode/src/flag/flag.ts — removed OPENCODE_EXPERIMENTAL_LSP_TY definition
  - packages/opencode/src/lsp/index.ts — removed Flag import and ty/pyright conditional logic; added optional params to diagnostics()
  - packages/opencode/src/lsp/server.ts — removed flag gate from Ty.spawn()
- **Learnings for future iterations:**
  - OPENCODE_EXPERIMENTAL_LSP_TOOL was never implemented — the LspTool was already unconditionally available
  - The diagnostics operation was already in the LspTool discriminated union; severity filtering was at tool layer, not library
  - pathToFileURL is used to match diagnostic keys which may be file:// URIs
---

## 2026-02-13 - US-004 & US-005
- What was implemented: Verified both ast_grep_search and ast_grep_replace already implemented. Fixed typecheck by running bun install for @ast-grep/napi.
- Files changed: None (already committed in 5f4dca313)
  - packages/opencode/src/tool/ast_grep.ts — AstGrepSearchTool (findInFiles) and AstGrepReplaceTool (parse+findAll+commitEdits)
  - packages/opencode/src/tool/registry.ts — both tools registered
- **Learnings for future iterations:**
  - @ast-grep/napi uses native bindings — `bun install` is required after clone/checkout
  - findInFiles callback signature is (err, nodes) — both params need type annotations
  - node.replace(rewritePattern) directly resolves meta-variables — no manual getMatch needed
  - The globs parameter is defined but not forwarded to findInFiles — could be enhanced later
---

## 2026-02-13 - US-003
- What was implemented: Verified all acceptance criteria already met by existing implementation (commit 5f4dca313)
- Files changed: None (already committed)
  - packages/opencode/src/plugin/builtin.ts — BuiltIn namespace with Set<string> and has() function
  - packages/opencode/src/plugin/index.ts — imports BuiltIn, wires hasBuiltIn: BuiltIn.has to PluginInput
  - packages/plugin/src/index.ts — PluginInput type includes hasBuiltIn: (feature: string) => boolean
- **Learnings for future iterations:**
  - BuiltIn.has is wired directly as a function reference, not wrapped — clean pattern for namespace exports
  - Feature IDs use kebab-case (e.g., "ast-grep", "lsp-rename")
---

## 2026-02-13 - US-002
- What was implemented: Verified all acceptance criteria already met by existing implementation (commit 5f4dca313)
- Files changed: None (already committed)
  - packages/opencode/src/security/config.ts — appendImplicitRules() adds write-deny rules for .opencode-security.json and .opencode-security-audit.log
  - packages/opencode/src/security/config.ts — getMcpPolicy() returns 'enforced' when no mcp block but rules/segments exist
  - packages/opencode/src/security/config.ts — mergeSecurityConfigs() calls appendImplicitRules() on merged result
- **Learnings for future iterations:**
  - Some user stories may already be implemented in prior commits — check git log before writing new code
  - emptyConfig is shared and never mutated by appendImplicitRules (which is only called on validated.data)
  - The implicit rules mean any loaded config will always have at least 2 rules, so getMcpPolicy correctly returns 'enforced' for any config file
---

## 2026-02-13 - US-001
- What was implemented: Consolidated duplicated security utility functions into SecurityUtil namespace
- Files changed:
  - packages/opencode/src/security/util.ts — added findProtectedSegments(), import for SecuritySegments
  - packages/opencode/src/tool/read.ts — removed duplicated getRoleLevel, isRoleAllowed, findProtectedSegments; use SecurityUtil.findProtectedSegments
  - packages/opencode/src/tool/grep.ts — removed duplicated getRoleLevel, isRoleAllowed, findProtectedSegments; use SecurityUtil.findProtectedSegments
- **Learnings for future iterations:**
  - read.ts and grep.ts had identical findProtectedSegments + helper functions — always check for duplication before adding security logic to tool files
  - The local isRoleAllowed had a different signature (pre-computed roleLevel) vs SecurityUtil.isRoleAllowed (computes internally) — both functionally equivalent
  - SecurityRedact import is still needed in tool files for SecurityRedact.REDACTED_PLACEHOLDER and SecurityRedact.redactContent
---
