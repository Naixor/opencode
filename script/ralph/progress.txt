# Ralph Progress Log
Started: Thu  5 Feb 2026 17:57:58 CST

## Codebase Patterns
- Security modules are in `packages/opencode/src/security/` — config.ts, access.ts, role.ts, token.ts, segments.ts, redact.ts, audit.ts, bash-scanner.ts, llm-scanner.ts
- Security config schema in `schema.ts` uses Zod with namespace `SecuritySchema`
- Tool implementations with security checks: `packages/opencode/src/tool/{read,write,edit,grep,glob,bash}.ts`
- Root `.gitignore` includes `.env` — test fixture `.env` files must be `git add -f` to track
- All tools use `getDefaultRole(config)` which returns the lowest role — `SecurityRole.getCurrentRole()` exists but is not integrated into tools
- Typecheck: `bun turbo typecheck`; Tests: `bun test --cwd packages/opencode`
- Test files go in `packages/opencode/test/security/access_control_cases/`
- Config validation: `SecuritySchema.securityConfigSchema.parse()`
- Path matching uses `minimatch` library; symlinks resolved via `fs.realpathSync()`
- `loadSecurityConfig()` fail-open: invalid JSON/truncated/malformed schema → returns `emptyConfig` (no rules = all access allowed)
- `getSecurityConfig()` uses in-memory cache (`currentConfig`); deleting config file after load does NOT remove protection
- `mergeSecurityConfigs()` unions rules (additive), throws on conflicting role levels, deduplicates roles by name
- `setupSecurityConfig()` helper creates `.git` dir for `findGitRoot()` to work — required for all test setups
- `SecurityToken.verifyRoleToken()`: checks algo=RS256, signature, expiration, revocation (jti), and role claim presence
- Token without `exp` claim is accepted (non-expiring) — [KNOWN_LIMITATION] MEDIUM
- Empty string role (`""`) is falsy in JS → `!parsed.payload.role` returns true → token invalid
- Role matching is case-sensitive: `"Admin" !== "admin"` — `isKnownRole()` uses exact string match
- `SecurityRole.resetCache()` must be called in afterEach when testing getCurrentRole
- `isRoleAllowed()` uses `roleLevel > allowedRoleLevel` (strict greater-than) for hierarchy — so a role at the same level as an allowed role is NOT permitted via hierarchy, only via direct name match
---

## 2026-02-05 - US-001
- Created directory structure: access_control_cases/{fixtures,unit,integration,report}
- Created base-security-config.json with roles, rules, segments, logging, auth, MCP policies
- Created protected-files fixtures: secrets/key.pem, .env, .env.production, marked-code.ts, ast-code.ts, mixed-code.ts
- Added report/ to .gitignore
- Typecheck passes
- Files changed:
  - .gitignore (added report/ ignore)
  - packages/opencode/test/security/access_control_cases/fixtures/base-security-config.json (new)
  - packages/opencode/test/security/access_control_cases/fixtures/protected-files/secrets/key.pem (new)
  - packages/opencode/test/security/access_control_cases/fixtures/protected-files/.env (new)
  - packages/opencode/test/security/access_control_cases/fixtures/protected-files/.env.production (new)
  - packages/opencode/test/security/access_control_cases/fixtures/protected-files/marked-code.ts (new)
  - packages/opencode/test/security/access_control_cases/fixtures/protected-files/ast-code.ts (new)
  - packages/opencode/test/security/access_control_cases/fixtures/protected-files/mixed-code.ts (new)
- **Learnings for future iterations:**
  - Root .gitignore has `.env` which catches ALL .env files — must `git add -f` for test fixture .env files
  - SecuritySchema.Authentication requires `revokedTokens` as required array (not optional) — include `[]` in fixtures
  - ast-code.ts functions: encryptData, decryptPayload, signToken, verifySignature (matching pattern `encrypt|decrypt|sign|verify`)
  - mixed-code.ts has both marker regions and AST-matching functions for overlapping protection tests
---

## 2026-02-05 - US-004
- Implemented CASE-CFG-001 through CASE-CFG-007 config manipulation attack test cases
- 11 tests total, all passing
- Files changed:
  - packages/opencode/test/security/access_control_cases/unit/config-manipulation.test.ts (new)
- **Learnings for future iterations:**
  - `loadSecurityConfig` returns empty config for ALL error cases (invalid JSON, truncated, malformed schema) — fail-open by design
  - In-memory config cache means file deletion after load doesn't break protection (TOCTOU is partial: load-time only)
  - `mergeSecurityConfigs` unions rules but throws on role conflicts — important for inheritance tests
  - Need `.git` directory in temp dirs for `setupSecurityConfig()` to work (findGitRoot dependency)
  - `checkAccess` returns `{ allowed: true }` when rules array is empty or undefined — consistent fail-open
  - Performance: 1000 rules with minimatch pattern checking completes well under 5s threshold
---

## 2026-02-05 - US-005
- Implemented CASE-AUTH-001 through CASE-AUTH-009 role authentication bypass test cases
- 21 tests total, all passing
- Files changed:
  - packages/opencode/test/security/access_control_cases/unit/role-authentication.test.ts (new)
- **Learnings for future iterations:**
  - [CRITICAL] All 6 tool files (read, write, edit, grep, glob, bash) use local `getDefaultRole()` which always returns the lowest role — `SecurityRole.getCurrentRole()` which checks JWT tokens is never called by tools. This means role escalation via tokens has NO effect on tool-level checks.
  - `verifyRoleToken()` does NOT reject tokens without `exp` claim — they're treated as non-expiring. [KNOWN_LIMITATION] MEDIUM severity.
  - Empty string role `""` in JWT is treated as falsy by `!parsed.payload.role` check → token rejected as missing role claim.
  - Role name matching is strictly case-sensitive in both `isKnownRole()` and `isRoleAllowed()`.
  - `isRoleAllowed()` uses strict greater-than (`roleLevel > allowedRoleLevel`) — role at same level as allowed role only gets in via direct name match, not hierarchy.
  - `Number.MAX_SAFE_INTEGER` works correctly with JS comparison operators — no overflow issues.
  - Need `SecurityRole.resetCache()` in `afterEach` when testing `getCurrentRole` — cache persists across tests otherwise.
  - Local `signJWT` helper needed in test file since helpers.ts doesn't export it — needed for custom payloads (no exp, custom jti, etc.).
---
