# Ralph Progress Log
Started: Sat 14 Feb 2026 02:05:22 CST

## Codebase Patterns
- Use `Instance.state()` with synchronous initializer for per-instance state that needs synchronous access (like Bus does); use async initializer only when lazy async loading is needed
- Hook chain uses priority-based ordering: lower priority number = runs earlier (security hooks ~10-50, transform ~100-200, output ~300-500)
- Config schema extends `Config.Info` in `packages/opencode/src/config/config.ts` with Zod validators
- Plugin.trigger() pattern: `Plugin.trigger(hookName, input, output)` where output is mutated in-place
- Test pattern: `await using tmp = await tmpdir({ git: true, config: {} })` + `Instance.provide({ directory: tmp.path, fn: async () => { ... } })`
- All tests run per-package: `bun test --cwd packages/opencode -- test/path/to/test.ts`
- Error recovery hooks pattern: register all hooks in a `register()` function, expose `resetErrorHistory()` for testing, use `ErrorRecoveryHooks.register()` in test setup
- Hook modules follow namespace pattern with `register()` + `reset*()` exports for registration and test cleanup
- In TypeScript namespaces, use `export function` directly — `export { name }` re-export syntax is NOT valid inside namespaces
- Context window estimation uses ~4 chars per token as rough heuristic; model context windows are looked up by name pattern matching
- Security markers in `.opencode-security.json` use plain text (e.g., `@security-start`), NOT comment-prefixed (NOT `// @security-start`) — `buildMarkerPatterns()` adds comment prefixes automatically
- Security rules require `allowedRoles: []` field (Zod validates); missing it causes config to fall back to empty/permissive
- Per-session caching pattern: use Maps keyed by `ctx.sessionID`, expose `resetCaches()` for test isolation
- `SessionStatus.list()` returns `Record<string, Info>` with only non-idle sessions; idle sessions are deleted from state on `SessionStatus.set(id, { type: "idle" })`
- For test observability of fire-and-forget operations (e.g., notifications), use internal log arrays + getter/reset exports instead of mocking `Bun.spawn`
- `PreLLMContext.providerOptions` is the channel for hooks to set provider-specific LLM parameters (thinking, effort, etc.) — guard on model name to avoid incompatible settings
- Agents are registered in a `Record<string, Info>` in `Instance.state()` — insertion order determines `defaultAgent()` fallback (first primary non-hidden agent wins)
- Agent prompts are `.txt` files imported via Bun's text loader: `import PROMPT from "./prompt/file.txt"`
- Config schema agent section has explicit fields for known agents + `.catchall(Agent)` — add new native agents to explicit fields
- New subagent agents automatically appear in Sisyphus delegation table via dynamic `buildAgentsTable()` — no manual update needed
- Search-only agents use `"*": "deny"` then explicit `"allow"` for each permitted tool
- Optional (opt-in) agents: defined in `packages/opencode/src/agent/optional/index.ts`, enabled via `agent.<name>.enabled: true` in config. `replaces` field allows swapping existing agent slots (e.g., prometheus -> plan)

---

## 2026-02-14 - US-001
- Implemented hook middleware chain infrastructure in `packages/opencode/src/session/hooks/index.ts`
- Defined 4 chain types: `pre-llm`, `pre-tool`, `post-tool`, `session-lifecycle` with typed contexts
- Priority-based execution order with compile-once caching
- Error isolation: errors in one hook don't crash the chain
- Config-driven enable/disable via `hooks` section in opencode.jsonc
- Combined execution methods (`executePreLLM`, `executePreTool`, `executePostTool`) that run external plugins first, then internal middleware chain
- Added `hooks` config schema to `Config.Info` in `packages/opencode/src/config/config.ts`
- 17 unit tests all passing, 1334 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/index.ts` (new)
  - `packages/opencode/src/config/config.ts` (modified - added hooks schema)
  - `packages/opencode/test/session/hooks/hook-chain.test.ts` (new)
- **Learnings for future iterations:**
  - `Instance.state()` with async initializer returns a Promise from `state()` — use sync initializer for state that needs synchronous access patterns (register, compile, execute)
  - Config can be loaded asynchronously via `init()` method and applied to already-registered hooks via `reloadConfig()`
  - The `CompiledChain` generic type requires `as unknown as CompiledChain<T>` cast due to TypeScript's strict narrowing of discriminated union types in Map lookups
  - Test fixture `tmpdir({ git: true })` initializes a git repo which is required for Instance.provide to work
---

## 2026-02-14 - US-002
- Implemented 4 error recovery hooks in `packages/opencode/src/session/hooks/error-recovery.ts`
  - `edit-error-recovery` (PostToolChain, priority 100): detects "oldString not found", "Found multiple matches", "oldString and newString must be different" and injects recovery guidance
  - `context-window-limit-recovery` (SessionLifecycleChain, priority 10): detects context_window_exceeded errors and signals compaction via ctx.data.recovery
  - `delegate-task-retry` (PostToolChain, priority 200): detects delegate_task/task failures, suggests retry with exponential backoff (1s, 2s), exhaustion message after 1 retry
  - `iterative-error-recovery` (PostToolChain, priority 300): tracks error patterns per session, injects corrective guidance after 3+ identical errors
- Added error recovery hook invocation point at processor.ts line 345 (after error conversion, before SessionRetry.retryable check)
- All hooks individually toggleable via config (reloadConfig with { "hook-name": { enabled: false } })
- 18 unit tests all passing, 1352 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/error-recovery.ts` (new)
  - `packages/opencode/src/session/processor.ts` (modified - added HookChain import and error hook invocation)
  - `packages/opencode/test/session/hooks/error-recovery.test.ts` (new)
- **Learnings for future iterations:**
  - Error recovery hooks modify `ctx.result.output` by appending recovery messages, keeping original output intact
  - `iterative-error-recovery` uses a session-scoped Map to track error patterns; call `resetErrorHistory()` in tests to avoid cross-test contamination
  - PostToolContext's `result.metadata` can be used to pass state between hook invocations (e.g., retryCount for delegate-task-retry)
  - The processor.ts error handler uses `.catch(() => {})` on hook execution to ensure hook failures never block error handling flow
  - Error detection uses string matching on tool output (includes-based), not structured error types, since tool outputs are plain strings
---

## 2026-02-14 - US-003
- Implemented 5 output management hooks in `packages/opencode/src/session/hooks/output-management.ts`
  - `tool-output-truncator` (PostToolChain, priority 50): truncates ALL tool outputs to 50KB max, preserves [REDACTED: Security Protected] markers
  - `grep-output-truncator` (PostToolChain, priority 60): grep-specific truncation showing 50 of N matches
  - `question-label-truncator` (PostToolChain, priority 70): truncates UI question labels to 200 chars with '...'
  - `context-window-monitor` (PreLLMChain, priority 900): warns when context window >80% full, configurable threshold
  - `preemptive-compaction` (PreLLMChain, priority 910): triggers compaction when context >90% full, sets variant='compact'
- Streaming truncation support for 10MB+ outputs (read first N bytes + tail message)
- Each hook individually toggleable via config
- Configurable thresholds via `configureThresholds()` API
- 23 unit tests all passing, 1375 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/output-management.ts` (new)
  - `packages/opencode/test/session/hooks/output-management.test.ts` (new)
- **Learnings for future iterations:**
  - In TypeScript namespaces, `export { name }` re-export syntax causes SyntaxError — must use `export function` directly on the declaration
  - Security marker preservation during truncation requires scanning for markers beyond the truncation boundary and appending them to the truncated output
  - Context window usage estimation: system prompt text + JSON-serialized messages, divided by 4 chars per token, compared against model-specific context windows
  - PreLLMContext.variant can be set by hooks to signal downstream behavior (e.g., 'compact' triggers compaction)
  - The context-window-monitor checks ratio < compactionThreshold to avoid warning when compaction is about to fire (avoids duplicate warnings)
---

## 2026-02-14 - US-004
- Implemented 5 context injection hooks in `packages/opencode/src/session/hooks/context-injection.ts`
  - `directory-agents-injector` (PreLLMChain, priority 100): scans for AGENTS.md in project root and `.opencode/`, injects into system prompt with per-session caching
  - `directory-readme-injector` (PreLLMChain, priority 110): injects README.md only for first message or when working directory changes
  - `rules-injector` (PreLLMChain, priority 120): injects custom rules from `.opencode/rules/*.md` and `.claude/rules/*.md`
  - `compaction-context-injector` (SessionLifecycleChain, priority 100): extracts file references and decisions from pre-compaction messages, preserves as compaction context
  - `compaction-todo-preserver` (SessionLifecycleChain, priority 110): extracts incomplete todos (markdown checkboxes, TODO/FIXME comments) and re-injects post-compaction
- SecurityAccess.checkAccess(filePath, 'read') + checkAccess(filePath, 'llm') enforced before all injections
- LLM scanner applied to injected content — protected segments redacted via SecurityRedact
- Per-session caching: AGENTS.md, README.md, and rules files cached per session ID
- Each hook individually toggleable via config
- 26 unit tests all passing, 1401 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/context-injection.ts` (new)
  - `packages/opencode/test/session/hooks/context-injection.test.ts` (new)
  - `script/ralph/prd.json` (modified - US-004 passes: true)
  - `script/ralph/progress.txt` (modified - appended progress)
- **Learnings for future iterations:**
  - Security markers in `.opencode-security.json` use plain marker text (e.g., `@security-start`), NOT comment-prefixed — `buildMarkerPatterns()` in `segments.ts` adds `//`, `#`, `<!-- -->`, etc. prefixes automatically
  - Security config rules require `allowedRoles: []` field — Zod validation rejects configs without it, causing fallback to empty (permissive) config
  - The `tmpdir()` fixture `init` callback runs before `Instance.provide()` — write test files here; load security configs inside the `fn` callback where Instance context is available
  - Per-session cache maps using `sessionID` as key allow testing cache hit/miss behavior; expose `getXxxCache()` methods for test assertions
  - `Bun.Glob.scan()` with `cwd` pointing to non-existent directory throws — wrap in try/catch to gracefully skip missing rule dirs
---

## 2026-02-14 - US-005
- Implemented 4 detection/checking hooks in `packages/opencode/src/session/hooks/detection-checking.ts`
  - `keyword-detector` (PreLLMChain, priority 200): detects mode keywords ([ultrawork]/ulw -> 'max', [analyze-mode] -> 'analyze', [review-mode] -> 'review') in last user message, sets ctx.variant
  - `comment-checker` (PostToolChain, priority 400): after edit/write tool success, calculates comment line ratio in new_string/content; warns if >40% (configurable threshold)
  - `empty-task-response-detector` (PostToolChain, priority 350): detects empty/minimal (<10 chars) responses from delegate_task/task, injects warning
  - `write-existing-file-guard` (PreToolChain, priority 200): checks if write tool targets existing file via `Bun.file().exists()`, injects warning into args._warning
- Each hook individually toggleable via config
- 23 unit tests all passing, 1424 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/detection-checking.ts` (new)
  - `packages/opencode/test/session/hooks/detection-checking.test.ts` (new)
- **Learnings for future iterations:**
  - PreToolChain hooks run before tool execution so there's no output to modify — use `ctx.args._warning` to inject warnings that the tool/agent can read
  - `getLastUserMessage()` helper iterates messages backwards to find the most recent user message, supporting both string and multipart content formats
  - Comment detection uses simple prefix matching (// # /* * <!-- --) which covers most languages; a more sophisticated approach would use language-specific comment patterns
  - `Bun.file().exists()` is async and works with absolute paths; test fixtures should use `fs.writeFileSync()` to create test files before checking existence
  - The `withInstance` helper can pass `tmpPath` to test functions that need to create files on disk (e.g., for write-existing-file-guard)
---

## 2026-02-14 - US-006
- Implemented 3 agent enforcement hooks in `packages/opencode/src/session/hooks/agent-enforcement.ts`
  - `stop-continuation-guard` (SessionLifecycleChain, priority 190): detects explicit user stop signal (`data.userStop=true`) on `agent.stopped` event, records stop signal per session to prevent todo-continuation-enforcer from triggering
  - `todo-continuation-enforcer` (SessionLifecycleChain, priority 200): on `agent.stopped` event, checks for incomplete todos via `Todo.get()`, injects continuation prompt with count and list of incomplete tasks. Respects stop signals from stop-continuation-guard
  - `subagent-question-blocker` (PreToolChain, priority 100): blocks `question` tool calls when `_isSubagent=true` in args, sets `_blocked` and `_blockedMessage` on args
- Each hook individually toggleable via config
- Priority ordering ensures stop-continuation-guard (190) runs before todo-continuation-enforcer (200)
- 13 unit tests all passing, 1437 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/agent-enforcement.ts` (new)
  - `packages/opencode/test/session/hooks/agent-enforcement.test.ts` (new)
  - `script/ralph/prd.json` (modified - US-006 passes: true)
  - `script/ralph/progress.txt` (modified - appended progress)
- **Learnings for future iterations:**
  - `Todo.get(sessionID)` returns todos stored via `Storage.read()` — works within Instance.provide context; returns empty array if no todos exist for session
  - `Todo.update()` writes todos to storage AND publishes `Todo.Event.Updated` bus event — useful for testing todo-dependent hooks
  - Stop signal pattern: use a per-session Map to communicate between hooks in the same chain execution; stop-continuation-guard (priority 190) sets the signal, todo-continuation-enforcer (priority 200) reads it
  - Subagent detection via `_isSubagent` arg flag allows callers to mark subagent context; alternative approach would be looking up Agent.Info.mode but that requires async agent resolution
  - The `withInstance` helper for these tests doesn't need `tmpPath` since all state is session-based (via Storage), not file-based
---

## 2026-02-14 - US-007
- Implemented 3 session lifecycle hooks in `packages/opencode/src/session/hooks/session-lifecycle.ts`
  - `session-recovery` (SessionLifecycleChain, priority 10): on `session.created` event, checks `SessionStatus.list()` for sessions stuck in 'busy' status, injects recovery message with stuck session IDs
  - `session-notification` (SessionLifecycleChain, priority 300): on `agent.stopped` event, sends platform-native notification (macOS osascript, Linux notify-send). Configurable via `configureNotification({ enabled, sound })`
  - `unstable-agent-babysitter` (SessionLifecycleChain, priority 250): tracks consecutive `agent.error` events per agent per session, injects diagnostic guidance after 3+ consecutive failures. Counter resets on `agent.stopped` (success)
- All hooks individually toggleable via config (HookChain.reloadConfig)
- 15 unit tests all passing, 135 existing hook tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/session-lifecycle.ts` (new)
  - `packages/opencode/test/session/hooks/session-lifecycle.test.ts` (new)
  - `script/ralph/prd.json` (modified - US-007 passes: true)
  - `script/ralph/progress.txt` (modified - appended progress)
- **Learnings for future iterations:**
  - `SessionStatus.list()` returns `Record<string, SessionStatus.Info>` — only sessions with non-idle status are stored (idle sessions are deleted from state via `SessionStatus.set()`)
  - `SessionStatus.set(id, { type: "busy" })` can be used in tests to simulate stuck sessions without needing actual LLM processing
  - Platform notifications use `Bun.spawn()` with `stdout: "ignore", stderr: "ignore"` to fire-and-forget; `.exited.catch(() => {})` prevents unhandled promise rejections
  - The notification log pattern (internal array tracking sent notifications) provides test observability without mocking `Bun.spawn` — track `{ platform, title, message }` entries
  - Failure counter pattern: per-session Map<agent, count> allows tracking per-agent failures independently; success events reset only the specific agent's counter
---

## 2026-02-14 - US-008
- Implemented 2 LLM parameter hooks in `packages/opencode/src/session/hooks/llm-parameters.ts`
  - `think-mode` (PreLLMChain, priority 50): sets Claude thinking parameter based on variant. 'max' -> budgetTokens: 32000, 'quick' -> thinking disabled, other variants -> default 16000. Only applies to Claude models
  - `anthropic-effort` (PreLLMChain, priority 60): sets Anthropic effort level based on variant. 'max' -> 'high', 'quick' -> 'low', other variants -> 'medium'. Only applies to Claude models
- Added `providerOptions` field to `PreLLMContext` schema (z.record(z.string(), z.any()).optional()) for hooks to set provider-specific LLM parameters
- Both hooks individually toggleable via config
- 13 unit tests all passing, 1465 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/llm-parameters.ts` (new)
  - `packages/opencode/src/session/hooks/index.ts` (modified - added providerOptions to PreLLMContext)
  - `packages/opencode/test/session/hooks/llm-parameters.test.ts` (new)
  - `script/ralph/prd.json` (modified - US-008 passes: true)
  - `script/ralph/progress.txt` (modified - appended progress)
- **Learnings for future iterations:**
  - `PreLLMContext.providerOptions` is the channel for hooks to communicate provider-specific LLM parameters (thinking budget, effort level, etc.) downstream
  - LLM parameter hooks should guard on model name (e.g., `ctx.model.includes("claude")`) to avoid setting provider-specific options for incompatible models
  - The `variant` field flows through: user message -> keyword-detector hook -> think-mode/anthropic-effort hooks, creating a clean pipeline for mode-based parameter control
  - Think-mode and anthropic-effort hooks share the same `providerOptions` object via `ctx.providerOptions = ctx.providerOptions ?? {}` pattern — order matters (priority 50 before 60)
---

## 2026-02-14 - US-009
- Implemented Sisyphus agent as default primary agent
  - Created `packages/opencode/src/agent/sisyphus.ts` with `Sisyphus.buildDynamicPrompt()` dynamic prompt builder
  - Created `packages/opencode/src/agent/prompt/sisyphus.txt` with orchestration-focused system prompt
  - Registered sisyphus in agent registry as first entry (before build) — makes it the default agent
  - Sisyphus: mode=primary, temperature=0.1, full tool access, question+plan_enter allowed
  - Dynamic prompt builder injects: agents table (subagent/all mode agents), skills list, categories (future US-030)
  - Build agent kept accessible with explicit name, description updated to "Full-access builder agent"
  - Updated `Agent.list()` sort to use sisyphus as default sort key
  - Updated Config schema to include sisyphus in agent config object
  - Updated 3 existing tests: defaultAgent now returns "sisyphus", disabled-all-primary test includes sisyphus
- 10 new unit tests + 35 existing agent tests all passing, 1475 total tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/sisyphus.ts` (new)
  - `packages/opencode/src/agent/prompt/sisyphus.txt` (new)
  - `packages/opencode/src/agent/agent.ts` (modified - added sisyphus, updated list sort)
  - `packages/opencode/src/config/config.ts` (modified - added sisyphus to agent config schema)
  - `packages/opencode/test/agent/agent.test.ts` (modified - updated default agent tests)
  - `packages/opencode/test/agent/sisyphus.test.ts` (new)
- **Learnings for future iterations:**
  - Agents are registered in a `Record<string, Info>` inside `Instance.state()` — insertion order matters for `Object.values().find()` in `defaultAgent()` fallback
  - `defaultAgent()` returns the first primary non-hidden agent when no `default_agent` config is set — putting sisyphus first in the record makes it the default
  - Agent prompts are imported as `.txt` files using Bun's text loader — just `import PROMPT from "./prompt/file.txt"`
  - Categories config field doesn't exist yet (US-030) — access via `(cfg as Record<string, unknown>).categories` for forward compatibility
  - The `Agent.list()` sort uses the default agent name for sorting — update this when changing the default agent
  - Config schema's agent object has explicit fields for known agents plus `.catchall()` — new native agents should be added to the explicit fields
---

## 2026-02-14 - US-010
- Implemented omo-explore agent as a Sisyphus sub-agent for advanced codebase exploration
  - Created `packages/opencode/src/agent/prompt/omo-explore.txt` with parallel execution strategy and tool priority (LSP > ast_grep > grep > glob > git)
  - Registered `omo-explore` in agent registry in `agent.ts` as subagent mode with search-only permissions
  - Tool restrictions: DENIED write, edit, task, delegate_task; ALLOWED grep, glob, read, lsp, ast_grep_search, bash, webfetch, websearch, codesearch
  - Added `omo-explore` to config schema explicit fields in `config.ts`
  - Sisyphus delegation table automatically picks up omo-explore via dynamic `buildAgentsTable()` filter on mode=subagent
  - Original explore agent completely unchanged (same prompt, same tools, same permissions)
- Updated existing `agent.test.ts` to include `omo-explore` in default agents list assertion
- 8 new unit tests all passing, 1483 total tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/prompt/omo-explore.txt` (new)
  - `packages/opencode/src/agent/agent.ts` (modified - added omo-explore import and registration)
  - `packages/opencode/src/config/config.ts` (modified - added omo-explore to agent config schema)
  - `packages/opencode/test/agent/omo-explore.test.ts` (new)
  - `packages/opencode/test/agent/agent.test.ts` (modified - added omo-explore to default agents assertion)
- **Learnings for future iterations:**
  - New subagent agents are automatically included in Sisyphus delegation table — `buildAgentsTable()` dynamically filters agents with `mode === "subagent" || mode === "all"`
  - Agent names with hyphens (e.g., "omo-explore") work as record keys in JS and as config keys in JSONC — use quoted string keys in Zod schema definitions
  - The `"*": "deny"` permission rule denies all tools by default; subsequent explicit `"allow"` rules override for specific tools — this is the pattern for search-only agents
  - Agent registration doesn't require a separate module file — simpler agents can be defined inline in `agent.ts` alongside existing agents
---

## 2026-02-14 - US-011
- Implemented Oracle agent as strategic advisor subagent
  - Created `packages/opencode/src/agent/prompt/oracle.txt` with pragmatic minimalism philosophy, effort estimation (Quick/Short/Medium/Large), and bottom-line response format
  - Registered `oracle` in agent registry in `agent.ts` as subagent mode with search-only permissions
  - Tool restrictions: DENIED write, edit, task, delegate_task; ALLOWED read, grep, glob, lsp, bash, webfetch, websearch, codesearch
  - Temperature: 0.1 for precise, deterministic analysis
  - Added `oracle` to config schema explicit fields in `config.ts`
  - Sisyphus delegation table automatically picks up oracle via dynamic `buildAgentsTable()`
- Updated existing `agent.test.ts` to include `oracle` in default agents list assertion
- 6 new unit tests all passing, 59 total agent tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/prompt/oracle.txt` (new)
  - `packages/opencode/src/agent/agent.ts` (modified - added oracle import and registration)
  - `packages/opencode/src/config/config.ts` (modified - added oracle to agent config schema)
  - `packages/opencode/test/agent/oracle.test.ts` (new)
  - `packages/opencode/test/agent/agent.test.ts` (modified - added oracle to default agents assertion)
- **Learnings for future iterations:**
  - Oracle follows the exact same pattern as omo-explore: search-only subagent with `"*": "deny"` + explicit allows
  - Adding a new native subagent requires 4 changes: prompt .txt file, agent definition in agent.ts, config schema field in config.ts, and updating the default agents list test
  - The thinking budget (32k for Claude models) is handled by the think-mode hook (US-008) based on variant, not by the agent definition itself — agent just sets temperature
  - Simple agents that don't need dynamic prompt building can be defined inline in agent.ts without a separate module file (unlike Sisyphus which has sisyphus.ts for buildDynamicPrompt)
---

## 2026-02-14 - US-012
- Implemented opt-in agent infrastructure and two optional agents: Hephaestus and Prometheus
  - Created `packages/opencode/src/agent/optional/index.ts` with `OptionalAgents` namespace for resolving opt-in agents
  - Created `packages/opencode/src/agent/prompt/hephaestus.txt` — full-access builder agent prompt
  - Created `packages/opencode/src/agent/prompt/prometheus.txt` — strategic planning agent prompt with plan_exit integration
  - Hephaestus: subagent mode, full tool access, enabled via `agent.hephaestus.enabled: true`
  - Prometheus: primary mode, read-only (replaces plan agent when enabled), same edit restrictions as plan (only plan files)
  - Per-agent config: model, temperature, prompt_append all supported through config overrides
- Integration into agent.ts:
  - Optional agents resolved before the main config merge loop
  - Optional agent config entries skipped in main loop to prevent double-processing
  - Replacement mechanism: prometheus replaces "plan" key in registry, so plan_enter/plan_exit tools continue working
  - Per-agent overrides (model, temperature, prompt_append) applied after optional resolution
- Added `hephaestus` and `prometheus` to Config.Agent schema explicit fields in config.ts
- 9 new unit tests all passing, 1498 total tests pass (+ 1 skip)
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/optional/index.ts` (new)
  - `packages/opencode/src/agent/prompt/hephaestus.txt` (new)
  - `packages/opencode/src/agent/prompt/prometheus.txt` (new)
  - `packages/opencode/src/agent/agent.ts` (modified — added OptionalAgents import and integration)
  - `packages/opencode/src/config/config.ts` (modified — added hephaestus, prometheus to agent config schema)
  - `packages/opencode/test/agent/optional-agents.test.ts` (new)
- **Learnings for future iterations:**
  - Optional agents use `options.enabled === true` to detect opt-in — the `enabled` field flows through Config.Agent's `.catchall(z.any())` into `options`
  - The `replaces` field in OptionalAgentDef allows an optional agent to take over an existing agent slot (e.g., prometheus -> plan) without changing any tool references
  - Optional agent config entries must be skipped in the main config merge loop to prevent them from being treated as custom agents with `native: false`
  - `prompt_append` is read from `options.prompt_append` since it's an unknown field that gets swept into options by the transform
  - The per-agent override logic for optional agents is separate from the main loop — first resolve the optional agents, then apply config overrides like model/temperature/prompt_append
---

## 2026-02-14 - US-013
- Implemented 3 opt-in agents: Atlas, Librarian, Metis using the optional agent infrastructure from US-012
  - Atlas: analysis-focused agent, denies task/delegate_task but allows edit/read/grep/glob (not fully read-only)
  - Librarian: read-only documentation/knowledge retrieval agent, denies write/edit/task/delegate_task
  - Metis: read-only strategic analysis agent, denies write/edit/task/delegate_task
- Each agent has a dedicated prompt file in `packages/opencode/src/agent/prompt/`
- All 3 registered in `OptionalAgents.definitions` in `packages/opencode/src/agent/optional/index.ts`
- Added `atlas`, `librarian`, `metis` to Config schema explicit agent fields
- Disabled by default; enabled via `agent.<name>.enabled: true` in opencode.jsonc
- Enabled agents automatically appear in Sisyphus delegation table via `buildAgentsTable()`
- 5 new unit tests all passing, 73 total agent tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/prompt/atlas.txt` (new)
  - `packages/opencode/src/agent/prompt/librarian.txt` (new)
  - `packages/opencode/src/agent/prompt/metis.txt` (new)
  - `packages/opencode/src/agent/optional/index.ts` (modified — added atlas, librarian, metis definitions)
  - `packages/opencode/src/config/config.ts` (modified — added atlas, librarian, metis to agent config schema)
  - `packages/opencode/test/agent/optional-agents-batch2.test.ts` (new)
- **Learnings for future iterations:**
  - Atlas has a different permission pattern from Librarian/Metis — it denies only specific tools (task, delegate_task) rather than using the `"*": "deny"` read-only pattern
  - Read-only agents (Librarian, Metis) follow the same `"*": "deny"` + explicit allows pattern as omo-explore and oracle
  - Adding optional agents only requires: 1) prompt .txt file, 2) definition in optional/index.ts, 3) config schema field — no changes to agent.ts needed
  - The optional agent infrastructure from US-012 handles all the wiring: config resolution, per-agent overrides, Sisyphus delegation table integration
---

## 2026-02-14 - US-014
- Implemented 3 opt-in agents: Momus, Multimodal-Looker, Sisyphus-Junior using the optional agent infrastructure from US-012
  - Momus: read-only code review agent, denies write/edit/task/delegate_task, allows read/grep/glob/lsp
  - Multimodal-Looker: vision-focused agent, only allows read tool (all others denied via `"*": "deny"`)
  - Sisyphus-Junior: lightweight delegation agent, denies only task tool (prevents recursion), allows everything else including edit/write/question
- Each agent has a dedicated prompt file in `packages/opencode/src/agent/prompt/`
- All 3 registered in `OptionalAgents.definitions` in `packages/opencode/src/agent/optional/index.ts`
- Added `momus`, `multimodal-looker`, `sisyphus-junior` to Config schema explicit agent fields
- Disabled by default; enabled via `agent.<name>.enabled: true` in opencode.jsonc
- Enabled agents automatically appear in Sisyphus delegation table via `buildAgentsTable()`
- 5 new unit tests all passing, 78 total agent tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/prompt/momus.txt` (new)
  - `packages/opencode/src/agent/prompt/multimodal-looker.txt` (new)
  - `packages/opencode/src/agent/prompt/sisyphus-junior.txt` (new)
  - `packages/opencode/src/agent/optional/index.ts` (modified — added momus, multimodal-looker, sisyphus-junior definitions)
  - `packages/opencode/src/config/config.ts` (modified — added momus, multimodal-looker, sisyphus-junior to agent config schema)
  - `packages/opencode/test/agent/optional-agents-batch3.test.ts` (new)
- **Learnings for future iterations:**
  - Multimodal-Looker is the most restrictive agent — only `read` tool is allowed via the `"*": "deny"` + `read: "allow"` pattern
  - Sisyphus-Junior uses a different permission pattern from read-only agents — it denies only specific tools (`task`) rather than using `"*": "deny"`, to preserve full implementation capabilities minus recursion
  - The 3-step process for adding optional agents is now well-established: 1) prompt .txt file, 2) definition in optional/index.ts, 3) config schema field in config.ts
  - Agent names with hyphens require quoted keys in both the definitions record and config schema
---
