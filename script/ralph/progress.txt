# Ralph Progress Log
Started: Sat 14 Feb 2026 02:05:22 CST

## Codebase Patterns
- **Bun mock.module contamination**: `mock.module()` is process-wide in Bun — mocking any module in one test file affects ALL other test files in the same `bun test` run. Integration tests using real SecurityConfig must be isolated from unit tests that mock `security/config`
- **Root scripts vs workspace deps**: Scripts in `script/` at repo root cannot import workspace-only packages (like `zod`). Use plain types and manual validation for standalone scripts
- Use `Instance.state()` with synchronous initializer for per-instance state that needs synchronous access (like Bus does); use async initializer only when lazy async loading is needed
- Built-in MCP servers: defined in `packages/opencode/src/mcp/builtin.ts`, auto-enabled by API key env vars, disabled via `disabled_mcps` config. User configs override built-in via spread order
- Hook chain uses priority-based ordering: lower priority number = runs earlier (security hooks ~10-50, transform ~100-200, output ~300-500)
- Config schema extends `Config.Info` in `packages/opencode/src/config/config.ts` with Zod validators
- Plugin.trigger() pattern: `Plugin.trigger(hookName, input, output)` where output is mutated in-place
- Test pattern: `await using tmp = await tmpdir({ git: true, config: {} })` + `Instance.provide({ directory: tmp.path, fn: async () => { ... } })`
- All tests run per-package: `bun test --cwd packages/opencode -- test/path/to/test.ts`
- Error recovery hooks pattern: register all hooks in a `register()` function, expose `resetErrorHistory()` for testing, use `ErrorRecoveryHooks.register()` in test setup
- Hook modules follow namespace pattern with `register()` + `reset*()` exports for registration and test cleanup
- In TypeScript namespaces, use `export function` directly — `export { name }` re-export syntax is NOT valid inside namespaces
- Context window estimation uses ~4 chars per token as rough heuristic; model context windows are looked up by name pattern matching
- Security markers in `.opencode-security.json` use plain text (e.g., `@security-start`), NOT comment-prefixed (NOT `// @security-start`) — `buildMarkerPatterns()` adds comment prefixes automatically
- Security rules require `allowedRoles: []` field (Zod validates); missing it causes config to fall back to empty/permissive
- Per-session caching pattern: use Maps keyed by `ctx.sessionID`, expose `resetCaches()` for test isolation
- `SessionStatus.list()` returns `Record<string, Info>` with only non-idle sessions; idle sessions are deleted from state on `SessionStatus.set(id, { type: "idle" })`
- For test observability of fire-and-forget operations (e.g., notifications), use internal log arrays + getter/reset exports instead of mocking `Bun.spawn`
- `PreLLMContext.providerOptions` is the channel for hooks to set provider-specific LLM parameters (thinking, effort, etc.) — guard on model name to avoid incompatible settings
- Agents are registered in a `Record<string, Info>` in `Instance.state()` — insertion order determines `defaultAgent()` fallback (first primary non-hidden agent wins)
- Agent prompts are `.txt` files imported via Bun's text loader: `import PROMPT from "./prompt/file.txt"`
- Config schema agent section has explicit fields for known agents + `.catchall(Agent)` — add new native agents to explicit fields
- New subagent agents automatically appear in Sisyphus delegation table via dynamic `buildAgentsTable()` — no manual update needed
- Search-only agents use `"*": "deny"` then explicit `"allow"` for each permitted tool
- Optional (opt-in) agents: defined in `packages/opencode/src/agent/optional/index.ts`, enabled via `agent.<name>.enabled: true` in config. `replaces` field allows swapping existing agent slots (e.g., prometheus -> plan)
- BackgroundManager: `packages/opencode/src/agent/background/manager.ts` — task queuing, concurrency control, stale detection, security config sharing. Config section: `background_task` in opencode.jsonc
- `Instance.provide()` does NOT call `Instance.dispose()` — tests verifying dispose behavior must call `Instance.dispose()` explicitly inside the `fn` callback
- Categories system: `Categories.resolve()` merges defaults with user config; `Categories.lookup(name, categories)` for retrieval. Category model format: `provider/model`, split on first `/`
- Ripgrep positive `--glob` patterns override both `--hidden` and `.gitignore` filtering — use post-filtering when these controls are needed with glob patterns
- `Ripgrep.files()` supports: cwd, glob, hidden, follow, maxDepth, noIgnore, signal — all mapped to ripgrep CLI flags
- Grep tool uses `Bun.spawn` directly with ripgrep args (not `Ripgrep.search()`). New ripgrep parameters are mapped in the tool, not the abstraction
- Ripgrep `--field-match-separator=|` only affects match lines; context lines use `-` separator — parser must handle both formats
- Tool.define execute with multiple return branches: use explicit return type annotation `Promise<{ title: string; metadata: { [key: string]: unknown }; output: string }>` to avoid union narrowing errors
- Tool.define execute return type: all branches must include same metadata fields — TypeScript narrows union types and mismatched optional fields cause errors
- Security rule schema: `deniedOperations: ["read"]` NOT `operations: { read: "deny" }` — use `SecuritySchema.Rule` format with `deniedOperations` array
- Tool descriptions: one `.txt` file per tool, imported as text via Bun loader: `import DESC from "./tool-name.txt"`
- LSP result URIs: two formats to handle — `{ uri, range }` (definitions) and `{ location: { uri, range } }` (references/symbols). Use `fileURLToPath()` to convert `file://` URIs for SecurityAccess
- LSP WorkspaceEdit: two formats — `changes: Record<uri, TextEdit[]>` or `documentChanges: TextDocumentEdit[]` — handle both
- Tool deprecation pattern: log warning via `Log.warn()`, prepend deprecation message to output, add `deprecated: true` + `replacement` to metadata
- For optional/peer dependencies, use exported `Loader` object with injectable `.load()` method for test isolation — avoids `mock.module` hoisting issues with dynamic `import()`
- `SecuritySchema.MarkerConfig` has `deniedOperations` and `allowedRoles` directly (not nested in a `rule` field) — `findMarkerSegments()` returns `MarkerSegment` with `.rule` being the full `MarkerConfig`
- AI SDK content parts: `ImagePart` = `{ type: "image", image, mediaType? }`, `FilePart` = `{ type: "file", data, mediaType }` — do NOT use `mimeType`
- For programmatic LLM calls from tools: `generateText({ model: await Provider.getLanguage(model), messages, system })` from "ai" package
- MCP tool keys use `sanitizedServer_sanitizedTool` format; resources/prompts use `sanitizedServer:sanitizedName` (colon separator). Sanitize with `.replace(/[^a-zA-Z0-9_-]/g, "_")`
- AI SDK `Tool.execute` is optional — cast through `unknown` when calling MCP tool execute directly: `(tool.execute as unknown as Function)(args, opts)`
- BashScanner only detects paths from known FILE_ACCESS_COMMANDS as the first token of a pipeline segment — supplement with direct path extraction for tools that embed paths in non-standard formats
- `SecurityAudit.SecurityEvent` interface: `{ role, operation, path, allowed, reason? }` — does NOT have `type` or `tool` fields
- Security config schema top-level: `{ version, rules: [...] }` — NOT nested under `files.rules`
- File-based persistent storage: use `.opencode/<feature>/` for project-local persistent data, `Lock.read()`/`Lock.write()` with namespaced keys for atomic operations
- Status transition enforcement: define `VALID_TRANSITIONS` lookup table, check before applying status changes
- `Tool.Context.agent` is a string (agent name), NOT `Agent.Info` — use `InitContext.agent` from the init closure for agent metadata (name, permission, etc.)
- Skill frontmatter supports optional fields: `mcp` (string[]) and `agent` (string[]) — parsed via `Info.pick({ name, description, mcp, agent })`
- Skill lazy loading: content >50KB stored as "" on discovery, loaded on first `Skill.get()` — `lazyContent` Map tracks which skills need loading
- `Skill.extractInstruction(content)` extracts `<skill-instruction>` blocks for returning only instruction content from skill templates
- Built-in skills: stored as `SKILL.md` in `src/skill/builtin/<name>/SKILL.md`, loaded first in `Skill.state()` so user-defined skills override. Disable with `OPENCODE_DISABLE_BUILTIN_SKILLS` env var
- Built-in commands: `.txt` templates in `src/command/template/`, imported via Bun text loader. User config `command` section overrides built-ins by key name
- Skills with `<skill-instruction>` blocks: only that block is returned on execute, not the full content — useful for built-in skills with documentation sections

---

## 2026-02-14 - US-001
- Implemented hook middleware chain infrastructure in `packages/opencode/src/session/hooks/index.ts`
- Defined 4 chain types: `pre-llm`, `pre-tool`, `post-tool`, `session-lifecycle` with typed contexts
- Priority-based execution order with compile-once caching
- Error isolation: errors in one hook don't crash the chain
- Config-driven enable/disable via `hooks` section in opencode.jsonc
- Combined execution methods (`executePreLLM`, `executePreTool`, `executePostTool`) that run external plugins first, then internal middleware chain
- Added `hooks` config schema to `Config.Info` in `packages/opencode/src/config/config.ts`
- 17 unit tests all passing, 1334 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/index.ts` (new)
  - `packages/opencode/src/config/config.ts` (modified - added hooks schema)
  - `packages/opencode/test/session/hooks/hook-chain.test.ts` (new)
- **Learnings for future iterations:**
  - `Instance.state()` with async initializer returns a Promise from `state()` — use sync initializer for state that needs synchronous access patterns (register, compile, execute)
  - Config can be loaded asynchronously via `init()` method and applied to already-registered hooks via `reloadConfig()`
  - The `CompiledChain` generic type requires `as unknown as CompiledChain<T>` cast due to TypeScript's strict narrowing of discriminated union types in Map lookups
  - Test fixture `tmpdir({ git: true })` initializes a git repo which is required for Instance.provide to work
---

## 2026-02-14 - US-002
- Implemented 4 error recovery hooks in `packages/opencode/src/session/hooks/error-recovery.ts`
  - `edit-error-recovery` (PostToolChain, priority 100): detects "oldString not found", "Found multiple matches", "oldString and newString must be different" and injects recovery guidance
  - `context-window-limit-recovery` (SessionLifecycleChain, priority 10): detects context_window_exceeded errors and signals compaction via ctx.data.recovery
  - `delegate-task-retry` (PostToolChain, priority 200): detects delegate_task/task failures, suggests retry with exponential backoff (1s, 2s), exhaustion message after 1 retry
  - `iterative-error-recovery` (PostToolChain, priority 300): tracks error patterns per session, injects corrective guidance after 3+ identical errors
- Added error recovery hook invocation point at processor.ts line 345 (after error conversion, before SessionRetry.retryable check)
- All hooks individually toggleable via config (reloadConfig with { "hook-name": { enabled: false } })
- 18 unit tests all passing, 1352 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/error-recovery.ts` (new)
  - `packages/opencode/src/session/processor.ts` (modified - added HookChain import and error hook invocation)
  - `packages/opencode/test/session/hooks/error-recovery.test.ts` (new)
- **Learnings for future iterations:**
  - Error recovery hooks modify `ctx.result.output` by appending recovery messages, keeping original output intact
  - `iterative-error-recovery` uses a session-scoped Map to track error patterns; call `resetErrorHistory()` in tests to avoid cross-test contamination
  - PostToolContext's `result.metadata` can be used to pass state between hook invocations (e.g., retryCount for delegate-task-retry)
  - The processor.ts error handler uses `.catch(() => {})` on hook execution to ensure hook failures never block error handling flow
  - Error detection uses string matching on tool output (includes-based), not structured error types, since tool outputs are plain strings
---

## 2026-02-14 - US-003
- Implemented 5 output management hooks in `packages/opencode/src/session/hooks/output-management.ts`
  - `tool-output-truncator` (PostToolChain, priority 50): truncates ALL tool outputs to 50KB max, preserves [REDACTED: Security Protected] markers
  - `grep-output-truncator` (PostToolChain, priority 60): grep-specific truncation showing 50 of N matches
  - `question-label-truncator` (PostToolChain, priority 70): truncates UI question labels to 200 chars with '...'
  - `context-window-monitor` (PreLLMChain, priority 900): warns when context window >80% full, configurable threshold
  - `preemptive-compaction` (PreLLMChain, priority 910): triggers compaction when context >90% full, sets variant='compact'
- Streaming truncation support for 10MB+ outputs (read first N bytes + tail message)
- Each hook individually toggleable via config
- Configurable thresholds via `configureThresholds()` API
- 23 unit tests all passing, 1375 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/output-management.ts` (new)
  - `packages/opencode/test/session/hooks/output-management.test.ts` (new)
- **Learnings for future iterations:**
  - In TypeScript namespaces, `export { name }` re-export syntax causes SyntaxError — must use `export function` directly on the declaration
  - Security marker preservation during truncation requires scanning for markers beyond the truncation boundary and appending them to the truncated output
  - Context window usage estimation: system prompt text + JSON-serialized messages, divided by 4 chars per token, compared against model-specific context windows
  - PreLLMContext.variant can be set by hooks to signal downstream behavior (e.g., 'compact' triggers compaction)
  - The context-window-monitor checks ratio < compactionThreshold to avoid warning when compaction is about to fire (avoids duplicate warnings)
---

## 2026-02-14 - US-004
- Implemented 5 context injection hooks in `packages/opencode/src/session/hooks/context-injection.ts`
  - `directory-agents-injector` (PreLLMChain, priority 100): scans for AGENTS.md in project root and `.opencode/`, injects into system prompt with per-session caching
  - `directory-readme-injector` (PreLLMChain, priority 110): injects README.md only for first message or when working directory changes
  - `rules-injector` (PreLLMChain, priority 120): injects custom rules from `.opencode/rules/*.md` and `.claude/rules/*.md`
  - `compaction-context-injector` (SessionLifecycleChain, priority 100): extracts file references and decisions from pre-compaction messages, preserves as compaction context
  - `compaction-todo-preserver` (SessionLifecycleChain, priority 110): extracts incomplete todos (markdown checkboxes, TODO/FIXME comments) and re-injects post-compaction
- SecurityAccess.checkAccess(filePath, 'read') + checkAccess(filePath, 'llm') enforced before all injections
- LLM scanner applied to injected content — protected segments redacted via SecurityRedact
- Per-session caching: AGENTS.md, README.md, and rules files cached per session ID
- Each hook individually toggleable via config
- 26 unit tests all passing, 1401 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/context-injection.ts` (new)
  - `packages/opencode/test/session/hooks/context-injection.test.ts` (new)
  - `script/ralph/prd.json` (modified - US-004 passes: true)
  - `script/ralph/progress.txt` (modified - appended progress)
- **Learnings for future iterations:**
  - Security markers in `.opencode-security.json` use plain marker text (e.g., `@security-start`), NOT comment-prefixed — `buildMarkerPatterns()` in `segments.ts` adds `//`, `#`, `<!-- -->`, etc. prefixes automatically
  - Security config rules require `allowedRoles: []` field — Zod validation rejects configs without it, causing fallback to empty (permissive) config
  - The `tmpdir()` fixture `init` callback runs before `Instance.provide()` — write test files here; load security configs inside the `fn` callback where Instance context is available
  - Per-session cache maps using `sessionID` as key allow testing cache hit/miss behavior; expose `getXxxCache()` methods for test assertions
  - `Bun.Glob.scan()` with `cwd` pointing to non-existent directory throws — wrap in try/catch to gracefully skip missing rule dirs
---

## 2026-02-14 - US-005
- Implemented 4 detection/checking hooks in `packages/opencode/src/session/hooks/detection-checking.ts`
  - `keyword-detector` (PreLLMChain, priority 200): detects mode keywords ([ultrawork]/ulw -> 'max', [analyze-mode] -> 'analyze', [review-mode] -> 'review') in last user message, sets ctx.variant
  - `comment-checker` (PostToolChain, priority 400): after edit/write tool success, calculates comment line ratio in new_string/content; warns if >40% (configurable threshold)
  - `empty-task-response-detector` (PostToolChain, priority 350): detects empty/minimal (<10 chars) responses from delegate_task/task, injects warning
  - `write-existing-file-guard` (PreToolChain, priority 200): checks if write tool targets existing file via `Bun.file().exists()`, injects warning into args._warning
- Each hook individually toggleable via config
- 23 unit tests all passing, 1424 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/detection-checking.ts` (new)
  - `packages/opencode/test/session/hooks/detection-checking.test.ts` (new)
- **Learnings for future iterations:**
  - PreToolChain hooks run before tool execution so there's no output to modify — use `ctx.args._warning` to inject warnings that the tool/agent can read
  - `getLastUserMessage()` helper iterates messages backwards to find the most recent user message, supporting both string and multipart content formats
  - Comment detection uses simple prefix matching (// # /* * <!-- --) which covers most languages; a more sophisticated approach would use language-specific comment patterns
  - `Bun.file().exists()` is async and works with absolute paths; test fixtures should use `fs.writeFileSync()` to create test files before checking existence
  - The `withInstance` helper can pass `tmpPath` to test functions that need to create files on disk (e.g., for write-existing-file-guard)
---

## 2026-02-14 - US-006
- Implemented 3 agent enforcement hooks in `packages/opencode/src/session/hooks/agent-enforcement.ts`
  - `stop-continuation-guard` (SessionLifecycleChain, priority 190): detects explicit user stop signal (`data.userStop=true`) on `agent.stopped` event, records stop signal per session to prevent todo-continuation-enforcer from triggering
  - `todo-continuation-enforcer` (SessionLifecycleChain, priority 200): on `agent.stopped` event, checks for incomplete todos via `Todo.get()`, injects continuation prompt with count and list of incomplete tasks. Respects stop signals from stop-continuation-guard
  - `subagent-question-blocker` (PreToolChain, priority 100): blocks `question` tool calls when `_isSubagent=true` in args, sets `_blocked` and `_blockedMessage` on args
- Each hook individually toggleable via config
- Priority ordering ensures stop-continuation-guard (190) runs before todo-continuation-enforcer (200)
- 13 unit tests all passing, 1437 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/agent-enforcement.ts` (new)
  - `packages/opencode/test/session/hooks/agent-enforcement.test.ts` (new)
  - `script/ralph/prd.json` (modified - US-006 passes: true)
  - `script/ralph/progress.txt` (modified - appended progress)
- **Learnings for future iterations:**
  - `Todo.get(sessionID)` returns todos stored via `Storage.read()` — works within Instance.provide context; returns empty array if no todos exist for session
  - `Todo.update()` writes todos to storage AND publishes `Todo.Event.Updated` bus event — useful for testing todo-dependent hooks
  - Stop signal pattern: use a per-session Map to communicate between hooks in the same chain execution; stop-continuation-guard (priority 190) sets the signal, todo-continuation-enforcer (priority 200) reads it
  - Subagent detection via `_isSubagent` arg flag allows callers to mark subagent context; alternative approach would be looking up Agent.Info.mode but that requires async agent resolution
  - The `withInstance` helper for these tests doesn't need `tmpPath` since all state is session-based (via Storage), not file-based
---

## 2026-02-14 - US-007
- Implemented 3 session lifecycle hooks in `packages/opencode/src/session/hooks/session-lifecycle.ts`
  - `session-recovery` (SessionLifecycleChain, priority 10): on `session.created` event, checks `SessionStatus.list()` for sessions stuck in 'busy' status, injects recovery message with stuck session IDs
  - `session-notification` (SessionLifecycleChain, priority 300): on `agent.stopped` event, sends platform-native notification (macOS osascript, Linux notify-send). Configurable via `configureNotification({ enabled, sound })`
  - `unstable-agent-babysitter` (SessionLifecycleChain, priority 250): tracks consecutive `agent.error` events per agent per session, injects diagnostic guidance after 3+ consecutive failures. Counter resets on `agent.stopped` (success)
- All hooks individually toggleable via config (HookChain.reloadConfig)
- 15 unit tests all passing, 135 existing hook tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/session-lifecycle.ts` (new)
  - `packages/opencode/test/session/hooks/session-lifecycle.test.ts` (new)
  - `script/ralph/prd.json` (modified - US-007 passes: true)
  - `script/ralph/progress.txt` (modified - appended progress)
- **Learnings for future iterations:**
  - `SessionStatus.list()` returns `Record<string, SessionStatus.Info>` — only sessions with non-idle status are stored (idle sessions are deleted from state via `SessionStatus.set()`)
  - `SessionStatus.set(id, { type: "busy" })` can be used in tests to simulate stuck sessions without needing actual LLM processing
  - Platform notifications use `Bun.spawn()` with `stdout: "ignore", stderr: "ignore"` to fire-and-forget; `.exited.catch(() => {})` prevents unhandled promise rejections
  - The notification log pattern (internal array tracking sent notifications) provides test observability without mocking `Bun.spawn` — track `{ platform, title, message }` entries
  - Failure counter pattern: per-session Map<agent, count> allows tracking per-agent failures independently; success events reset only the specific agent's counter
---

## 2026-02-14 - US-008
- Implemented 2 LLM parameter hooks in `packages/opencode/src/session/hooks/llm-parameters.ts`
  - `think-mode` (PreLLMChain, priority 50): sets Claude thinking parameter based on variant. 'max' -> budgetTokens: 32000, 'quick' -> thinking disabled, other variants -> default 16000. Only applies to Claude models
  - `anthropic-effort` (PreLLMChain, priority 60): sets Anthropic effort level based on variant. 'max' -> 'high', 'quick' -> 'low', other variants -> 'medium'. Only applies to Claude models
- Added `providerOptions` field to `PreLLMContext` schema (z.record(z.string(), z.any()).optional()) for hooks to set provider-specific LLM parameters
- Both hooks individually toggleable via config
- 13 unit tests all passing, 1465 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/hooks/llm-parameters.ts` (new)
  - `packages/opencode/src/session/hooks/index.ts` (modified - added providerOptions to PreLLMContext)
  - `packages/opencode/test/session/hooks/llm-parameters.test.ts` (new)
  - `script/ralph/prd.json` (modified - US-008 passes: true)
  - `script/ralph/progress.txt` (modified - appended progress)
- **Learnings for future iterations:**
  - `PreLLMContext.providerOptions` is the channel for hooks to communicate provider-specific LLM parameters (thinking budget, effort level, etc.) downstream
  - LLM parameter hooks should guard on model name (e.g., `ctx.model.includes("claude")`) to avoid setting provider-specific options for incompatible models
  - The `variant` field flows through: user message -> keyword-detector hook -> think-mode/anthropic-effort hooks, creating a clean pipeline for mode-based parameter control
  - Think-mode and anthropic-effort hooks share the same `providerOptions` object via `ctx.providerOptions = ctx.providerOptions ?? {}` pattern — order matters (priority 50 before 60)
---

## 2026-02-14 - US-009
- Implemented Sisyphus agent as default primary agent
  - Created `packages/opencode/src/agent/sisyphus.ts` with `Sisyphus.buildDynamicPrompt()` dynamic prompt builder
  - Created `packages/opencode/src/agent/prompt/sisyphus.txt` with orchestration-focused system prompt
  - Registered sisyphus in agent registry as first entry (before build) — makes it the default agent
  - Sisyphus: mode=primary, temperature=0.1, full tool access, question+plan_enter allowed
  - Dynamic prompt builder injects: agents table (subagent/all mode agents), skills list, categories (future US-030)
  - Build agent kept accessible with explicit name, description updated to "Full-access builder agent"
  - Updated `Agent.list()` sort to use sisyphus as default sort key
  - Updated Config schema to include sisyphus in agent config object
  - Updated 3 existing tests: defaultAgent now returns "sisyphus", disabled-all-primary test includes sisyphus
- 10 new unit tests + 35 existing agent tests all passing, 1475 total tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/sisyphus.ts` (new)
  - `packages/opencode/src/agent/prompt/sisyphus.txt` (new)
  - `packages/opencode/src/agent/agent.ts` (modified - added sisyphus, updated list sort)
  - `packages/opencode/src/config/config.ts` (modified - added sisyphus to agent config schema)
  - `packages/opencode/test/agent/agent.test.ts` (modified - updated default agent tests)
  - `packages/opencode/test/agent/sisyphus.test.ts` (new)
- **Learnings for future iterations:**
  - Agents are registered in a `Record<string, Info>` inside `Instance.state()` — insertion order matters for `Object.values().find()` in `defaultAgent()` fallback
  - `defaultAgent()` returns the first primary non-hidden agent when no `default_agent` config is set — putting sisyphus first in the record makes it the default
  - Agent prompts are imported as `.txt` files using Bun's text loader — just `import PROMPT from "./prompt/file.txt"`
  - Categories config field doesn't exist yet (US-030) — access via `(cfg as Record<string, unknown>).categories` for forward compatibility
  - The `Agent.list()` sort uses the default agent name for sorting — update this when changing the default agent
  - Config schema's agent object has explicit fields for known agents plus `.catchall()` — new native agents should be added to the explicit fields
---

## 2026-02-14 - US-010
- Implemented omo-explore agent as a Sisyphus sub-agent for advanced codebase exploration
  - Created `packages/opencode/src/agent/prompt/omo-explore.txt` with parallel execution strategy and tool priority (LSP > ast_grep > grep > glob > git)
  - Registered `omo-explore` in agent registry in `agent.ts` as subagent mode with search-only permissions
  - Tool restrictions: DENIED write, edit, task, delegate_task; ALLOWED grep, glob, read, lsp, ast_grep_search, bash, webfetch, websearch, codesearch
  - Added `omo-explore` to config schema explicit fields in `config.ts`
  - Sisyphus delegation table automatically picks up omo-explore via dynamic `buildAgentsTable()` filter on mode=subagent
  - Original explore agent completely unchanged (same prompt, same tools, same permissions)
- Updated existing `agent.test.ts` to include `omo-explore` in default agents list assertion
- 8 new unit tests all passing, 1483 total tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/prompt/omo-explore.txt` (new)
  - `packages/opencode/src/agent/agent.ts` (modified - added omo-explore import and registration)
  - `packages/opencode/src/config/config.ts` (modified - added omo-explore to agent config schema)
  - `packages/opencode/test/agent/omo-explore.test.ts` (new)
  - `packages/opencode/test/agent/agent.test.ts` (modified - added omo-explore to default agents assertion)
- **Learnings for future iterations:**
  - New subagent agents are automatically included in Sisyphus delegation table — `buildAgentsTable()` dynamically filters agents with `mode === "subagent" || mode === "all"`
  - Agent names with hyphens (e.g., "omo-explore") work as record keys in JS and as config keys in JSONC — use quoted string keys in Zod schema definitions
  - The `"*": "deny"` permission rule denies all tools by default; subsequent explicit `"allow"` rules override for specific tools — this is the pattern for search-only agents
  - Agent registration doesn't require a separate module file — simpler agents can be defined inline in `agent.ts` alongside existing agents
---

## 2026-02-14 - US-011
- Implemented Oracle agent as strategic advisor subagent
  - Created `packages/opencode/src/agent/prompt/oracle.txt` with pragmatic minimalism philosophy, effort estimation (Quick/Short/Medium/Large), and bottom-line response format
  - Registered `oracle` in agent registry in `agent.ts` as subagent mode with search-only permissions
  - Tool restrictions: DENIED write, edit, task, delegate_task; ALLOWED read, grep, glob, lsp, bash, webfetch, websearch, codesearch
  - Temperature: 0.1 for precise, deterministic analysis
  - Added `oracle` to config schema explicit fields in `config.ts`
  - Sisyphus delegation table automatically picks up oracle via dynamic `buildAgentsTable()`
- Updated existing `agent.test.ts` to include `oracle` in default agents list assertion
- 6 new unit tests all passing, 59 total agent tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/prompt/oracle.txt` (new)
  - `packages/opencode/src/agent/agent.ts` (modified - added oracle import and registration)
  - `packages/opencode/src/config/config.ts` (modified - added oracle to agent config schema)
  - `packages/opencode/test/agent/oracle.test.ts` (new)
  - `packages/opencode/test/agent/agent.test.ts` (modified - added oracle to default agents assertion)
- **Learnings for future iterations:**
  - Oracle follows the exact same pattern as omo-explore: search-only subagent with `"*": "deny"` + explicit allows
  - Adding a new native subagent requires 4 changes: prompt .txt file, agent definition in agent.ts, config schema field in config.ts, and updating the default agents list test
  - The thinking budget (32k for Claude models) is handled by the think-mode hook (US-008) based on variant, not by the agent definition itself — agent just sets temperature
  - Simple agents that don't need dynamic prompt building can be defined inline in agent.ts without a separate module file (unlike Sisyphus which has sisyphus.ts for buildDynamicPrompt)
---

## 2026-02-14 - US-012
- Implemented opt-in agent infrastructure and two optional agents: Hephaestus and Prometheus
  - Created `packages/opencode/src/agent/optional/index.ts` with `OptionalAgents` namespace for resolving opt-in agents
  - Created `packages/opencode/src/agent/prompt/hephaestus.txt` — full-access builder agent prompt
  - Created `packages/opencode/src/agent/prompt/prometheus.txt` — strategic planning agent prompt with plan_exit integration
  - Hephaestus: subagent mode, full tool access, enabled via `agent.hephaestus.enabled: true`
  - Prometheus: primary mode, read-only (replaces plan agent when enabled), same edit restrictions as plan (only plan files)
  - Per-agent config: model, temperature, prompt_append all supported through config overrides
- Integration into agent.ts:
  - Optional agents resolved before the main config merge loop
  - Optional agent config entries skipped in main loop to prevent double-processing
  - Replacement mechanism: prometheus replaces "plan" key in registry, so plan_enter/plan_exit tools continue working
  - Per-agent overrides (model, temperature, prompt_append) applied after optional resolution
- Added `hephaestus` and `prometheus` to Config.Agent schema explicit fields in config.ts
- 9 new unit tests all passing, 1498 total tests pass (+ 1 skip)
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/optional/index.ts` (new)
  - `packages/opencode/src/agent/prompt/hephaestus.txt` (new)
  - `packages/opencode/src/agent/prompt/prometheus.txt` (new)
  - `packages/opencode/src/agent/agent.ts` (modified — added OptionalAgents import and integration)
  - `packages/opencode/src/config/config.ts` (modified — added hephaestus, prometheus to agent config schema)
  - `packages/opencode/test/agent/optional-agents.test.ts` (new)
- **Learnings for future iterations:**
  - Optional agents use `options.enabled === true` to detect opt-in — the `enabled` field flows through Config.Agent's `.catchall(z.any())` into `options`
  - The `replaces` field in OptionalAgentDef allows an optional agent to take over an existing agent slot (e.g., prometheus -> plan) without changing any tool references
  - Optional agent config entries must be skipped in the main config merge loop to prevent them from being treated as custom agents with `native: false`
  - `prompt_append` is read from `options.prompt_append` since it's an unknown field that gets swept into options by the transform
  - The per-agent override logic for optional agents is separate from the main loop — first resolve the optional agents, then apply config overrides like model/temperature/prompt_append
---

## 2026-02-14 - US-013
- Implemented 3 opt-in agents: Atlas, Librarian, Metis using the optional agent infrastructure from US-012
  - Atlas: analysis-focused agent, denies task/delegate_task but allows edit/read/grep/glob (not fully read-only)
  - Librarian: read-only documentation/knowledge retrieval agent, denies write/edit/task/delegate_task
  - Metis: read-only strategic analysis agent, denies write/edit/task/delegate_task
- Each agent has a dedicated prompt file in `packages/opencode/src/agent/prompt/`
- All 3 registered in `OptionalAgents.definitions` in `packages/opencode/src/agent/optional/index.ts`
- Added `atlas`, `librarian`, `metis` to Config schema explicit agent fields
- Disabled by default; enabled via `agent.<name>.enabled: true` in opencode.jsonc
- Enabled agents automatically appear in Sisyphus delegation table via `buildAgentsTable()`
- 5 new unit tests all passing, 73 total agent tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/prompt/atlas.txt` (new)
  - `packages/opencode/src/agent/prompt/librarian.txt` (new)
  - `packages/opencode/src/agent/prompt/metis.txt` (new)
  - `packages/opencode/src/agent/optional/index.ts` (modified — added atlas, librarian, metis definitions)
  - `packages/opencode/src/config/config.ts` (modified — added atlas, librarian, metis to agent config schema)
  - `packages/opencode/test/agent/optional-agents-batch2.test.ts` (new)
- **Learnings for future iterations:**
  - Atlas has a different permission pattern from Librarian/Metis — it denies only specific tools (task, delegate_task) rather than using the `"*": "deny"` read-only pattern
  - Read-only agents (Librarian, Metis) follow the same `"*": "deny"` + explicit allows pattern as omo-explore and oracle
  - Adding optional agents only requires: 1) prompt .txt file, 2) definition in optional/index.ts, 3) config schema field — no changes to agent.ts needed
  - The optional agent infrastructure from US-012 handles all the wiring: config resolution, per-agent overrides, Sisyphus delegation table integration
---

## 2026-02-14 - US-014
- Implemented 3 opt-in agents: Momus, Multimodal-Looker, Sisyphus-Junior using the optional agent infrastructure from US-012
  - Momus: read-only code review agent, denies write/edit/task/delegate_task, allows read/grep/glob/lsp
  - Multimodal-Looker: vision-focused agent, only allows read tool (all others denied via `"*": "deny"`)
  - Sisyphus-Junior: lightweight delegation agent, denies only task tool (prevents recursion), allows everything else including edit/write/question
- Each agent has a dedicated prompt file in `packages/opencode/src/agent/prompt/`
- All 3 registered in `OptionalAgents.definitions` in `packages/opencode/src/agent/optional/index.ts`
- Added `momus`, `multimodal-looker`, `sisyphus-junior` to Config schema explicit agent fields
- Disabled by default; enabled via `agent.<name>.enabled: true` in opencode.jsonc
- Enabled agents automatically appear in Sisyphus delegation table via `buildAgentsTable()`
- 5 new unit tests all passing, 78 total agent tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/prompt/momus.txt` (new)
  - `packages/opencode/src/agent/prompt/multimodal-looker.txt` (new)
  - `packages/opencode/src/agent/prompt/sisyphus-junior.txt` (new)
  - `packages/opencode/src/agent/optional/index.ts` (modified — added momus, multimodal-looker, sisyphus-junior definitions)
  - `packages/opencode/src/config/config.ts` (modified — added momus, multimodal-looker, sisyphus-junior to agent config schema)
  - `packages/opencode/test/agent/optional-agents-batch3.test.ts` (new)
- **Learnings for future iterations:**
  - Multimodal-Looker is the most restrictive agent — only `read` tool is allowed via the `"*": "deny"` + `read: "allow"` pattern
  - Sisyphus-Junior uses a different permission pattern from read-only agents — it denies only specific tools (`task`) rather than using `"*": "deny"`, to preserve full implementation capabilities minus recursion
  - The 3-step process for adding optional agents is now well-established: 1) prompt .txt file, 2) definition in optional/index.ts, 3) config schema field in config.ts
  - Agent names with hyphens require quoted keys in both the definitions record and config schema
---

## 2026-02-14 - US-015
- Implemented BackgroundManager in `packages/opencode/src/agent/background/manager.ts`
  - Task lifecycle: Create -> Queue -> Concurrency Check -> Execute -> Monitor -> Notify -> Cleanup
  - Concurrency config: defaultConcurrency (default 3), providerConcurrency, modelConcurrency
  - Stale timeout detection (default 180000ms / 3 min) with auto cleanup via `cleanupStaleTasks()`
  - Event callbacks: onSubagentSessionCreated(sessionID), onShutdown(), onExecute(task)
  - Default: cancel all background tasks on session exit. Config persist_on_exit=true allows tasks to continue
  - Background tasks share parent SecurityConfig by reference (frozen, immutable via Object.freeze)
  - Task status transitions: pending -> running -> completed/failed/cancelled
  - Bus events for task lifecycle: Created, Started, Completed, Failed, Cancelled
- Added `background_task` config section to Config.Info in config.ts with Zod schema
- 23 unit tests all passing, 101 total agent tests pass, 148 hook tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/background/manager.ts` (new)
  - `packages/opencode/src/config/config.ts` (modified - added background_task schema)
  - `packages/opencode/test/agent/background/manager.test.ts` (new)
- **Learnings for future iterations:**
  - `Instance.state()` dispose handler is the right place for cleanup on exit — it runs when `Instance.dispose()` is called
  - `Instance.provide()` does NOT call dispose automatically — tests that verify dispose behavior must call `Instance.dispose()` explicitly inside the `fn` callback
  - `randomUUIDv7()` from Bun provides monotonically increasing UUIDs — good for task IDs that need ordering
  - The dequeue pattern: after any task completion/failure/cancellation, call `dequeue()` to start next eligible task from the queue
  - Provider and model concurrency limits are checked independently — a task blocked by provider limit can still be blocked by model limit
  - `Object.freeze()` on the security config ensures immutability; the frozen reference is shared across all background tasks via `getSecurityConfig()`
---

## 2026-02-14 - US-016
- Implemented task category system for delegated work routing
  - Created `packages/opencode/src/agent/background/categories.ts` with `Categories` namespace
  - 8 default categories: visual-engineering, ultrabrain, deep, artistry, quick, writing, unspecified-low, unspecified-high
  - Each category has: description (required), model (optional), prompt_append (optional)
  - `Categories.resolve()` merges defaults with user-configured categories from opencode.jsonc
  - `Categories.lookup()` for name-based category retrieval
  - `Categories.buildDelegationTable()` generates markdown table for Sisyphus prompt
- Updated Sisyphus dynamic prompt builder to use Categories module instead of ad-hoc config access
- Added `categories` field to Config.Info schema (Zod validated record of CategoryConfig)
- Integrated category-based model resolution in task tool: `category` parameter resolves to model from category config, overriding agent/message defaults
- 11 unit tests all passing, 112 agent tests pass, 96 config tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/agent/background/categories.ts` (new)
  - `packages/opencode/src/agent/sisyphus.ts` (modified — use Categories module)
  - `packages/opencode/src/config/config.ts` (modified — added categories schema)
  - `packages/opencode/src/tool/task.ts` (modified — added category parameter and model resolution)
  - `packages/opencode/test/agent/background/categories.test.ts` (new)
- **Learnings for future iterations:**
  - Categories use a merge-with-defaults pattern: `{ ...DEFAULTS, ...userCategories }` — user categories override defaults by key, new keys are added
  - The Sisyphus `buildCategoriesSection()` was already stubbed out (from US-009) with safe config access — US-016 replaced it with the proper Categories module
  - Category model format is `provider/model` (e.g., `anthropic/claude-haiku`) — split on first `/` to extract providerID and modelID
  - The task tool's model resolution priority: category model > agent model > current message model
  - Config schema uses `.strict()` on the top-level `Info` object — new fields must be explicitly added to the schema, not just passed through
---

## 2026-02-14 - US-017
- Enhanced Glob tool with 4 new optional parameters: maxDepth, hidden, follow, noIgnore
  - `maxDepth` (number): limits directory search depth, passed to Ripgrep.files()
  - `hidden` (boolean): controls dotfile inclusion. Post-filtering applied since ripgrep positive `--glob` overrides `--hidden`
  - `follow` (boolean): follows symbolic links via ripgrep `--follow`
  - `noIgnore` (boolean): includes gitignored files via ripgrep `--no-ignore`
- Added `noIgnore` parameter support to `Ripgrep.files()` in ripgrep.ts
- Added explicit 60s timeout with `AbortController` + `AbortSignal.any()` for combined abort
- Timeout uses try/catch to detect timeout-specific aborts vs user-initiated aborts
- Backward compatible: calling with only pattern+path matches previous behavior
- 10 unit tests all passing, 1552 total tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/tool/glob.ts` (modified — added parameters, timeout, hidden post-filtering)
  - `packages/opencode/src/file/ripgrep.ts` (modified — added noIgnore parameter to files())
  - `packages/opencode/test/tool/glob.test.ts` (new)
- **Learnings for future iterations:**
  - Ripgrep's positive `--glob` patterns (include patterns) override both `--hidden` and `.gitignore` filtering — this is by design in ripgrep
  - When `hidden=false` is needed with glob patterns, post-filtering (checking path segments for `.` prefix) is required instead of relying on ripgrep's `--hidden` flag
  - `AbortSignal.any([signal1, signal2])` combines multiple abort signals — useful for combining user abort with timeout abort
  - The timeout controller's `.signal.aborted` check distinguishes timeout aborts from user-initiated aborts in the catch block
  - Tool parameters with `z.number().int().positive().optional()` give clean Zod validation for integer-only positive values
  - The `Ripgrep.files()` async generator already supports hidden, follow, maxDepth — they just weren't being passed by the glob tool
---

## 2026-02-14 - US-018
- Enhanced Grep tool with 9 new optional parameters mapped to ripgrep CLI flags
  - `context` (number): `--context=N` for surrounding lines before/after match
  - `caseSensitive` (boolean): `--case-sensitive` (true) or `--ignore-case` (false), default smart case
  - `wholeWord` (boolean): `--word-regexp` for whole word matching
  - `fixedStrings` (boolean): `--fixed-strings` for literal string matching (not regex)
  - `multiline` (boolean): `--multiline` for cross-line pattern matching
  - `maxCount` (number): `--max-count=N` per-file limit, also used as output result limit (default 500)
  - `maxColumns` (number): `--max-columns=N` to limit line width in output
  - `exclude` (string): `--glob !pattern` for excluding files from search
  - `fileType` (string): `--type` for restricting to specific file types (e.g., "ts", "py")
- Improved exit code 2 handling: returns partial results with warning message and `hasPartialResults` metadata flag
- Context line parsing: ripgrep uses `|` for match lines but `-` for context lines — parser handles both formats
- Added `--` separator line skipping for context mode output
- SecurityAccess filtering and segment redaction continue working with all new parameters
- Backward compatible: all new parameters are optional with sensible defaults
- 15 new unit tests all passing, 1567 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/tool/grep.ts` (modified — added parameters, ripgrep flag mapping, context line parsing)
  - `packages/opencode/test/tool/grep-enhanced.test.ts` (new)
- **Learnings for future iterations:**
  - Ripgrep `--field-match-separator=|` only affects match lines, not context lines — context lines use `-` as separator (file-linenum-text)
  - Context line regex parsing: `^(.+)-(\d+)-(.*)$` handles file paths with dashes by using greedy match for the path portion
  - `--fixed-strings` and `--multiline` are mutually exclusive approaches to pattern handling — `fixedStrings` uses `-- pattern` (double-dash prevents pattern as flag) while `multiline` uses `--regexp`
  - The grep tool uses `Bun.spawn` directly with ripgrep args rather than `Ripgrep.search()` — new params are mapped directly in the tool, not the Ripgrep abstraction
  - `maxCount` serves dual purpose: passed to ripgrep as `--max-count` (per-file limit) AND used as the output result truncation limit
  - Return type consistency: all return paths must include the same metadata fields (e.g., `hasPartialResults`) to satisfy TypeScript's type narrowing
---

## 2026-02-14 - US-019
- Split LSP tool into 5 focused navigation tools: `lsp_goto_definition`, `lsp_find_references`, `lsp_symbols`, `lsp_hover`, `lsp_implementation`
  - `lsp_goto_definition`: file, line, character -> definition locations formatted as file:line:col
  - `lsp_find_references`: file, line, character + includeDeclaration (default true) + limit (default 100) -> reference locations with truncation messages
  - `lsp_symbols`: file, scope (document|workspace) + query + limit (default 50) -> symbol names with kinds and locations
  - `lsp_hover`: file, line, character -> hover information (documentation, types)
  - `lsp_implementation`: file, line, character -> implementation locations
- All tools use `SecurityAccess.checkAccess(filePath, 'read', 'agent')` to filter results containing protected file paths
- `filterByAccess` helper handles both `uri` and `location.uri` LSP result formats
- `formatLocation` helper converts LSP URIs to relative file:line:col format
- Original `lsp` tool preserved unchanged alongside new focused tools
- All new tools registered in ToolRegistry behind `OPENCODE_EXPERIMENTAL_LSP_TOOL` flag
- Each tool description in a separate `.txt` file following existing convention
- 30 unit tests all passing, 1597 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/tool/lsp-tools.ts` (new)
  - `packages/opencode/src/tool/lsp-goto-definition.txt` (new)
  - `packages/opencode/src/tool/lsp-find-references.txt` (new)
  - `packages/opencode/src/tool/lsp-symbols.txt` (new)
  - `packages/opencode/src/tool/lsp-hover.txt` (new)
  - `packages/opencode/src/tool/lsp-implementation.txt` (new)
  - `packages/opencode/src/tool/registry.ts` (modified — added new tool imports and registration)
  - `packages/opencode/test/tool/lsp-tools.test.ts` (new)
- **Learnings for future iterations:**
  - TypeScript's type narrowing requires all return branches of a Tool.define execute function to have consistent metadata shapes — include all fields (even with 0/undefined) in all branches
  - SecurityAccess rule schema uses `deniedOperations: ["read"]` and `allowedRoles: []`, NOT `operations: { read: "deny" }` — use correct SecuritySchema.Rule format
  - For security test setup, use `setupSecurityConfig()` helper from `test/security/access_control_cases/helpers.ts` which writes `.opencode-security.json` to disk and calls `loadSecurityConfig(dir)`
  - macOS path canonicalization: use `fs.realpathSync(tmp.path)` when creating absolute rule patterns in tests — `/var/folders/` vs `/private/var/folders/` mismatch causes rules to not match
  - LSP result filtering needs to handle two URI formats: direct `{ uri, range }` (definitions) and nested `{ location: { uri, range } }` (references/symbols)
  - `fileURLToPath` from `url` module converts `file://` URIs back to file paths for SecurityAccess checks
  - Tool descriptions as separate `.txt` files are imported via Bun's text loader — one file per tool
  - Tools with no LSP server available (file type not supported) throw "No LSP server available for this file type" — test with unusual extensions
---

## 2026-02-14 - US-020
- Split LSP tool: created 4 new focused tools and deprecated old unified lsp tool
  - `lsp_diagnostics`: retrieves LSP diagnostics with severity filter (error/warning/information/hint/all), formats as SEVERITY [line:col] message (file:line:col)
  - `lsp_prepare_rename`: checks if symbol at position can be renamed, returns range and placeholder
  - `lsp_rename`: renames symbol across all files via LSP workspace edit, lists affected files with change counts
  - `lsp_call_hierarchy`: explores call hierarchy with direction param (prepare/incoming/outgoing)
- Added `prepareRename` and `rename` methods to `LSP` namespace in `packages/opencode/src/lsp/index.ts`
- Deprecated old unified `lsp` tool: logs deprecation warning, prepends deprecation message to output, includes replacement tool name in metadata
- All new tools registered in ToolRegistry behind `OPENCODE_EXPERIMENTAL_LSP_TOOL` flag
- SecurityAccess.checkAccess(filePath, 'read', 'agent') filtering on all result file paths
- 28 unit tests all passing, 58 total LSP tool tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/tool/lsp-tools-extended.ts` (new)
  - `packages/opencode/src/tool/lsp-diagnostics.txt` (new)
  - `packages/opencode/src/tool/lsp-prepare-rename.txt` (new)
  - `packages/opencode/src/tool/lsp-rename.txt` (new)
  - `packages/opencode/src/tool/lsp-call-hierarchy.txt` (new)
  - `packages/opencode/src/lsp/index.ts` (modified — added prepareRename, rename methods)
  - `packages/opencode/src/tool/lsp.ts` (modified — added deprecation warning and metadata)
  - `packages/opencode/src/tool/registry.ts` (modified — registered 4 new tools)
  - `packages/opencode/test/tool/lsp-tools-extended.test.ts` (new)
- **Learnings for future iterations:**
  - LSP rename returns a `WorkspaceEdit` object with either `changes` (Record<uri, TextEdit[]>) or `documentChanges` (TextDocumentEdit[]) — handle both formats
  - `LSP.prepareRename()` can return either `{ range, placeholder }` or just a `Range` — the response format varies by LSP server
  - Call hierarchy `incomingCalls` returns `{ from: CallHierarchyItem }` and `outgoingCalls` returns `{ to: CallHierarchyItem }` — extract the nested item for formatting/filtering
  - Deprecation pattern: log warning via `Log.warn()`, prepend deprecation message to output, add `deprecated: true` and `replacement` to metadata — allows downstream processing to detect and handle deprecated tool usage
  - LSP diagnostics (`LSP.diagnostics()`) returns all diagnostics from all connected clients with no file parameter — the file path is only used to ensure an LSP server is running
  - `as const` is needed on string arrays used in `for...of` loops when the values are passed to functions expecting specific string literal types (Zod enum parse)
---

## 2026-02-14 - US-021
- Implemented AST-Grep search and replace tools in `packages/opencode/src/tool/ast-grep.ts`
  - `ast_grep_search`: AST-aware code search with pattern, lang (25 languages), paths, globs, context params
  - `ast_grep_replace`: AST-aware code refactoring with rewrite, dryRun (default true) params
- @ast-grep/napi as peer dependency: `AstGrepLoader.load()` returns null if not installed, tools return clear "ast-grep not available. Install with: bun add @ast-grep/napi" message
- SecurityAccess integration:
  - `checkAccess(path, 'read')` for search files
  - `checkAccess(path, 'write')` for replace files (only when dryRun=false)
  - `findWriteProtectedSegments()` for segment-level protection in replace
  - `SecurityAudit.logSecurityEvent()` for all denied operations
- Gated behind `OPENCODE_EXPERIMENTAL_AST_GREP` flag (or `OPENCODE_EXPERIMENTAL`)
- Created tool description files: `ast-grep-search.txt`, `ast-grep-replace.txt`
- Registered both tools in `registry.ts` behind experimental flag
- Added `AstGrepApi`, `AstGrepRoot`, `AstGrepNode` interfaces for type-safe API usage
- 20 unit tests all passing, 1645 existing tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/tool/ast-grep.ts` (new)
  - `packages/opencode/src/tool/ast-grep-search.txt` (new)
  - `packages/opencode/src/tool/ast-grep-replace.txt` (new)
  - `packages/opencode/src/tool/registry.ts` (modified — registered tools)
  - `packages/opencode/src/flag/flag.ts` (modified — added OPENCODE_EXPERIMENTAL_AST_GREP)
  - `packages/opencode/test/tool/ast-grep.test.ts` (new)
- **Learnings for future iterations:**
  - `mock.module` in Bun is hoisted and persistent per file — cannot test "module not found" and "module mocked" in the same file
  - Solution: export an injectable `Loader` object with `.load()` method; tests swap it with `enableMock()`/`disableMock()` + `restoreLoader()` in afterEach
  - `SecuritySchema.MarkerConfig` has `deniedOperations` and `allowedRoles` directly on the object, not nested in a `rule` field — but `SecuritySegments.findMarkerSegments()` returns `MarkerSegment` where `.rule` IS the `MarkerConfig`
  - Separate `AstGrepRoot` from `AstGrepNode` interface: root only needs `findAll`, individual nodes need `text/range/replace/findAll`
  - `SgNode.range()` returns `{ start: Pos, end: Pos }` where `Pos` has `line`, `column`, AND `index` (byte offset) — use `.index` for precise position checking
  - `SgNode.replace()` returns an `Edit { startPos, endPos, insertedText }` object, NOT a string — must extract `.insertedText` for the replacement text
  - Protected segment skipping in replace: apply replacements in reverse offset order to preserve positions for earlier replacements
---

## 2026-02-14 - US-022
- Implemented 3 new tools for delegate-task with background execution
  - `delegate_task`: delegates tasks to specialized agents with category routing, background execution, skill injection, session continuation, and sub-agent recursion prevention
  - `background_output`: retrieves status and output of background tasks (pending/running/completed/failed/cancelled)
  - `background_cancel`: cancels running or pending background tasks
- Key features:
  - `run_in_background=true` returns task_id immediately; `=false` waits for completion (sync mode mirrors existing task tool)
  - Category resolution via `Categories.resolve()` + `Categories.lookup()` for model routing (e.g., 'quick' -> cheap model)
  - `subagent_type` for explicit agent selection; cannot be used with `category` (mutual exclusion enforced)
  - `load_skills` parameter injects skill content into sub-agent prompt via `<skill_content>` XML blocks
  - `session_id` for session continuation (resume existing sub-session)
  - Sub-agents denied `delegate_task` permission to prevent recursion (via `ctx.extra.isSubagent` check + permission rule)
  - SecurityConfig shared by reference via BackgroundManager (frozen, immutable)
- Tool description files: `delegate-task.txt`, `background-output.txt`, `background-cancel.txt`
- All 3 tools registered in ToolRegistry alongside existing task tool
- 29 unit tests all passing, 1674 total tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/tool/delegate-task.ts` (new)
  - `packages/opencode/src/tool/delegate-task.txt` (new)
  - `packages/opencode/src/tool/background-output.txt` (new)
  - `packages/opencode/src/tool/background-cancel.txt` (new)
  - `packages/opencode/src/tool/registry.ts` (modified — registered 3 new tools)
  - `packages/opencode/test/tool/delegate-task.test.ts` (new)
- **Learnings for future iterations:**
  - Tool.define execute return type must be explicitly annotated with `Promise<{ title: string; metadata: MetadataType; output: string }>` when multiple return branches have different metadata shapes — TypeScript narrows union types and mismatched optional fields cause errors
  - Use `{ [key: string]: unknown }` as the metadata type for tools with diverse return shapes to avoid union type narrowing issues
  - The `ctx.extra?.isSubagent` pattern allows callers to mark sub-agent context for recursion prevention — complements the permission-level deny on `delegate_task` tool
  - Background execution pattern: create BackgroundManager task, resolve prompt parts, then fire-and-forget via `executeInBackground().catch()` — failures handled by `BackgroundManager.fail()`
  - `delegate_task` disables itself (`delegate_task: false`) in the tools map when calling `SessionPrompt.prompt()` to prevent the sub-agent from calling it, in addition to the permission-level deny
  - The existing `task` tool remains unchanged — `delegate_task` is an enhanced alternative with category routing and background execution
---

## 2026-02-14 - US-023
- Implemented `look_at` multimodal analyzer tool in `packages/opencode/src/tool/look-at.ts`
  - `look_at` tool: analyzes images, PDFs, and diagrams using vision-capable models
  - Parameters: `file_path` (optional), `image_data` (base64, optional), `goal` (required)
  - At least one of `file_path` or `image_data` must be provided
  - Vision model resolution: configurable via `vision_model` in opencode.jsonc, falls back to priority list (gemini-2.5-flash, gpt-5-mini, claude-haiku, etc.), ultimate fallback to default model
  - Uses AI SDK `generateText()` with `ImagePart` (for images) or `FilePart` (for PDFs) content types
- SecurityAccess integration:
  - `checkAccess(filePath, 'read')` before reading file from disk
  - `checkAccess(filePath, 'llm')` before sending to vision model
  - `SecurityAudit.logSecurityEvent()` for all denied operations
- Gated behind `OPENCODE_EXPERIMENTAL_LOOK_AT` flag (or `OPENCODE_EXPERIMENTAL`)
- Created tool description file: `look-at.txt`
- Registered in `registry.ts` behind experimental flag
- 11 unit tests all passing, 242 tool tests pass, 1681+ total tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/tool/look-at.ts` (new)
  - `packages/opencode/src/tool/look-at.txt` (new)
  - `packages/opencode/src/flag/flag.ts` (modified — added OPENCODE_EXPERIMENTAL_LOOK_AT)
  - `packages/opencode/src/tool/registry.ts` (modified — registered LookAtTool)
  - `packages/opencode/test/tool/look-at.test.ts` (new)
  - `script/ralph/prd.json` (modified — US-023 passes: true)
  - `script/ralph/progress.txt` (modified — appended progress)
- **Learnings for future iterations:**
  - AI SDK `ImagePart` uses `{ type: "image", image: dataUrl, mediaType?: string }` — NOT `mimeType` or `type: "file"`
  - AI SDK `FilePart` uses `{ type: "file", data: dataUrl, mediaType: string }` — use for PDFs
  - For vision model calls from tools, use `generateText()` from "ai" + `Provider.getModel()`/`Provider.getLanguage()` — no need for agent loop
  - Vision model resolution pattern: check config first (`vision_model`), then scan available providers for known vision models, fallback to default model
  - `Bun.file().type` may not correctly detect MIME types from extension alone — use explicit extension-to-MIME mapping as fallback
  - Security rules in tests require `type: "file"` field (Zod validates) — omitting it causes typecheck errors
  - `mock.module()` in Bun works well for mocking `ai` and `Provider` modules — allows testing without real API calls
---

## 2026-02-14 - US-024
- Implemented `skill_mcp` tool in `packages/opencode/src/tool/skill-mcp.ts`
  - `skill_mcp` tool: invokes MCP tools, reads resources, or executes prompts from within skill context
  - Parameters: `mcp_name` (required), `tool_name` (optional), `resource_name` (optional), `prompt_name` (optional), `arguments` (optional, JSON string or object)
  - Validates exactly ONE of tool_name/resource_name/prompt_name is provided
  - Reuses existing MCP client infrastructure: `MCP.tools()`, `MCP.readResource()`, `MCP.getPrompt()`
  - Security: `SecurityConfig.getMcpPolicy()` checks for blocked servers, `SecurityAudit.logSecurityEvent()` for denied operations
  - Dynamic description builder: lists connected MCP servers with their available tools, resources, and prompts
  - Tool key format matches MCP convention: `sanitizedServer_sanitizedTool`
  - Error messages include available alternatives (available tools for server, available prompts, etc.)
- Created tool description file `skill-mcp.txt` with `{mcp_info}` placeholder for dynamic content
- Registered `SkillMcpTool` in `registry.ts` (always available, not behind experimental flag, like SkillTool)
- 14 unit tests all passing, typecheck passes
- Files changed:
  - `packages/opencode/src/tool/skill-mcp.ts` (new)
  - `packages/opencode/src/tool/skill-mcp.txt` (new)
  - `packages/opencode/src/tool/registry.ts` (modified — registered SkillMcpTool)
  - `packages/opencode/test/tool/skill-mcp.test.ts` (new)
- **Learnings for future iterations:**
  - AI SDK `Tool` type from `dynamicTool()` has `execute` as optional — always check before calling, and cast through `unknown` to call with custom args
  - MCP tool keys use format `sanitizedServer_sanitizedTool` — sanitize with `.replace(/[^a-zA-Z0-9_-]/g, "_")`
  - MCP resources and prompts use key format `sanitizedServer:sanitizedName` (colon separator, not underscore)
  - `MCP.status()` returns configured servers; `MCP.tools()` returns only tools from connected servers — check status before attempting tool calls
  - For mocking the MCP module in tests, mock `../../src/mcp/index` (not `../../src/mcp`) to match the actual import path
  - Don't use `setupSecurityConfig`/`teardownSecurityConfig` helpers when mocking `SecurityConfig` directly — the helpers rely on the real `SecurityConfig.resetConfig()` function
  - `CallToolResult` from MCP has `.content` array with `{ type, text }` entries and optional `.isError` boolean — format accordingly
---

## 2026-02-14 - US-025
- Implemented `interactive_bash` tool for tmux session management in `packages/opencode/src/tool/interactive-bash.ts`
  - `interactive_bash` tool: executes tmux subcommands for session/window/pane management
  - Parameter: `tmux_command` (string) — the tmux subcommand and arguments
  - Blocked subcommands: `send-keys`, `send`, `type`, `paste-buffer` — prevents shell injection bypass
  - Case-insensitive subcommand blocking (lowercased before comparison)
  - File path security scanning: BashScanner + direct extraction of path-like tokens from tmux arguments
  - SecurityAccess.checkAccess(path, 'read', 'agent') for all detected file paths
  - SecurityAudit.logSecurityEvent() for denied operations
  - tmux availability check via `which tmux` before execution
- Gated behind `OPENCODE_EXPERIMENTAL_INTERACTIVE_BASH` flag (or `OPENCODE_EXPERIMENTAL`)
- Created tool description file `interactive-bash.txt`
- Registered in `registry.ts` behind experimental flag
- 11 unit tests all passing, typecheck passes
- Files changed:
  - `packages/opencode/src/tool/interactive-bash.ts` (new)
  - `packages/opencode/src/tool/interactive-bash.txt` (new)
  - `packages/opencode/src/flag/flag.ts` (modified — added OPENCODE_EXPERIMENTAL_INTERACTIVE_BASH)
  - `packages/opencode/src/tool/registry.ts` (modified — registered InteractiveBashTool)
  - `packages/opencode/test/tool/interactive-bash.test.ts` (new)
- **Learnings for future iterations:**
  - BashScanner only detects file paths from known FILE_ACCESS_COMMANDS (cat, grep, find, etc.) as the first token of a pipeline segment — `tmux new-window cat /path` won't detect `/path` via BashScanner because `tmux` is the first token
  - For tools that embed file paths in non-standard command formats (like tmux), supplement BashScanner with direct path extraction from arguments (look for tokens containing `/`)
  - `SecurityAudit.SecurityEvent` interface requires: `{ role, operation, path, allowed, reason? }` — NOT `{ type, tool }` fields
  - Security config schema (`SecuritySchema.SecurityConfig`) has `rules` at top level, NOT nested under `files.rules` — test setup must use `{ version: "1.0", rules: [...] }`
  - `Bun.spawn(["which", "tmux"])` is a reliable cross-platform way to check tool availability
---

## 2026-02-14 - US-026
- Implemented persistent task storage system with file-based storage in `.opencode/tasks/`
  - Created `packages/opencode/src/session/persistent-task.ts` with `PersistentTask` namespace
  - Task CRUD operations: `create`, `get`, `list`, `ready`, `update`, `remove`
  - Task IDs use `T-{uuid}` format via `crypto.randomUUID()`
  - Fields: id, subject, description, status, blockedBy, blocks, owner, metadata, activeForm, createdAt, updatedAt
  - File-level locking via `Lock.read()`/`Lock.write()` for atomic operations
  - Status transitions enforced: pending -> in_progress -> completed/failed/cancelled
  - `ready()` filter: returns pending tasks where all blockedBy dependencies are completed
  - Bus events for task lifecycle: Created, Updated, Deleted
- Created `packages/opencode/src/tool/persistent-task-tool.ts` with `PersistentTaskTool`
  - Tool ID: `persistent_task` — operations: create, get, list, update, delete
  - List supports filters: all, ready, pending, in_progress, completed, failed, cancelled
  - Registered in ToolRegistry (always available, not behind experimental flag)
- Existing TaskTool (agent spawning) completely unchanged and still working
- 23 unit tests all passing, 112 agent tests pass, 148 hook tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/session/persistent-task.ts` (new)
  - `packages/opencode/src/tool/persistent-task-tool.ts` (new)
  - `packages/opencode/src/tool/persistent-task.txt` (new)
  - `packages/opencode/src/tool/registry.ts` (modified — registered PersistentTaskTool)
  - `packages/opencode/test/session/persistent-task.test.ts` (new)
  - `script/ralph/prd.json` (modified — US-026 passes: true)
  - `script/ralph/progress.txt` (modified — appended progress)
- **Learnings for future iterations:**
  - File-based task storage in `.opencode/tasks/` uses `Instance.directory` to locate the project root — tasks are per-project, not global
  - `Lock` namespace provides read/write locks keyed by string — use `lockKey(id)` pattern to namespace lock keys per feature
  - `crypto.randomUUID()` is available globally in Bun runtime — no import needed
  - Status transition enforcement via lookup table: `VALID_TRANSITIONS[currentStatus].includes(newStatus)` prevents invalid state changes
  - The `ready()` filter checks all `blockedBy` IDs against the full task list status map — O(n) for building the map, O(d) per task for dependency check
  - `PersistentTaskTool` is separate from the existing `TaskTool` (agent spawning) — they serve different purposes and coexist
  - `Bun.file().exists()` is async and works well for file existence checks in the task storage layer
  - `fs.readdir()` with `.catch(() => [])` gracefully handles missing task directory on first access
---

## 2026-02-14 - US-027
- Enhanced Skill tool with MCP listing, lazy loading, agent restriction, and `<skill-instruction>` extraction
  - Extended `Skill.Info` schema with optional `mcp` (string[]) and `agent` (string[]) fields parsed from YAML frontmatter
  - MCP capability listing: skills with `mcp` frontmatter field get `<mcp_capabilities>` section in description listing connected MCP server tools/resources/prompts
  - Lazy content loading: skills with content >50KB store empty string on discovery, load full content on first `Skill.get()` call
  - Agent restriction: skills with `agent` frontmatter field (e.g., `agent: [sisyphus]`) only shown to listed agents, checked both in init (description) and execute
  - `<skill-instruction>` XML block extraction: when skill content contains `<skill-instruction>...</skill-instruction>`, only that block is returned on execute
  - PermissionNext filtering preserved (checks run before agent restriction)
- Updated `SkillTool` to use `InitContext.agent` for agent-aware filtering (capturing `agentName` in closure for use in execute)
- Consistent metadata shape across all execute branches (`name`, `dir`, `hasInstruction`, `denied`)
- `buildSkillMcpSections()` reuses same MCP info pattern as `buildMcpInfo()` in skill-mcp.ts
- 14 new unit tests all passing, 27 existing skill tests still pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/skill/skill.ts` (modified — added mcp/agent fields, lazy loading, extractInstruction, isLazy)
  - `packages/opencode/src/tool/skill.ts` (modified — added MCP listing, agent restriction, instruction extraction)
  - `packages/opencode/test/tool/skill-enhanced.test.ts` (new)
- **Learnings for future iterations:**
  - `Tool.Context.agent` is a `string` (agent name), NOT `Agent.Info` — use `InitContext.agent` from the init closure for agent metadata access
  - Tool.define execute return type requires consistent metadata shapes across all branches — include ALL fields with defaults in every branch to avoid union narrowing errors
  - `Skill.Info.pick()` can include optional fields from the schema — they parse as `undefined` when absent from frontmatter, which is fine for optional fields
  - Lazy loading threshold of 50KB is a good default — most skills are <10KB, but some bundled reference materials can be 100KB+
  - `Skill.extractInstruction()` uses simple regex with `[\s\S]*?` (non-greedy) to match content between XML tags — only returns the first match if multiple blocks exist
  - MCP info building for skills reuses the same sanitization pattern as skill-mcp.ts: `name.replace(/[^a-zA-Z0-9_-]/g, "_")` for server names
  - For test mocking of MCP and SecurityConfig modules, use mutable objects (not const) so test can modify state between tests via `resetMcpMocks()`
---

## 2026-02-14 - US-028
- Implemented built-in MCP server integration with auto-enable on API key
  - Created `packages/opencode/src/mcp/builtin.ts` with `BuiltinMcp` namespace
  - 3 built-in MCP servers: websearch (Exa), context7 (documentation), grep_app (GitHub code search)
  - Each server has: name, description, envVar, config factory function
  - `BuiltinMcp.resolve()`: merges built-in configs with user config, respects disabled_mcps and security policy
  - `BuiltinMcp.getDisabledMessage()`: returns clear message with required env var name when agent tries disabled MCP
  - `BuiltinMcp.isBuiltin()` / `BuiltinMcp.getRequiredEnvVar()`: introspection helpers
- Auto-enable logic: API key from explicit param > process.env[envVar] > not enabled
- Built-in configs use `type: "remote"` with `oauth: false` (API key auth via headers)
- User-configured servers always take priority over built-in (spread order: `{ ...builtinConfigs, ...userConfig }`)
- Integration points:
  - `MCP` state initialization: merged built-in configs before creating clients
  - `MCP.status()`: includes built-in servers in status listing
  - `SkillMcpTool`: enhanced "unknown server" error to show built-in MCP hint with required env var
- Added `disabled_mcps` field to `Config.Info` schema (string array, optional)
- SecurityConfig.getMcpPolicy() integration: blocked servers excluded from resolve()
- Enforced servers still returned (monitoring applied downstream)
- 18 unit tests all passing, 134 related tests pass, typecheck passes
- Files changed:
  - `packages/opencode/src/mcp/builtin.ts` (new)
  - `packages/opencode/src/mcp/index.ts` (modified — integrated BuiltinMcp.resolve in state init and status)
  - `packages/opencode/src/config/config.ts` (modified — added disabled_mcps schema field)
  - `packages/opencode/src/tool/skill-mcp.ts` (modified — enhanced unknown server error with built-in hint)
  - `packages/opencode/test/mcp/builtin-mcp.test.ts` (new)
  - `script/ralph/prd.json` (modified — US-028 passes: true)
  - `script/ralph/progress.txt` (modified — appended progress)
- **Learnings for future iterations:**
  - Built-in MCP servers use a factory pattern: `config: (apiKey) => Config.Mcp` — the API key is injected at resolve time, not at definition time
  - `BuiltinMcp.resolve()` takes explicit `apiKeys` param for testing without polluting `process.env`
  - User MCP configs override built-in by being spread second: `{ ...builtinConfigs, ...userConfig }` — user always wins
  - `disabled_mcps` is a simple string array in Config.Info, checked as a Set in resolve() for O(1) lookup
  - The `MCP.status()` function must also call `BuiltinMcp.resolve()` to include built-in servers in the status listing, since state init only runs once
  - Built-in configs use `oauth: false` to disable OAuth auto-detection — these servers use API key auth via headers
  - Mock pattern for SecurityConfig in MCP tests: use mutable `let mockMcpPolicy` variable that test cases reassign before calling resolve()
---

## 2026-02-14 - US-029
- Implemented built-in skills and commands for OpenCode core
  - **Built-in Skills** (2): `git-master` (atomic commit generation, conventional commit enforcement) and `playwright` (browser automation for testing)
    - Stored in `packages/opencode/src/skill/builtin/<name>/SKILL.md` as standard SKILL.md files with YAML frontmatter
    - Both use `<skill-instruction>` blocks for focused content extraction
    - Loaded first in `Skill.state()` before user-defined skills, so user skills override by name
    - Disable via `OPENCODE_DISABLE_BUILTIN_SKILLS` env var (runtime-checked, not module-load-time)
  - **Built-in Commands** (4): `compact` (context summary), `debug` (systematic debugging), `test` (run tests/fix failures), `explain` (code explanation)
    - Stored as `.txt` templates in `packages/opencode/src/command/template/`
    - Imported via Bun text loader alongside existing `init` and `review` templates
    - User config `command` section overrides built-in commands by key name (existing precedence pattern)
  - **User Override**: skills and commands follow the same override pattern — built-ins loaded first, user-defined loaded after and overwrite by name
  - **Skill Permission Filtering**: built-in skills respect PermissionNext rules (same as user skills — no special handling needed)
  - **SecurityAccess**: built-in commands are `source: "command"` (templates processed through same security pipeline as all commands)
- Updated existing `skill.test.ts` to disable built-in skills via env var for isolated testing of user-defined skill discovery
- 11 new unit tests all passing, 52 total skill tests pass, 356 agent/hook/config tests pass
- Typecheck passes
- Files changed:
  - `packages/opencode/src/skill/builtin/git-master/SKILL.md` (new)
  - `packages/opencode/src/skill/builtin/playwright/SKILL.md` (new)
  - `packages/opencode/src/skill/skill.ts` (modified — added built-in skill loading, isBuiltin, builtinDir)
  - `packages/opencode/src/command/index.ts` (modified — added 4 new built-in commands)
  - `packages/opencode/src/command/template/compact.txt` (new)
  - `packages/opencode/src/command/template/debug.txt` (new)
  - `packages/opencode/src/command/template/test.txt` (new)
  - `packages/opencode/src/command/template/explain.txt` (new)
  - `packages/opencode/test/skill/builtin-skills.test.ts` (new)
  - `packages/opencode/test/skill/skill.test.ts` (modified — added OPENCODE_DISABLE_BUILTIN_SKILLS for test isolation)
- **Learnings for future iterations:**
  - Built-in skills use `BUILTIN_DIR = path.resolve(fileURLToPath(import.meta.url), "..", "builtin")` to resolve the built-in directory relative to the source file
  - `process.env.OPENCODE_DISABLE_BUILTIN_SKILLS` is checked at runtime (not module load) since `Skill.state()` is lazy — allows tests to toggle without flag module changes
  - The `addSkill` function's duplicate name warning provides visibility when user skills override built-ins — no separate handling needed
  - Built-in skills are always discoverable regardless of tmpdir path since BUILTIN_DIR resolves from source — existing tests need env var to disable for count assertions
  - Skills with `<skill-instruction>` blocks are ideal for built-ins: the full SKILL.md serves as documentation, while only the instruction block is returned to the agent
  - Command override order: built-in defaults first -> user config commands (overwrite) -> MCP prompts (overwrite) -> skills as commands (skip if exists)
---

## 2026-02-14 - US-030
- Extended opencode.jsonc schema with all OMO config sections
  - **Already implemented in earlier stories**: `agent` (US-009/US-012), `categories` (US-016), `hooks` (US-001), `background_task` (US-015), `disabled_mcps` (US-028)
  - **Added in this story**: `notification` config section with `enabled` (boolean) and `sound` (boolean) fields
  - All config sections are optional with no required fields — backward compatible with empty/existing configs
  - All fields have Zod validation with `.describe()` annotations for schema documentation
  - Config loading precedence preserved (remote -> global -> custom -> project -> .opencode -> inline -> managed)
  - Invalid values produce Zod errors with issue details (path, expected type, received value)
- 10 new unit tests covering all acceptance criteria:
  - Empty config -> all defaults applied
  - Agents section with enabled/model/temperature -> loaded correctly
  - Categories section with custom category -> available
  - Hooks section disable -> hook config stored as `{ enabled: false }`
  - Background task concurrency settings -> all fields enforced
  - Notification settings -> enabled/sound fields stored
  - disabled_mcps -> string array preserved
  - Invalid value -> Zod error with issues
  - Existing valid config -> no errors
  - All OMO sections coexist without conflict
- 106 total config tests pass, typecheck passes
- Files changed:
  - `packages/opencode/src/config/config.ts` (modified — added notification schema)
  - `packages/opencode/test/config/omo-config.test.ts` (new)
- **Learnings for future iterations:**
  - Most OMO config sections were already added incrementally in their respective stories — US-030 primarily validates and tests the complete schema
  - The `notification` config section is the only one that wasn't added in a previous story — the session-notification hook (US-007) used internal `configureNotification()` without a config schema field
  - Config schema uses `.strict()` on the top-level Info object — all new fields must be explicitly added to the schema
  - Agent config's `.catchall(z.any())` transform sweeps unknown fields into `options` — so `enabled`, `prompt_append`, etc. end up in `agent.<name>.options.<field>` after parsing
  - Zod validation errors include issue path and expected/received types — test via `Config.InvalidError.isInstance(err)` and `err.data.issues`
---

## 2026-02-14 - US-031
- Created comprehensive security integration tests in `packages/opencode/test/security/integration/`
  - 5 test files covering all new OMO components:
    - `ast-grep-security.test.ts`: SecurityAccess file protection + SecuritySegments marker protection for ast_grep_search and ast_grep_replace (3 tests)
    - `delegate-task-security.test.ts`: BackgroundManager SecurityConfig sharing — Object.is reference equality, Object.isFrozen immutability, mutation TypeError, rules preservation (4 tests)
    - `interactive-bash-security.test.ts`: BashScanner + SecurityAccess integration for tmux commands with protected file paths (1 test)
    - `context-injection-security.test.ts`: AGENTS.md segment redaction + protected rule file skipping during context injection hooks (2 tests)
    - `output-truncator-security.test.ts`: [REDACTED: Security Protected] marker preservation during output truncation (1 test)
  - look_at and skill_mcp security tests already fully verified in their respective unit test files (test/tool/look-at.test.ts, test/tool/skill-mcp.test.ts) — not duplicated here due to Bun mock.module contamination issues
- All 11 integration tests pass, typecheck passes
- Files changed:
  - `packages/opencode/test/security/integration/ast-grep-security.test.ts` (new)
  - `packages/opencode/test/security/integration/delegate-task-security.test.ts` (new)
  - `packages/opencode/test/security/integration/interactive-bash-security.test.ts` (new)
  - `packages/opencode/test/security/integration/context-injection-security.test.ts` (new)
  - `packages/opencode/test/security/integration/output-truncator-security.test.ts` (new)
  - `script/ralph/prd.json` (modified — US-031 passes: true)
  - `script/ralph/progress.txt` (modified — appended progress)
- **Learnings for future iterations:**
  - Bun's `mock.module()` is process-wide and cannot be scoped to a single test file — mocking `security/config` or `security/audit` in ANY test file contaminates ALL other test files in the same `bun test` run
  - Tests that use the real SecurityConfig/SecurityAudit MUST NOT be run in the same `bun test` invocation as tests that mock these modules
  - The `setupSecurityConfig()`/`teardownSecurityConfig()` helpers from `test/security/access_control_cases/helpers.ts` import SecurityConfig via `@/security/config` path alias — these break when `security/config` is mocked from any other file
  - Solution: use `SecurityConfig.loadSecurityConfig(dir)` and `SecurityConfig.resetConfig()` directly in integration tests instead of using helpers
  - Integration test files should avoid `mock.module` entirely — use real module implementations for end-to-end verification
  - `tmpdir()` fixture already resolves realpath internally (important for macOS `/var/folders` vs `/private/var/folders`)
  - PostToolContext requires `agent` field — always include it in test context objects
---

## 2026-02-14 - US-032
- Implemented OMO upstream diff reporting tool as `script/omo-diff.ts`
  - Fetches latest `oh-my-opencode` from npm registry (`fetchNpmVersion`)
  - Downloads and extracts tarball to temp directory (`downloadAndExtract`)
  - Reads/writes baseline file with defaults for missing fields (`readBaseline`/`writeBaseline`/`parseBaseline`)
  - Scans extracted package directory for tools, hooks, agents, config files, and dependencies (`scanPackage`)
  - Categorizes changes: "backport recommended" (new), "review needed" (internalized modified), "skip (diverged)" (skipped modified)
  - Impact analysis maps each component to affected opencode files via static impact maps
  - Generates structured markdown diff report with summary, per-section tables, and impact analysis
  - Supports `--update-baseline` flag to update baseline version after comparison
  - Exit codes: 0 for success, 1 for error
- Created `.github/workflows/omo-diff.yml` CI workflow
  - Weekly schedule: Monday 09:00 UTC + manual `workflow_dispatch` trigger
  - Steps: checkout -> setup bun -> setup git committer -> run omo-diff.ts -> commit report + open PR if changes
  - Does NOT run on bun install (no postinstall hook)
- 34 unit tests all passing, typecheck passes
- Files changed:
  - `script/omo-diff.ts` (new)
  - `.github/workflows/omo-diff.yml` (new)
  - `packages/opencode/test/script/omo-diff.test.ts` (new)
  - `script/ralph/prd.json` (modified — US-032 passes: true)
  - `script/ralph/progress.txt` (modified — appended progress)
- **Learnings for future iterations:**
  - Scripts in `script/` at repo root cannot import workspace-only dependencies like `zod` — use plain types and manual validation for standalone scripts
  - Test files in `packages/opencode/test/` importing root-level scripts need `../../../../script/` relative path
  - The `parseBaseline()` function replaces Zod schema parsing for baseline validation — manually applies defaults for each field
  - Impact maps (TOOL_IMPACT_MAP, HOOK_IMPACT_MAP, AGENT_IMPACT_MAP) provide static mappings from component names to affected opencode source files
  - CI workflow uses `gh pr create` with heredoc body for markdown formatting
  - `fs.mkdtempSync` + `fs.rmSync` for temp directory lifecycle in tests — cleanup in each test to avoid leaks
---

## 2026-02-14 - US-033
- Created OMO baseline tracking file at `packages/opencode/.omo-baseline.json`
  - Records version (0.0.0 — pre-first-comparison), date, and maps of all internalized components
  - 11 tools (glob, grep, lsp, ast-grep, delegate-task, background-task, look-at, skill-mcp, interactive-bash, task, skill)
  - 26 hooks (all error recovery, output management, context injection, detection, enforcement, lifecycle, LLM parameter hooks)
  - 11 agents (3 internalized: sisyphus, omo-explore, oracle; 8 optional: hephaestus, prometheus, atlas, librarian, metis, momus, multimodal-looker, sisyphus-junior)
- Diff tool (US-032) already reads and updates this file via `readBaseline()` / `writeBaseline()` functions
- 13 new unit tests covering all acceptance criteria:
  - Schema validation: file exists, parses correctly, all status values valid
  - Diff tool reads: readBaseline works on actual file, generateDiff uses baseline for categorization
  - Diff tool updates: writeBaseline updates version, preserves component mappings
  - Missing fields: defaults applied for missing tools/hooks/agents/version
- Typecheck passes, all 47 script tests pass (34 existing + 13 new)
- Files changed:
  - `packages/opencode/.omo-baseline.json` (new)
  - `packages/opencode/test/script/omo-baseline.test.ts` (new)
  - `script/ralph/prd.json` (modified — US-033 passes: true)
  - `script/ralph/progress.txt` (modified — appended progress)
- **Learnings for future iterations:**
  - The baseline file serves as the "ground truth" for which OMO version was internalized — the diff tool compares new OMO releases against it
  - Agent status values differ from tool/hook: agents use "internalized" | "optional" | "skipped" (optional = enabled via config), while tools/hooks use "internalized" | "skipped" | "partial"
  - The `parseBaseline()` function handles all validation since the script can't import Zod (workspace-only dep) — tests validate structure via parseBaseline + manual assertions
  - Baseline version starts at "0.0.0" to indicate no upstream comparison has been done yet — `--update-baseline` flag sets the version to the compared OMO npm version
---

## 2026-02-14 - US-034
- Created 2 new integration test files for end-to-end security verification across all new OMO components:
  - `background-agent-security.test.ts` (2 tests): Verifies background agents receive frozen SecurityConfig with preserved rules, and that mutation attempts throw TypeError (escalation prevention)
  - `security-audit-integration.test.ts` (5 tests): Verifies SecurityAudit log entries are written for denied operations across ast_grep_search, ast_grep_replace, interactive_bash, and multiple simultaneous denials. Validates audit entry schema fields (timestamp, role, operation, path, result)
- All 18 integration tests across 7 files pass (11 existing + 7 new)
- Pre-existing tests (US-031): ast-grep-security (3), delegate-task-security (4), interactive-bash-security (1), context-injection-security (2), output-truncator-security (1)
- look_at and skill_mcp security tests verified in their respective unit test files to avoid Bun mock.module contamination
- Typecheck passes
- Files changed:
  - `packages/opencode/test/security/integration/background-agent-security.test.ts` (new)
  - `packages/opencode/test/security/integration/security-audit-integration.test.ts` (new)
  - `script/ralph/prd.json` (modified — US-034 passes: true)
  - `script/ralph/progress.txt` (modified — appended progress)
- **Learnings for future iterations:**
  - `SecurityAccess.checkAccess()` returns `AccessResult` object `{ allowed: boolean }`, NOT a plain boolean — always access `.allowed` property
  - SecurityAudit log entries are written asynchronously via `fs.appendFile` — tests need a small wait (200ms) before reading the log file
  - Custom audit log path is configured via `.opencode-security.json` `logging` section with all fields required: `{ path, level, maxSizeMB, retentionDays }`
  - Integration tests that verify audit logging should set a custom log path in a temp directory to avoid writing to the project's default `.opencode-security-audit.log`
  - The `readAuditLog()` helper pattern (read file, split lines, JSON.parse each) works reliably for verifying audit entries in integration tests
---
